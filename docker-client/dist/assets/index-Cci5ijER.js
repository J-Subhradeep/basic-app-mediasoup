function es(s,e){for(var t=0;t<e.length;t++){const r=e[t];if(typeof r!="string"&&!Array.isArray(r)){for(const u in r)if(u!=="default"&&!(u in s)){const v=Object.getOwnPropertyDescriptor(r,u);v&&Object.defineProperty(s,u,v.get?v:{enumerable:!0,get:()=>r[u]})}}}return Object.freeze(Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const u of document.querySelectorAll('link[rel="modulepreload"]'))r(u);new MutationObserver(u=>{for(const v of u)if(v.type==="childList")for(const h of v.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&r(h)}).observe(document,{childList:!0,subtree:!0});function t(u){const v={};return u.integrity&&(v.integrity=u.integrity),u.referrerPolicy&&(v.referrerPolicy=u.referrerPolicy),u.crossOrigin==="use-credentials"?v.credentials="include":u.crossOrigin==="anonymous"?v.credentials="omit":v.credentials="same-origin",v}function r(u){if(u.ep)return;u.ep=!0;const v=t(u);fetch(u.href,v)}})();function ts(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var lt={},qe={exports:{}},ut,jt;function rs(){if(jt)return ut;jt=1;var s=1e3,e=s*60,t=e*60,r=t*24,u=r*7,v=r*365.25;ut=function(a,g){g=g||{};var _=typeof a;if(_==="string"&&a.length>0)return h(a);if(_==="number"&&isFinite(a))return g.long?S(a):d(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))};function h(a){if(a=String(a),!(a.length>100)){var g=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(a);if(g){var _=parseFloat(g[1]),k=(g[2]||"ms").toLowerCase();switch(k){case"years":case"year":case"yrs":case"yr":case"y":return _*v;case"weeks":case"week":case"w":return _*u;case"days":case"day":case"d":return _*r;case"hours":case"hour":case"hrs":case"hr":case"h":return _*t;case"minutes":case"minute":case"mins":case"min":case"m":return _*e;case"seconds":case"second":case"secs":case"sec":case"s":return _*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return _;default:return}}}}function d(a){var g=Math.abs(a);return g>=r?Math.round(a/r)+"d":g>=t?Math.round(a/t)+"h":g>=e?Math.round(a/e)+"m":g>=s?Math.round(a/s)+"s":a+"ms"}function S(a){var g=Math.abs(a);return g>=r?E(a,g,r,"day"):g>=t?E(a,g,t,"hour"):g>=e?E(a,g,e,"minute"):g>=s?E(a,g,s,"second"):a+" ms"}function E(a,g,_,k){var R=g>=_*1.5;return Math.round(a/_)+" "+k+(R?"s":"")}return ut}var ht,Bt;function ss(){if(Bt)return ht;Bt=1;function s(e){r.debug=r,r.default=r,r.coerce=E,r.disable=d,r.enable=v,r.enabled=S,r.humanize=rs(),r.destroy=a,Object.keys(e).forEach(g=>{r[g]=e[g]}),r.names=[],r.skips=[],r.formatters={};function t(g){let _=0;for(let k=0;k<g.length;k++)_=(_<<5)-_+g.charCodeAt(k),_|=0;return r.colors[Math.abs(_)%r.colors.length]}r.selectColor=t;function r(g){let _,k=null,R,i;function n(...o){if(!n.enabled)return;const l=n,b=Number(new Date),y=b-(_||b);l.diff=y,l.prev=_,l.curr=b,_=b,o[0]=r.coerce(o[0]),typeof o[0]!="string"&&o.unshift("%O");let w=0;o[0]=o[0].replace(/%([a-zA-Z%])/g,(c,f)=>{if(c==="%%")return"%";w++;const C=r.formatters[f];if(typeof C=="function"){const T=o[w];c=C.call(l,T),o.splice(w,1),w--}return c}),r.formatArgs.call(l,o),(l.log||r.log).apply(l,o)}return n.namespace=g,n.useColors=r.useColors(),n.color=r.selectColor(g),n.extend=u,n.destroy=r.destroy,Object.defineProperty(n,"enabled",{enumerable:!0,configurable:!1,get:()=>k!==null?k:(R!==r.namespaces&&(R=r.namespaces,i=r.enabled(g)),i),set:o=>{k=o}}),typeof r.init=="function"&&r.init(n),n}function u(g,_){const k=r(this.namespace+(typeof _>"u"?":":_)+g);return k.log=this.log,k}function v(g){r.save(g),r.namespaces=g,r.names=[],r.skips=[];const _=(typeof g=="string"?g:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const k of _)k[0]==="-"?r.skips.push(k.slice(1)):r.names.push(k)}function h(g,_){let k=0,R=0,i=-1,n=0;for(;k<g.length;)if(R<_.length&&(_[R]===g[k]||_[R]==="*"))_[R]==="*"?(i=R,n=k,R++):(k++,R++);else if(i!==-1)R=i+1,n++,k=n;else return!1;for(;R<_.length&&_[R]==="*";)R++;return R===_.length}function d(){const g=[...r.names,...r.skips.map(_=>"-"+_)].join(",");return r.enable(""),g}function S(g){for(const _ of r.skips)if(h(g,_))return!1;for(const _ of r.names)if(h(g,_))return!0;return!1}function E(g){return g instanceof Error?g.stack||g.message:g}function a(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return r.enable(r.load()),r}return ht=s,ht}var $t;function at(){return $t||($t=1,(function(s,e){var t={};e.formatArgs=u,e.save=v,e.load=h,e.useColors=r,e.storage=d(),e.destroy=(()=>{let E=!1;return()=>{E||(E=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let E;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(E=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(E[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function u(E){if(E[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+E[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const a="color: "+this.color;E.splice(1,0,a,"color: inherit");let g=0,_=0;E[0].replace(/%[a-zA-Z%]/g,k=>{k!=="%%"&&(g++,k==="%c"&&(_=g))}),E.splice(_,0,a)}e.log=console.debug||console.log||(()=>{});function v(E){try{E?e.storage.setItem("debug",E):e.storage.removeItem("debug")}catch{}}function h(){let E;try{E=e.storage.getItem("debug")||e.storage.getItem("DEBUG")}catch{}return!E&&typeof process<"u"&&"env"in process&&(E=t.DEBUG),E}function d(){try{return localStorage}catch{}}s.exports=ss()(e);const{formatters:S}=s.exports;S.j=function(E){try{return JSON.stringify(E)}catch(a){return"[UnexpectedJSONParseError]: "+a.message}}})(qe,qe.exports)),qe.exports}var ft={},qt;function is(){return qt||(qt=1,Object.defineProperty(ft,"__esModule",{value:!0})),ft}var se={},ue={},zt;function q(){if(zt)return ue;zt=1,Object.defineProperty(ue,"__esModule",{value:!0}),ue.Logger=void 0;const s=at(),e="mediasoup-client";class t{_debug;_warn;_error;constructor(u){u?(this._debug=(0,s.default)(`${e}:${u}`),this._warn=(0,s.default)(`${e}:WARN:${u}`),this._error=(0,s.default)(`${e}:ERROR:${u}`)):(this._debug=(0,s.default)(e),this._warn=(0,s.default)(`${e}:WARN`),this._error=(0,s.default)(`${e}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}}return ue.Logger=t,ue}var he={},ze={exports:{}},Ut;function ns(){if(Ut)return ze.exports;Ut=1;var s=typeof Reflect=="object"?Reflect:null,e=s&&typeof s.apply=="function"?s.apply:function(w,m,c){return Function.prototype.apply.call(w,m,c)},t;s&&typeof s.ownKeys=="function"?t=s.ownKeys:Object.getOwnPropertySymbols?t=function(w){return Object.getOwnPropertyNames(w).concat(Object.getOwnPropertySymbols(w))}:t=function(w){return Object.getOwnPropertyNames(w)};function r(y){console&&console.warn&&console.warn(y)}var u=Number.isNaN||function(w){return w!==w};function v(){v.init.call(this)}ze.exports=v,ze.exports.once=o,v.EventEmitter=v,v.prototype._events=void 0,v.prototype._eventsCount=0,v.prototype._maxListeners=void 0;var h=10;function d(y){if(typeof y!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof y)}Object.defineProperty(v,"defaultMaxListeners",{enumerable:!0,get:function(){return h},set:function(y){if(typeof y!="number"||y<0||u(y))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+y+".");h=y}}),v.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},v.prototype.setMaxListeners=function(w){if(typeof w!="number"||w<0||u(w))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+w+".");return this._maxListeners=w,this};function S(y){return y._maxListeners===void 0?v.defaultMaxListeners:y._maxListeners}v.prototype.getMaxListeners=function(){return S(this)},v.prototype.emit=function(w){for(var m=[],c=1;c<arguments.length;c++)m.push(arguments[c]);var f=w==="error",C=this._events;if(C!==void 0)f=f&&C.error===void 0;else if(!f)return!1;if(f){var T;if(m.length>0&&(T=m[0]),T instanceof Error)throw T;var I=new Error("Unhandled error."+(T?" ("+T.message+")":""));throw I.context=T,I}var M=C[w];if(M===void 0)return!1;if(typeof M=="function")e(M,this,m);else for(var p=M.length,P=R(M,p),c=0;c<p;++c)e(P[c],this,m);return!0};function E(y,w,m,c){var f,C,T;if(d(m),C=y._events,C===void 0?(C=y._events=Object.create(null),y._eventsCount=0):(C.newListener!==void 0&&(y.emit("newListener",w,m.listener?m.listener:m),C=y._events),T=C[w]),T===void 0)T=C[w]=m,++y._eventsCount;else if(typeof T=="function"?T=C[w]=c?[m,T]:[T,m]:c?T.unshift(m):T.push(m),f=S(y),f>0&&T.length>f&&!T.warned){T.warned=!0;var I=new Error("Possible EventEmitter memory leak detected. "+T.length+" "+String(w)+" listeners added. Use emitter.setMaxListeners() to increase limit");I.name="MaxListenersExceededWarning",I.emitter=y,I.type=w,I.count=T.length,r(I)}return y}v.prototype.addListener=function(w,m){return E(this,w,m,!1)},v.prototype.on=v.prototype.addListener,v.prototype.prependListener=function(w,m){return E(this,w,m,!0)};function a(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function g(y,w,m){var c={fired:!1,wrapFn:void 0,target:y,type:w,listener:m},f=a.bind(c);return f.listener=m,c.wrapFn=f,f}v.prototype.once=function(w,m){return d(m),this.on(w,g(this,w,m)),this},v.prototype.prependOnceListener=function(w,m){return d(m),this.prependListener(w,g(this,w,m)),this},v.prototype.removeListener=function(w,m){var c,f,C,T,I;if(d(m),f=this._events,f===void 0)return this;if(c=f[w],c===void 0)return this;if(c===m||c.listener===m)--this._eventsCount===0?this._events=Object.create(null):(delete f[w],f.removeListener&&this.emit("removeListener",w,c.listener||m));else if(typeof c!="function"){for(C=-1,T=c.length-1;T>=0;T--)if(c[T]===m||c[T].listener===m){I=c[T].listener,C=T;break}if(C<0)return this;C===0?c.shift():i(c,C),c.length===1&&(f[w]=c[0]),f.removeListener!==void 0&&this.emit("removeListener",w,I||m)}return this},v.prototype.off=v.prototype.removeListener,v.prototype.removeAllListeners=function(w){var m,c,f;if(c=this._events,c===void 0)return this;if(c.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):c[w]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete c[w]),this;if(arguments.length===0){var C=Object.keys(c),T;for(f=0;f<C.length;++f)T=C[f],T!=="removeListener"&&this.removeAllListeners(T);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(m=c[w],typeof m=="function")this.removeListener(w,m);else if(m!==void 0)for(f=m.length-1;f>=0;f--)this.removeListener(w,m[f]);return this};function _(y,w,m){var c=y._events;if(c===void 0)return[];var f=c[w];return f===void 0?[]:typeof f=="function"?m?[f.listener||f]:[f]:m?n(f):R(f,f.length)}v.prototype.listeners=function(w){return _(this,w,!0)},v.prototype.rawListeners=function(w){return _(this,w,!1)},v.listenerCount=function(y,w){return typeof y.listenerCount=="function"?y.listenerCount(w):k.call(y,w)},v.prototype.listenerCount=k;function k(y){var w=this._events;if(w!==void 0){var m=w[y];if(typeof m=="function")return 1;if(m!==void 0)return m.length}return 0}v.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function R(y,w){for(var m=new Array(w),c=0;c<w;++c)m[c]=y[c];return m}function i(y,w){for(;w+1<y.length;w++)y[w]=y[w+1];y.pop()}function n(y){for(var w=new Array(y.length),m=0;m<w.length;++m)w[m]=y[m].listener||y[m];return w}function o(y,w){return new Promise(function(m,c){function f(T){y.removeListener(w,C),c(T)}function C(){typeof y.removeListener=="function"&&y.removeListener("error",f),m([].slice.call(arguments))}b(y,w,C,{once:!0}),w!=="error"&&l(y,f,{once:!0})})}function l(y,w,m){typeof y.on=="function"&&b(y,"error",w,m)}function b(y,w,m,c){if(typeof y.on=="function")c.once?y.once(w,m):y.on(w,m);else if(typeof y.addEventListener=="function")y.addEventListener(w,function f(C){c.once&&y.removeEventListener(w,f),m(C)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof y)}return ze.exports}var Vt;function z(){if(Vt)return he;Vt=1,Object.defineProperty(he,"__esModule",{value:!0}),he.EnhancedEventEmitter=void 0;const s=ns(),e=q(),t=new e.Logger("EnhancedEventEmitter");class r extends s.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}close(){super.removeAllListeners()}emit(v,...h){return super.emit(v,...h)}safeEmit(v,...h){try{return super.emit(v,...h)}catch(d){t.error("safeEmit() | event listener threw an error [eventName:%s]:%o",v,d);try{super.emit("listenererror",v,d)}catch{}return!!super.listenerCount(v)}}on(v,h){return super.on(v,h),this}off(v,h){return super.off(v,h),this}addListener(v,h){return super.on(v,h),this}prependListener(v,h){return super.prependListener(v,h),this}once(v,h){return super.once(v,h),this}prependOnceListener(v,h){return super.prependOnceListener(v,h),this}removeListener(v,h){return super.off(v,h),this}removeAllListeners(v){return super.removeAllListeners(v),this}listenerCount(v){return super.listenerCount(v)}listeners(v){return super.listeners(v)}rawListeners(v){return super.rawListeners(v)}}return he.EnhancedEventEmitter=r,he}var ie={},Ht;function Q(){if(Ht)return ie;Ht=1,Object.defineProperty(ie,"__esModule",{value:!0}),ie.InvalidStateError=ie.UnsupportedError=void 0;class s extends Error{constructor(r){super(r),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,s):this.stack=new Error(r).stack}}ie.UnsupportedError=s;class e extends Error{constructor(r){super(r),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,e):this.stack=new Error(r).stack}}return ie.InvalidStateError=e,ie}var oe={},Wt;function de(){if(Wt)return oe;Wt=1,Object.defineProperty(oe,"__esModule",{value:!0}),oe.clone=s,oe.generateRandomNumber=e,oe.deepFreeze=t;function s(r){if(r!==void 0)return Number.isNaN(r)?NaN:typeof structuredClone=="function"?structuredClone(r):JSON.parse(JSON.stringify(r))}function e(){return Math.round(Math.random()*1e7)}function t(r){const u=Reflect.ownKeys(r);for(const v of u){const h=r[v];(h&&typeof h=="object"||typeof h=="function")&&t(h)}return Object.freeze(r)}return oe}var $={},B={},fe={},Kt;function as(){if(Kt)return fe;Kt=1,Object.defineProperty(fe,"__esModule",{value:!0}),fe.Logger=void 0;const s=at(),e="h264-profile-level-id";class t{_debug;_warn;_error;constructor(u){u?(this._debug=(0,s.default)(`${e}:${u}`),this._warn=(0,s.default)(`${e}:WARN:${u}`),this._error=(0,s.default)(`${e}:ERROR:${u}`)):(this._debug=(0,s.default)(e),this._warn=(0,s.default)(`${e}:WARN`),this._error=(0,s.default)(`${e}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}}return fe.Logger=t,fe}var Qt;function os(){if(Qt)return B;Qt=1,Object.defineProperty(B,"__esModule",{value:!0}),B.ProfileLevelId=B.Level=B.Profile=void 0,B.parseProfileLevelId=a,B.profileLevelIdToString=g,B.profileToString=_,B.levelToString=k,B.parseSdpProfileLevelId=R,B.isSameProfile=i,B.isSameProfileAndLevel=n,B.generateProfileLevelIdStringForAnswer=o,B.supportedLevel=l;const s=as(),e=new s.Logger;var t;(function(c){c[c.ConstrainedBaseline=1]="ConstrainedBaseline",c[c.Baseline=2]="Baseline",c[c.Main=3]="Main",c[c.ConstrainedHigh=4]="ConstrainedHigh",c[c.High=5]="High",c[c.PredictiveHigh444=6]="PredictiveHigh444"})(t||(B.Profile=t={}));var r;(function(c){c[c.L1_b=0]="L1_b",c[c.L1=10]="L1",c[c.L1_1=11]="L1_1",c[c.L1_2=12]="L1_2",c[c.L1_3=13]="L1_3",c[c.L2=20]="L2",c[c.L2_1=21]="L2_1",c[c.L2_2=22]="L2_2",c[c.L3=30]="L3",c[c.L3_1=31]="L3_1",c[c.L3_2=32]="L3_2",c[c.L4=40]="L4",c[c.L4_1=41]="L4_1",c[c.L4_2=42]="L4_2",c[c.L5=50]="L5",c[c.L5_1=51]="L5_1",c[c.L5_2=52]="L5_2"})(r||(B.Level=r={}));class u{profile;level;constructor(f,C){this.profile=f,this.level=C}}B.ProfileLevelId=u;const v=new u(t.ConstrainedBaseline,r.L3_1);class h{mask;masked_value;constructor(f){this.mask=~b("x",f),this.masked_value=b("1",f)}isMatch(f){return this.masked_value===(f&this.mask)}}class d{profile_idc;profile_iop;profile;constructor(f,C,T){this.profile_idc=f,this.profile_iop=C,this.profile=T}}const S=[new d(66,new h("x1xx0000"),t.ConstrainedBaseline),new d(77,new h("1xxx0000"),t.ConstrainedBaseline),new d(88,new h("11xx0000"),t.ConstrainedBaseline),new d(66,new h("x0xx0000"),t.Baseline),new d(88,new h("10xx0000"),t.Baseline),new d(77,new h("0x0x0000"),t.Main),new d(100,new h("00000000"),t.High),new d(100,new h("00001100"),t.ConstrainedHigh),new d(244,new h("00000000"),t.PredictiveHigh444)],E=[{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:r.L1},{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:r.L1_b},{max_macroblocks_per_second:3e3,max_macroblock_frame_size:396,level:r.L1_1},{max_macroblocks_per_second:6e3,max_macroblock_frame_size:396,level:r.L1_2},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:r.L1_3},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:r.L2},{max_macroblocks_per_second:19800,max_macroblock_frame_size:792,level:r.L2_1},{max_macroblocks_per_second:20250,max_macroblock_frame_size:1620,level:r.L2_2},{max_macroblocks_per_second:40500,max_macroblock_frame_size:1620,level:r.L3},{max_macroblocks_per_second:108e3,max_macroblock_frame_size:3600,level:r.L3_1},{max_macroblocks_per_second:216e3,max_macroblock_frame_size:5120,level:r.L3_2},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:r.L4},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:r.L4_1},{max_macroblocks_per_second:522240,max_macroblock_frame_size:8704,level:r.L4_2},{max_macroblocks_per_second:589824,max_macroblock_frame_size:22080,level:r.L5},{max_macroblocks_per_second:983040,max_macroblock_frame_size:36864,level:r.L5_1},{max_macroblocks_per_second:2073600,max_macroblock_frame_size:36864,level:r.L5_2}];function a(c){if(typeof c!="string"||c.length!==6)return;const C=parseInt(c,16);if(C===0)return;const T=C&255,I=C>>8&255,M=C>>16&255;let p;switch(T){case r.L1_1:{p=(I&16)!==0?r.L1_b:r.L1_1;break}case r.L1:case r.L1_2:case r.L1_3:case r.L2:case r.L2_1:case r.L2_2:case r.L3:case r.L3_1:case r.L3_2:case r.L4:case r.L4_1:case r.L4_2:case r.L5:case r.L5_1:case r.L5_2:{p=T;break}default:{e.warn(`parseProfileLevelId() | unrecognized level_idc [str:${c}, level_idc:${T}]`);return}}for(const P of S)if(M===P.profile_idc&&P.profile_iop.isMatch(I))return e.debug(`parseProfileLevelId() | result [str:${c}, profile:${P.profile}, level:${p}]`),new u(P.profile,p);e.warn(`parseProfileLevelId() | unrecognized profile_idc/profile_iop combination [str:${c}, profile_idc:${M}, profile_iop:${I}]`)}function g(c){if(c.level==r.L1_b)switch(c.profile){case t.ConstrainedBaseline:return"42f00b";case t.Baseline:return"42100b";case t.Main:return"4d100b";default:{e.warn(`profileLevelIdToString() | Level 1_b not is allowed for profile ${c.profile}`);return}}let f;switch(c.profile){case t.ConstrainedBaseline:{f="42e0";break}case t.Baseline:{f="4200";break}case t.Main:{f="4d00";break}case t.ConstrainedHigh:{f="640c";break}case t.High:{f="6400";break}case t.PredictiveHigh444:{f="f400";break}default:{e.warn(`profileLevelIdToString() | unrecognized profile ${c.profile}`);return}}let C=c.level.toString(16);return C.length===1&&(C=`0${C}`),`${f}${C}`}function _(c){switch(c){case t.ConstrainedBaseline:return"ConstrainedBaseline";case t.Baseline:return"Baseline";case t.Main:return"Main";case t.ConstrainedHigh:return"ConstrainedHigh";case t.High:return"High";case t.PredictiveHigh444:return"PredictiveHigh444";default:{e.warn(`profileToString() | unrecognized profile ${c}`);return}}}function k(c){switch(c){case r.L1_b:return"1b";case r.L1:return"1";case r.L1_1:return"1.1";case r.L1_2:return"1.2";case r.L1_3:return"1.3";case r.L2:return"2";case r.L2_1:return"2.1";case r.L2_2:return"2.2";case r.L3:return"3";case r.L3_1:return"3.1";case r.L3_2:return"3.2";case r.L4:return"4";case r.L4_1:return"4.1";case r.L4_2:return"4.2";case r.L5:return"5";case r.L5_1:return"5.1";case r.L5_2:return"5.2";default:{e.warn(`levelToString() | unrecognized level ${c}`);return}}}function R(c={}){const f=c["profile-level-id"];return f?a(f):v}function i(c={},f={}){const C=R(c),T=R(f);return!!(C&&T&&C.profile===T.profile)}function n(c={},f={}){const C=R(c),T=R(f);return!!(C&&T&&C.profile===T.profile&&C.level==T.level)}function o(c={},f={}){if(!c["profile-level-id"]&&!f["profile-level-id"]){e.warn("generateProfileLevelIdStringForAnswer() | profile-level-id missing in local and remote params");return}const C=R(c),T=R(f);if(!C)throw new TypeError("invalid local_profile_level_id");if(!T)throw new TypeError("invalid remote_profile_level_id");if(C.profile!==T.profile)throw new TypeError("H264 Profile mismatch");const I=m(c)&&m(f),M=C.level,p=T.level,P=w(M,p),D=I?M:P;return e.debug(`generateProfileLevelIdStringForAnswer() | result [profile:${C.profile}, level:${D}]`),g(new u(C.profile,D))}function l(c,f){for(let T=E.length-1;T>=0;--T){const I=E[T];if(I.max_macroblock_frame_size*256<=c&&I.max_macroblocks_per_second<=f*I.max_macroblock_frame_size)return e.debug(`supportedLevel() | result [max_frame_pixel_count:${c}, max_fps:${f}, level:${I.level}]`),I.level}e.warn(`supportedLevel() | no level supported [max_frame_pixel_count:${c}, max_fps:${f}]`)}function b(c,f){return+(f[0]===c)<<7|+(f[1]===c)<<6|+(f[2]===c)<<5|+(f[3]===c)<<4|+(f[4]===c)<<3|+(f[5]===c)<<2|+(f[6]===c)<<1|+(f[7]===c)<<0}function y(c,f){return c===r.L1_b?f!==r.L1&&f!==r.L1_b:f===r.L1_b?c!==r.L1:c<f}function w(c,f){return y(c,f)?c:f}function m(c={}){const f=c["level-asymmetry-allowed"];return f===!0||f===1||f==="1"}return B}var Gt;function X(){if(Gt)return $;Gt=1,Object.defineProperty($,"__esModule",{value:!0}),$.validateAndNormalizeRtpCapabilities=v,$.validateAndNormalizeRtpParameters=h,$.validateAndNormalizeSctpStreamParameters=d,$.validateSctpCapabilities=S,$.getExtendedRtpCapabilities=E,$.getRecvRtpCapabilities=a,$.getSendingRtpParameters=g,$.getSendingRemoteRtpParameters=_,$.reduceCodecs=k,$.generateProbatorRtpParameters=R,$.canSend=i,$.canReceive=n;const s=os(),e=de(),t="probator",r=1234,u=127;function v(p){if(typeof p!="object")throw new TypeError("caps is not an object");if(p.codecs&&!Array.isArray(p.codecs))throw new TypeError("caps.codecs is not an array");p.codecs||(p.codecs=[]);for(const P of p.codecs)o(P);if(p.headerExtensions&&!Array.isArray(p.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");p.headerExtensions||(p.headerExtensions=[]);for(const P of p.headerExtensions)b(P)}function h(p){if(typeof p!="object")throw new TypeError("params is not an object");if(p.mid&&typeof p.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(p.codecs))throw new TypeError("missing params.codecs");for(const P of p.codecs)y(P);if(p.headerExtensions&&!Array.isArray(p.headerExtensions))throw new TypeError("params.headerExtensions is not an array");p.headerExtensions||(p.headerExtensions=[]);for(const P of p.headerExtensions)w(P);if(p.encodings&&!Array.isArray(p.encodings))throw new TypeError("params.encodings is not an array");p.encodings||(p.encodings=[]);for(const P of p.encodings)m(P);if(p.rtcp&&typeof p.rtcp!="object")throw new TypeError("params.rtcp is not an object");p.rtcp||(p.rtcp={}),c(p.rtcp)}function d(p){if(typeof p!="object")throw new TypeError("params is not an object");if(typeof p.streamId!="number")throw new TypeError("missing params.streamId");let P=!1;if(typeof p.ordered=="boolean"?P=!0:p.ordered=!0,p.maxPacketLifeTime&&typeof p.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(p.maxRetransmits&&typeof p.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(p.maxPacketLifeTime&&p.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(P&&p.ordered&&(p.maxPacketLifeTime||p.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!P&&(p.maxPacketLifeTime||p.maxRetransmits)&&(p.ordered=!1),p.label&&typeof p.label!="string")throw new TypeError("invalid params.label");if(p.protocol&&typeof p.protocol!="string")throw new TypeError("invalid params.protocol")}function S(p){if(typeof p!="object")throw new TypeError("caps is not an object");if(!p.numStreams||typeof p.numStreams!="object")throw new TypeError("missing caps.numStreams");f(p.numStreams)}function E(p,P,D){const x={codecs:[],headerExtensions:[]};if(D)for(const L of p.codecs??[]){if(C(L))continue;const O=(P.codecs??[]).find(N=>T(N,L,{strict:!0,modify:!0}));if(!O)continue;const A={kind:L.kind,mimeType:L.mimeType,clockRate:L.clockRate,channels:L.channels,localPayloadType:L.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:O.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:L.parameters??{},remoteParameters:O.parameters??{},rtcpFeedback:M(L,O)};x.codecs.push(A)}else for(const L of P.codecs??[]){if(C(L))continue;const O=(p.codecs??[]).find(N=>T(N,L,{strict:!0,modify:!0}));if(!O)continue;const A={kind:O.kind,mimeType:O.mimeType,clockRate:O.clockRate,channels:O.channels,localPayloadType:O.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:L.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:O.parameters??{},remoteParameters:L.parameters??{},rtcpFeedback:M(O,L)};x.codecs.push(A)}for(const L of x.codecs){const O=p.codecs.find(N=>C(N)&&N.parameters?.apt===L.localPayloadType),A=P.codecs.find(N=>C(N)&&N.parameters?.apt===L.remotePayloadType);O&&A&&(L.localRtxPayloadType=O.preferredPayloadType,L.remoteRtxPayloadType=A.preferredPayloadType)}for(const L of P.headerExtensions){const O=p.headerExtensions.find(N=>I(N,L));if(!O)continue;const A={kind:L.kind,uri:L.uri,sendId:O.preferredId,recvId:L.preferredId,encrypt:O.preferredEncrypt??!1,direction:"sendrecv"};switch(L.direction){case"sendrecv":{A.direction="sendrecv";break}case"recvonly":{A.direction="sendonly";break}case"sendonly":{A.direction="recvonly";break}case"inactive":{A.direction="inactive";break}}x.headerExtensions.push(A)}return x}function a(p){const P={codecs:[],headerExtensions:[]};for(const D of p.codecs){const x={kind:D.kind,mimeType:D.mimeType,preferredPayloadType:D.remotePayloadType,clockRate:D.clockRate,channels:D.channels,parameters:D.localParameters,rtcpFeedback:D.rtcpFeedback};if(P.codecs.push(x),!D.remoteRtxPayloadType)continue;const L={kind:D.kind,mimeType:`${D.kind}/rtx`,preferredPayloadType:D.remoteRtxPayloadType,clockRate:D.clockRate,parameters:{apt:D.remotePayloadType},rtcpFeedback:[]};P.codecs.push(L)}for(const D of p.headerExtensions){if(D.direction!=="sendrecv"&&D.direction!=="recvonly")continue;const x={kind:D.kind,uri:D.uri,preferredId:D.recvId,preferredEncrypt:D.encrypt??!1,direction:D.direction};P.headerExtensions.push(x)}return P}function g(p,P){const D={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const x of P.codecs){if(x.kind!==p)continue;const L={mimeType:x.mimeType,payloadType:x.localPayloadType,clockRate:x.clockRate,channels:x.channels,parameters:x.localParameters,rtcpFeedback:x.rtcpFeedback};if(D.codecs.push(L),x.localRtxPayloadType){const O={mimeType:`${x.kind}/rtx`,payloadType:x.localRtxPayloadType,clockRate:x.clockRate,parameters:{apt:x.localPayloadType},rtcpFeedback:[]};D.codecs.push(O)}}for(const x of P.headerExtensions){if(x.kind&&x.kind!==p||x.direction!=="sendrecv"&&x.direction!=="sendonly")continue;const L={uri:x.uri,id:x.sendId,encrypt:x.encrypt,parameters:{}};D.headerExtensions.push(L)}return D}function _(p,P){const D={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const x of P.codecs){if(x.kind!==p)continue;const L={mimeType:x.mimeType,payloadType:x.localPayloadType,clockRate:x.clockRate,channels:x.channels,parameters:x.remoteParameters,rtcpFeedback:x.rtcpFeedback};if(D.codecs.push(L),x.localRtxPayloadType){const O={mimeType:`${x.kind}/rtx`,payloadType:x.localRtxPayloadType,clockRate:x.clockRate,parameters:{apt:x.localPayloadType},rtcpFeedback:[]};D.codecs.push(O)}}for(const x of P.headerExtensions){if(x.kind&&x.kind!==p||x.direction!=="sendrecv"&&x.direction!=="sendonly")continue;const L={uri:x.uri,id:x.sendId,encrypt:x.encrypt,parameters:{}};D.headerExtensions.push(L)}if(D.headerExtensions.some(x=>x.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(const x of D.codecs)x.rtcpFeedback=(x.rtcpFeedback??[]).filter(L=>L.type!=="goog-remb");else if(D.headerExtensions.some(x=>x.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(const x of D.codecs)x.rtcpFeedback=(x.rtcpFeedback??[]).filter(L=>L.type!=="transport-cc");else for(const x of D.codecs)x.rtcpFeedback=(x.rtcpFeedback??[]).filter(L=>L.type!=="transport-cc"&&L.type!=="goog-remb");return D}function k(p,P){const D=[];if(!P)D.push(p[0]),C(p[1])&&D.push(p[1]);else{for(let x=0;x<p.length;++x)if(T(p[x],P,{strict:!0})){D.push(p[x]),C(p[x+1])&&D.push(p[x+1]);break}if(D.length===0)throw new TypeError("no matching codec found")}return D}function R(p){p=e.clone(p),h(p);const P={mid:t,codecs:[],headerExtensions:[],encodings:[{ssrc:r}],rtcp:{cname:"probator"}};return P.codecs.push(p.codecs[0]),P.codecs[0].payloadType=u,P.headerExtensions=p.headerExtensions,P}function i(p,P){return(P.codecs??[]).some(D=>D.kind===p)}function n(p,P){if(h(p),p.codecs.length===0)return!1;const D=p.codecs[0];return(P.codecs??[]).some(x=>x.preferredPayloadType===D.payloadType)}function o(p){const P=new RegExp("^(audio|video)/(.+)","i");if(typeof p!="object")throw new TypeError("codec is not an object");if(!p.mimeType||typeof p.mimeType!="string")throw new TypeError("missing codec.mimeType");const D=P.exec(p.mimeType);if(!D)throw new TypeError("invalid codec.mimeType");if(p.kind=D[1].toLowerCase(),typeof p.preferredPayloadType!="number")throw new TypeError("missing codec.preferredPayloadType");if(typeof p.clockRate!="number")throw new TypeError("missing codec.clockRate");p.kind==="audio"?typeof p.channels!="number"&&(p.channels=1):delete p.channels,(!p.parameters||typeof p.parameters!="object")&&(p.parameters={});for(const x of Object.keys(p.parameters)){let L=p.parameters[x];if(L===void 0&&(p.parameters[x]="",L=""),typeof L!="string"&&typeof L!="number")throw new TypeError(`invalid codec parameter [key:${x}s, value:${L}]`);if(x==="apt"&&typeof L!="number")throw new TypeError("invalid codec apt parameter")}(!p.rtcpFeedback||!Array.isArray(p.rtcpFeedback))&&(p.rtcpFeedback=[]);for(const x of p.rtcpFeedback)l(x)}function l(p){if(typeof p!="object")throw new TypeError("fb is not an object");if(!p.type||typeof p.type!="string")throw new TypeError("missing fb.type");(!p.parameter||typeof p.parameter!="string")&&(p.parameter="")}function b(p){if(typeof p!="object")throw new TypeError("ext is not an object");if(p.kind!=="audio"&&p.kind!=="video")throw new TypeError("invalid ext.kind");if(!p.uri||typeof p.uri!="string")throw new TypeError("missing ext.uri");if(typeof p.preferredId!="number")throw new TypeError("missing ext.preferredId");if(p.preferredEncrypt&&typeof p.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(p.preferredEncrypt||(p.preferredEncrypt=!1),p.direction&&typeof p.direction!="string")throw new TypeError("invalid ext.direction");p.direction||(p.direction="sendrecv")}function y(p){const P=new RegExp("^(audio|video)/(.+)","i");if(typeof p!="object")throw new TypeError("codec is not an object");if(!p.mimeType||typeof p.mimeType!="string")throw new TypeError("missing codec.mimeType");const D=P.exec(p.mimeType);if(!D)throw new TypeError("invalid codec.mimeType");if(typeof p.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof p.clockRate!="number")throw new TypeError("missing codec.clockRate");D[1].toLowerCase()==="audio"?typeof p.channels!="number"&&(p.channels=1):delete p.channels,(!p.parameters||typeof p.parameters!="object")&&(p.parameters={});for(const L of Object.keys(p.parameters)){let O=p.parameters[L];if(O===void 0&&(p.parameters[L]="",O=""),typeof O!="string"&&typeof O!="number")throw new TypeError(`invalid codec parameter [key:${L}s, value:${O}]`);if(L==="apt"&&typeof O!="number")throw new TypeError("invalid codec apt parameter")}(!p.rtcpFeedback||!Array.isArray(p.rtcpFeedback))&&(p.rtcpFeedback=[]);for(const L of p.rtcpFeedback)l(L)}function w(p){if(typeof p!="object")throw new TypeError("ext is not an object");if(!p.uri||typeof p.uri!="string")throw new TypeError("missing ext.uri");if(typeof p.id!="number")throw new TypeError("missing ext.id");if(p.encrypt&&typeof p.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");p.encrypt||(p.encrypt=!1),(!p.parameters||typeof p.parameters!="object")&&(p.parameters={});for(const P of Object.keys(p.parameters)){let D=p.parameters[P];if(D===void 0&&(p.parameters[P]="",D=""),typeof D!="string"&&typeof D!="number")throw new TypeError("invalid header extension parameter")}}function m(p){if(typeof p!="object")throw new TypeError("encoding is not an object");if(p.ssrc&&typeof p.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(p.rid&&typeof p.rid!="string")throw new TypeError("invalid encoding.rid");if(p.rtx&&typeof p.rtx!="object")throw new TypeError("invalid encoding.rtx");if(p.rtx&&typeof p.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!p.dtx||typeof p.dtx!="boolean")&&(p.dtx=!1),p.scalabilityMode&&typeof p.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}function c(p){if(typeof p!="object")throw new TypeError("rtcp is not an object");if(p.cname&&typeof p.cname!="string")throw new TypeError("invalid rtcp.cname");(!p.reducedSize||typeof p.reducedSize!="boolean")&&(p.reducedSize=!0)}function f(p){if(typeof p!="object")throw new TypeError("numStreams is not an object");if(typeof p.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof p.MIS!="number")throw new TypeError("missing numStreams.MIS")}function C(p){return p?/.+\/rtx$/i.test(p.mimeType):!1}function T(p,P,{strict:D=!1,modify:x=!1}={}){const L=p.mimeType.toLowerCase(),O=P.mimeType.toLowerCase();if(L!==O||p.clockRate!==P.clockRate||p.channels!==P.channels)return!1;switch(L){case"video/h264":{if(D){const A=p.parameters["packetization-mode"]??0,N=P.parameters["packetization-mode"]??0;if(A!==N||!s.isSameProfile(p.parameters,P.parameters))return!1;let ae;try{ae=s.generateProfileLevelIdStringForAnswer(p.parameters,P.parameters)}catch{return!1}x&&(ae?(p.parameters["profile-level-id"]=ae,P.parameters["profile-level-id"]=ae):(delete p.parameters["profile-level-id"],delete P.parameters["profile-level-id"]))}break}case"video/vp9":{if(D){const A=p.parameters["profile-id"]??0,N=P.parameters["profile-id"]??0;if(A!==N)return!1}break}}return!0}function I(p,P){return!(p.kind&&P.kind&&p.kind!==P.kind||p.uri!==P.uri)}function M(p,P){const D=[];for(const x of p.rtcpFeedback??[]){const L=(P.rtcpFeedback??[]).find(O=>O.type===x.type&&(O.parameter===x.parameter||!O.parameter&&!x.parameter));L&&D.push(L)}return D}return $}var me={},mt={},ge={},_e={},Yt;function cs(){if(Yt)return _e;Yt=1,Object.defineProperty(_e,"__esModule",{value:!0}),_e.Logger=void 0;const s=at(),e="awaitqueue";let t=class{_debug;_warn;_error;constructor(u){u?(this._debug=s(`${e}:${u}`),this._warn=s(`${e}:WARN:${u}`),this._error=s(`${e}:ERROR:${u}`)):(this._debug=s(e),this._warn=s(`${e}:WARN`),this._error=s(`${e}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};return _e.Logger=t,_e}var ne={},Jt;function Nr(){if(Jt)return ne;Jt=1,Object.defineProperty(ne,"__esModule",{value:!0}),ne.AwaitQueueRemovedTaskError=ne.AwaitQueueStoppedError=void 0;class s extends Error{constructor(r){super(r??"queue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,s)}}ne.AwaitQueueStoppedError=s;class e extends Error{constructor(r){super(r??"queue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,e)}}return ne.AwaitQueueRemovedTaskError=e,ne}var Xt;function ds(){if(Xt)return ge;Xt=1,Object.defineProperty(ge,"__esModule",{value:!0}),ge.AwaitQueue=void 0;const s=cs(),e=Nr(),t=new s.Logger("AwaitQueue");let r=class{pendingTasks=new Map;nextTaskId=0;constructor(){t.debug("constructor()")}get size(){return this.pendingTasks.size}async push(v,h,d){if(h=h??v.name,t.debug(`push() [name:${h}, options:%o]`,d),typeof v!="function")throw new TypeError("given task is not a function");if(h)try{Object.defineProperty(v,"name",{value:h})}catch{}return new Promise((S,E)=>{if(h&&d?.removeOngoingTasksWithSameName)for(const g of this.pendingTasks.values())g.name===h&&g.reject(new e.AwaitQueueRemovedTaskError,{canExecuteNextTask:!1});const a={id:this.nextTaskId++,task:v,name:h,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:g=>{if(a.completed)return;a.completed=!0,this.pendingTasks.delete(a.id),t.debug(`resolving task [name:${a.name}]`),S(g);const[_]=this.pendingTasks.values();_&&!_.executedAt&&this.execute(_)},reject:(g,{canExecuteNextTask:_})=>{if(!a.completed&&(a.completed=!0,this.pendingTasks.delete(a.id),t.debug(`rejecting task [name:${a.name}]: %s`,String(g)),E(g),_)){const[k]=this.pendingTasks.values();k&&!k.executedAt&&this.execute(k)}}};this.pendingTasks.set(a.id,a),this.pendingTasks.size===1&&this.execute(a)})}stop(){t.debug("stop()");for(const v of this.pendingTasks.values())t.debug(`stop() | stopping task [name:${v.name}]`),v.reject(new e.AwaitQueueStoppedError,{canExecuteNextTask:!1})}remove(v){t.debug(`remove() [taskIdx:${v}]`);const h=Array.from(this.pendingTasks.values())[v];if(!h){t.debug(`stop() | no task with given idx [taskIdx:${v}]`);return}h.reject(new e.AwaitQueueRemovedTaskError,{canExecuteNextTask:!0})}dump(){const v=Date.now();let h=0;return Array.from(this.pendingTasks.values()).map(d=>({idx:h++,task:d.task,name:d.name,enqueuedTime:d.executedAt?d.executedAt-d.enqueuedAt:v-d.enqueuedAt,executionTime:d.executedAt?v-d.executedAt:0}))}async execute(v){if(t.debug(`execute() [name:${v.name}]`),v.executedAt)throw new Error("task already being executed");v.executedAt=Date.now();try{const h=await v.task();v.resolve(h)}catch(h){v.reject(h,{canExecuteNextTask:!0})}}};return ge.AwaitQueue=r,ge}var Zt;function ps(){return Zt||(Zt=1,(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.AwaitQueueRemovedTaskError=s.AwaitQueueStoppedError=s.AwaitQueue=void 0;var e=ds();Object.defineProperty(s,"AwaitQueue",{enumerable:!0,get:function(){return e.AwaitQueue}});var t=Nr();Object.defineProperty(s,"AwaitQueueStoppedError",{enumerable:!0,get:function(){return t.AwaitQueueStoppedError}}),Object.defineProperty(s,"AwaitQueueRemovedTaskError",{enumerable:!0,get:function(){return t.AwaitQueueRemovedTaskError}})})(mt)),mt}var ve={},er;function ls(){if(er)return ve;er=1,Object.defineProperty(ve,"__esModule",{value:!0}),ve.Producer=void 0;const s=q(),e=z(),t=Q(),r=new s.Logger("Producer");let u=class extends e.EnhancedEventEmitter{_id;_localId;_closed=!1;_rtpSender;_track;_kind;_rtpParameters;_paused;_maxSpatialLayer;_stopTracks;_disableTrackOnPause;_zeroRtpOnPause;_appData;_observer=new e.EnhancedEventEmitter;constructor({id:h,localId:d,rtpSender:S,track:E,rtpParameters:a,stopTracks:g,disableTrackOnPause:_,zeroRtpOnPause:k,appData:R}){super(),r.debug("constructor()"),this._id=h,this._localId=d,this._rtpSender=S,this._track=E,this._kind=E.kind,this._rtpParameters=a,this._paused=_?!E.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=g,this._disableTrackOnPause=_,this._zeroRtpOnPause=k,this._appData=R??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(h){this._appData=h}get observer(){return this._observer}close(){this._closed||(r.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(r.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new t.InvalidStateError("closed");return new Promise((h,d)=>{this.safeEmit("@getstats",h,d)})}pause(){if(r.debug("pause()"),this._closed){r.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((h,d)=>{this.safeEmit("@pause",h,d)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(r.debug("resume()"),this._closed){r.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((h,d)=>{this.safeEmit("@resume",h,d)}).catch(()=>{}),this._observer.safeEmit("resume")}async replaceTrack({track:h}){if(r.debug("replaceTrack() [track:%o]",h),this._closed){if(h&&this._stopTracks)try{h.stop()}catch{}throw new t.InvalidStateError("closed")}else if(h?.readyState==="ended")throw new t.InvalidStateError("track ended");if(h===this._track){r.debug("replaceTrack() | same track, ignored");return}await new Promise((d,S)=>{this.safeEmit("@replacetrack",h,d,S)}),this.destroyTrack(),this._track=h,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this.handleTrack()}async setMaxSpatialLayer(h){if(this._closed)throw new t.InvalidStateError("closed");if(this._kind!=="video")throw new t.UnsupportedError("not a video Producer");if(typeof h!="number")throw new TypeError("invalid spatialLayer");h!==this._maxSpatialLayer&&(await new Promise((d,S)=>{this.safeEmit("@setmaxspatiallayer",h,d,S)}).catch(()=>{}),this._maxSpatialLayer=h)}async setRtpEncodingParameters(h){if(this._closed)throw new t.InvalidStateError("closed");if(typeof h!="object")throw new TypeError("invalid params");await new Promise((d,S)=>{this.safeEmit("@setrtpencodingparameters",h,d,S)})}onTrackEnded(){r.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track&&this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this.onTrackEnded),this._stopTracks&&this._track.stop()}catch{}}};return ve.Producer=u,ve}var ye={},tr;function us(){if(tr)return ye;tr=1,Object.defineProperty(ye,"__esModule",{value:!0}),ye.Consumer=void 0;const s=q(),e=z(),t=Q(),r=new s.Logger("Consumer");let u=class extends e.EnhancedEventEmitter{_id;_localId;_producerId;_closed=!1;_rtpReceiver;_track;_rtpParameters;_paused;_appData;_observer=new e.EnhancedEventEmitter;constructor({id:h,localId:d,producerId:S,rtpReceiver:E,track:a,rtpParameters:g,appData:_}){super(),r.debug("constructor()"),this._id=h,this._localId=d,this._producerId=S,this._rtpReceiver=E,this._track=a,this._rtpParameters=g,this._paused=!a.enabled,this._appData=_??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(h){this._appData=h}get observer(){return this._observer}close(){this._closed||(r.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(r.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new t.InvalidStateError("closed");return new Promise((h,d)=>{this.safeEmit("@getstats",h,d)})}pause(){if(r.debug("pause()"),this._closed){r.error("pause() | Consumer closed");return}if(this._paused){r.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(r.debug("resume()"),this._closed){r.error("resume() | Consumer closed");return}if(!this._paused){r.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}onTrackEnded(){r.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){try{this._track.removeEventListener("ended",this.onTrackEnded),this._track.stop()}catch{}}};return ye.Consumer=u,ye}var we={},rr;function hs(){if(rr)return we;rr=1,Object.defineProperty(we,"__esModule",{value:!0}),we.DataProducer=void 0;const s=q(),e=z(),t=Q(),r=new s.Logger("DataProducer");let u=class extends e.EnhancedEventEmitter{_id;_dataChannel;_closed=!1;_sctpStreamParameters;_appData;_observer=new e.EnhancedEventEmitter;constructor({id:h,dataChannel:d,sctpStreamParameters:S,appData:E}){super(),r.debug("constructor()"),this._id=h,this._dataChannel=d,this._sctpStreamParameters=S,this._appData=E??{},this.handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(h){this._dataChannel.bufferedAmountLowThreshold=h}get appData(){return this._appData}set appData(h){this._appData=h}get observer(){return this._observer}close(){this._closed||(r.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(r.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(h){if(r.debug("send()"),this._closed)throw new t.InvalidStateError("closed");this._dataChannel.send(h)}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(r.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",h=>{if(this._closed)return;const d=h.error??new Error("unknown DataChannel error");h.error?.errorDetail==="sctp-failure"?r.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",h.error?.sctpCauseCode,h.error.message):r.error('DataChannel "error" event: %o',d),this.safeEmit("error",d)}),this._dataChannel.addEventListener("close",()=>{this._closed||(r.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||r.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}};return we.DataProducer=u,we}var be={},sr;function fs(){if(sr)return be;sr=1,Object.defineProperty(be,"__esModule",{value:!0}),be.DataConsumer=void 0;const s=q(),e=z(),t=new s.Logger("DataConsumer");let r=class extends e.EnhancedEventEmitter{_id;_dataProducerId;_dataChannel;_closed=!1;_sctpStreamParameters;_appData;_observer=new e.EnhancedEventEmitter;constructor({id:v,dataProducerId:h,dataChannel:d,sctpStreamParameters:S,appData:E}){super(),t.debug("constructor()"),this._id=v,this._dataProducerId=h,this._dataChannel=d,this._sctpStreamParameters=S,this._appData=E??{},this.handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(v){this._dataChannel.binaryType=v}get appData(){return this._appData}set appData(v){this._appData=v}get observer(){return this._observer}close(){this._closed||(t.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(t.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(t.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",v=>{if(this._closed)return;const h=v.error??new Error("unknown DataChannel error");v.error?.errorDetail==="sctp-failure"?t.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",v.error?.sctpCauseCode,v.error.message):t.error('DataChannel "error" event: %o',h),this.safeEmit("error",h)}),this._dataChannel.addEventListener("close",()=>{this._closed||(t.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",v=>{this._closed||this.safeEmit("message",v.data)})}};return be.DataConsumer=r,be}var ir;function ms(){if(ir)return me;ir=1,Object.defineProperty(me,"__esModule",{value:!0}),me.Transport=void 0;const s=ps(),e=q(),t=z(),r=Q(),u=de(),v=X(),h=ls(),d=us(),S=hs(),E=fs(),a=new e.Logger("Transport");class g{consumerOptions;promise;resolve;reject;constructor(R){this.consumerOptions=R,this.promise=new Promise((i,n)=>{this.resolve=i,this.reject=n})}}class _ extends t.EnhancedEventEmitter{_id;_closed=!1;_direction;_getSendExtendedRtpCapabilities;_recvRtpCapabilities;_canProduceByKind;_maxSctpMessageSize;_handler;_iceGatheringState="new";_connectionState="new";_appData;_producers=new Map;_consumers=new Map;_dataProducers=new Map;_dataConsumers=new Map;_probatorConsumerCreated=!1;_awaitQueue=new s.AwaitQueue;_pendingConsumerTasks=[];_consumerCreationInProgress=!1;_pendingPauseConsumers=new Map;_consumerPauseInProgress=!1;_pendingResumeConsumers=new Map;_consumerResumeInProgress=!1;_pendingCloseConsumers=new Map;_consumerCloseInProgress=!1;_observer=new t.EnhancedEventEmitter;constructor({direction:R,id:i,iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b,iceServers:y,iceTransportPolicy:w,additionalSettings:m,appData:c,handlerFactory:f,getSendExtendedRtpCapabilities:C,recvRtpCapabilities:T,canProduceByKind:I}){super(),a.debug("constructor() [id:%s, direction:%s]",i,R),this._id=i,this._direction=R,this._getSendExtendedRtpCapabilities=C,this._recvRtpCapabilities=T,this._canProduceByKind=I,this._maxSctpMessageSize=b?b.maxMessageSize:null;const M=u.clone(m)??{};delete M.iceServers,delete M.iceTransportPolicy,delete M.bundlePolicy,delete M.rtcpMuxPolicy,this._handler=f.factory({direction:R,iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b,iceServers:y,iceTransportPolicy:w,additionalSettings:M,getSendExtendedRtpCapabilities:this._getSendExtendedRtpCapabilities}),this._appData=c??{},this.handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get iceGatheringState(){return this._iceGatheringState}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(R){this._appData=R}get observer(){return this._observer}close(){if(!this._closed){a.debug("close()"),this._closed=!0,this._awaitQueue.stop(),this._handler.close(),this._connectionState="closed";for(const R of this._producers.values())R.transportClosed();this._producers.clear();for(const R of this._consumers.values())R.transportClosed();this._consumers.clear();for(const R of this._dataProducers.values())R.transportClosed();this._dataProducers.clear();for(const R of this._dataConsumers.values())R.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close"),super.close(),this._observer.close()}}async getStats(){if(this._closed)throw new r.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:R}){if(a.debug("restartIce()"),this._closed)throw new r.InvalidStateError("closed");if(!R)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>await this._handler.restartIce(R),"transport.restartIce()")}async updateIceServers({iceServers:R}={}){if(a.debug("updateIceServers()"),this._closed)throw new r.InvalidStateError("closed");if(!Array.isArray(R))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(R),"transport.updateIceServers()")}async produce({track:R,streamId:i,encodings:n,codecOptions:o,headerExtensionOptions:l,codec:b,stopTracks:y=!0,disableTrackOnPause:w=!0,zeroRtpOnPause:m=!1,onRtpSender:c,appData:f={}}={}){if(a.debug("produce() [track:%o]",R),this._closed)throw new r.InvalidStateError("closed");if(R){if(this._direction!=="send")throw new r.UnsupportedError("not a sending Transport");if(this._canProduceByKind[R.kind]){if(R.readyState==="ended")throw new r.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(f&&typeof f!="object")throw new TypeError("if given, appData must be an object")}else throw new r.UnsupportedError(`cannot produce ${R.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(async()=>{let C;if(n&&!Array.isArray(n))throw TypeError("encodings must be an array");n?.length===0?C=void 0:n&&(C=n.map(p=>{const P={active:!0};return p.active===!1&&(P.active=!1),typeof p.dtx=="boolean"&&(P.dtx=p.dtx),typeof p.scalabilityMode=="string"&&(P.scalabilityMode=p.scalabilityMode),typeof p.scaleResolutionDownBy=="number"&&(P.scaleResolutionDownBy=p.scaleResolutionDownBy),typeof p.maxBitrate=="number"&&(P.maxBitrate=p.maxBitrate),typeof p.maxFramerate=="number"&&(P.maxFramerate=p.maxFramerate),typeof p.adaptivePtime=="boolean"&&(P.adaptivePtime=p.adaptivePtime),typeof p.priority=="string"&&(P.priority=p.priority),typeof p.networkPriority=="string"&&(P.networkPriority=p.networkPriority),P}));const{localId:T,rtpParameters:I,rtpSender:M}=await this._handler.send({track:R,streamId:i,encodings:C,codecOptions:o,headerExtensionOptions:l,codec:b,onRtpSender:c});try{v.validateAndNormalizeRtpParameters(I);const{id:p}=await new Promise((D,x)=>{this.safeEmit("produce",{kind:R.kind,rtpParameters:I,appData:f},D,x)}),P=new h.Producer({id:p,localId:T,rtpSender:M,track:R,rtpParameters:I,stopTracks:y,disableTrackOnPause:w,zeroRtpOnPause:m,appData:f});return this._producers.set(P.id,P),this.handleProducer(P),this._observer.safeEmit("newproducer",P),P}catch(p){throw this._handler.stopSending(T).catch(()=>{}),p}},"transport.produce()").catch(C=>{if(y)try{R.stop()}catch{}throw C})}async consume({id:R,producerId:i,kind:n,rtpParameters:o,streamId:l,onRtpReceiver:b,appData:y={}}){if(a.debug("consume()"),this._closed)throw new r.InvalidStateError("closed");if(this._direction!=="recv")throw new r.UnsupportedError("not a receiving Transport");if(typeof R!="string")throw new TypeError("missing id");if(typeof i!="string")throw new TypeError("missing producerId");if(n!=="audio"&&n!=="video")throw new TypeError(`invalid kind '${n}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(y&&typeof y!="object")throw new TypeError("if given, appData must be an object");const w=u.clone(o);if(!v.canReceive(w,this._recvRtpCapabilities))throw new r.UnsupportedError("cannot consume this Producer");const c=new g({id:R,producerId:i,kind:n,rtpParameters:w,streamId:l,onRtpReceiver:b,appData:y});return this._pendingConsumerTasks.push(c),queueMicrotask(()=>{this._closed||this._consumerCreationInProgress===!1&&this.createPendingConsumers()}),c.promise}async produceData({ordered:R=!0,maxPacketLifeTime:i,maxRetransmits:n,label:o="",protocol:l="",appData:b={}}={}){if(a.debug("produceData()"),this._closed)throw new r.InvalidStateError("closed");if(this._direction!=="send")throw new r.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(b&&typeof b!="object")throw new TypeError("if given, appData must be an object")}else throw new r.UnsupportedError("SCTP not enabled by remote Transport");return(i||n)&&(R=!1),this._awaitQueue.push(async()=>{const{dataChannel:y,sctpStreamParameters:w}=await this._handler.sendDataChannel({ordered:R,maxPacketLifeTime:i,maxRetransmits:n,label:o,protocol:l});v.validateAndNormalizeSctpStreamParameters(w);const{id:m}=await new Promise((f,C)=>{this.safeEmit("producedata",{sctpStreamParameters:w,label:o,protocol:l,appData:b},f,C)}),c=new S.DataProducer({id:m,dataChannel:y,sctpStreamParameters:w,appData:b});return this._dataProducers.set(c.id,c),this.handleDataProducer(c),this._observer.safeEmit("newdataproducer",c),c},"transport.produceData()")}async consumeData({id:R,dataProducerId:i,sctpStreamParameters:n,label:o="",protocol:l="",appData:b={}}){if(a.debug("consumeData()"),this._closed)throw new r.InvalidStateError("closed");if(this._direction!=="recv")throw new r.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof R!="string")throw new TypeError("missing id");if(typeof i!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(b&&typeof b!="object")throw new TypeError("if given, appData must be an object")}else throw new r.UnsupportedError("SCTP not enabled by remote Transport");const y=u.clone(n);return v.validateAndNormalizeSctpStreamParameters(y),this._awaitQueue.push(async()=>{const{dataChannel:w}=await this._handler.receiveDataChannel({sctpStreamParameters:y,label:o,protocol:l}),m=new E.DataConsumer({id:R,dataProducerId:i,dataChannel:w,sctpStreamParameters:y,appData:b});return this._dataConsumers.set(m.id,m),this.handleDataConsumer(m),this._observer.safeEmit("newdataconsumer",m),m},"transport.consumeData()")}createPendingConsumers(){this._consumerCreationInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingConsumerTasks.length===0){a.debug("createPendingConsumers() | there is no Consumer to be created");return}const R=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let i;const n=[];for(const o of R){const{id:l,kind:b,rtpParameters:y,streamId:w,onRtpReceiver:m}=o.consumerOptions;n.push({trackId:l,kind:b,rtpParameters:y,streamId:w,onRtpReceiver:m})}try{const o=await this._handler.receive(n);for(let l=0;l<o.length;++l){const b=R[l],y=o[l],{id:w,producerId:m,kind:c,rtpParameters:f,appData:C}=b.consumerOptions,{localId:T,rtpReceiver:I,track:M}=y,p=new d.Consumer({id:w,localId:T,producerId:m,rtpReceiver:I,track:M,rtpParameters:f,appData:C});this._consumers.set(p.id,p),this.handleConsumer(p),!this._probatorConsumerCreated&&!i&&c==="video"&&(i=p),this._observer.safeEmit("newconsumer",p),b.resolve(p)}}catch(o){for(const l of R)l.reject(o)}if(i)try{const o=v.generateProbatorRtpParameters(i.rtpParameters);await this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:o}]),a.debug("createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(o){a.error("createPendingConsumers() | failed to create Consumer for RTP probation:%o",o)}},"transport.createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this.createPendingConsumers()}).catch(()=>{})}pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingPauseConsumers.size===0){a.debug("pausePendingConsumers() | there is no Consumer to be paused");return}const R=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{const i=R.map(n=>n.localId);await this._handler.pauseReceiving(i)}catch(i){a.error("pausePendingConsumers() | failed to pause Consumers:",i)}},"transport.pausePendingConsumers()").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this.pausePendingConsumers()}).catch(()=>{})}resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingResumeConsumers.size===0){a.debug("resumePendingConsumers() | there is no Consumer to be resumed");return}const R=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{const i=R.map(n=>n.localId);await this._handler.resumeReceiving(i)}catch(i){a.error("resumePendingConsumers() | failed to resume Consumers:",i)}},"transport.resumePendingConsumers()").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this.resumePendingConsumers()}).catch(()=>{})}closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingCloseConsumers.size===0){a.debug("closePendingConsumers() | there is no Consumer to be closed");return}const R=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{await this._handler.stopReceiving(R.map(i=>i.localId))}catch(i){a.error("closePendingConsumers() | failed to close Consumers:",i)}},"transport.closePendingConsumers()").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this.closePendingConsumers()}).catch(()=>{})}handleHandler(){const R=this._handler;R.on("@connect",({dtlsParameters:i},n,o)=>{if(this._closed){o(new r.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:i},n,o)}),R.on("@icegatheringstatechange",i=>{i!==this._iceGatheringState&&(a.debug("ICE gathering state changed to %s",i),this._iceGatheringState=i,this._closed||this.safeEmit("icegatheringstatechange",i))}),R.on("@icecandidateerror",i=>{a.warn(`ICE candidate error [url:${i.url}, localAddress:${i.address}, localPort:${i.port}]: ${i.errorCode} "${i.errorText}"`),this.safeEmit("icecandidateerror",i)}),R.on("@connectionstatechange",i=>{i!==this._connectionState&&(a.debug("connection state changed to %s",i),this._connectionState=i,this._closed||this.safeEmit("connectionstatechange",i))})}handleProducer(R){R.on("@close",()=>{this._producers.delete(R.id),!this._closed&&this._awaitQueue.push(async()=>await this._handler.stopSending(R.localId),"producer @close event").catch(i=>a.warn("producer.close() failed:%o",i))}),R.on("@pause",(i,n)=>{this._awaitQueue.push(async()=>await this._handler.pauseSending(R.localId),"producer @pause event").then(i).catch(n)}),R.on("@resume",(i,n)=>{this._awaitQueue.push(async()=>await this._handler.resumeSending(R.localId),"producer @resume event").then(i).catch(n)}),R.on("@replacetrack",(i,n,o)=>{this._awaitQueue.push(async()=>await this._handler.replaceTrack(R.localId,i),"producer @replacetrack event").then(n).catch(o)}),R.on("@setmaxspatiallayer",(i,n,o)=>{this._awaitQueue.push(async()=>await this._handler.setMaxSpatialLayer(R.localId,i),"producer @setmaxspatiallayer event").then(n).catch(o)}),R.on("@setrtpencodingparameters",(i,n,o)=>{this._awaitQueue.push(async()=>await this._handler.setRtpEncodingParameters(R.localId,i),"producer @setrtpencodingparameters event").then(n).catch(o)}),R.on("@getstats",(i,n)=>{if(this._closed)return n(new r.InvalidStateError("closed"));this._handler.getSenderStats(R.localId).then(i).catch(n)})}handleConsumer(R){R.on("@close",()=>{this._consumers.delete(R.id),this._pendingPauseConsumers.delete(R.id),this._pendingResumeConsumers.delete(R.id),!this._closed&&(this._pendingCloseConsumers.set(R.id,R),this._consumerCloseInProgress===!1&&this.closePendingConsumers())}),R.on("@pause",()=>{this._pendingResumeConsumers.has(R.id)&&this._pendingResumeConsumers.delete(R.id),this._pendingPauseConsumers.set(R.id,R),queueMicrotask(()=>{this._closed||this._consumerPauseInProgress===!1&&this.pausePendingConsumers()})}),R.on("@resume",()=>{this._pendingPauseConsumers.has(R.id)&&this._pendingPauseConsumers.delete(R.id),this._pendingResumeConsumers.set(R.id,R),queueMicrotask(()=>{this._closed||this._consumerResumeInProgress===!1&&this.resumePendingConsumers()})}),R.on("@getstats",(i,n)=>{if(this._closed)return n(new r.InvalidStateError("closed"));this._handler.getReceiverStats(R.localId).then(i).catch(n)})}handleDataProducer(R){R.on("@close",()=>{this._dataProducers.delete(R.id)})}handleDataConsumer(R){R.on("@close",()=>{this._dataConsumers.delete(R.id)})}}return me.Transport=_,me}var Se={},H={},gt={},_t={exports:{}},nr;function Dt(){if(nr)return _t.exports;nr=1;var s=_t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{push:"msid",reg:/^msid:([\w-]+)(?: ([\w-]+))?/,names:["id","appdata"],format:"msid:%s %s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(s).forEach(function(e){var t=s[e];t.forEach(function(r){r.reg||(r.reg=/(.*)/),r.format||(r.format="%s")})}),_t.exports}var ar;function gs(){return ar||(ar=1,(function(s){var e=function(d){return String(Number(d))===d?Number(d):d},t=function(d,S,E,a){if(a&&!E)S[a]=e(d[1]);else for(var g=0;g<E.length;g+=1)d[g+1]!=null&&(S[E[g]]=e(d[g+1]))},r=function(d,S,E){var a=d.name&&d.names;d.push&&!S[d.push]?S[d.push]=[]:a&&!S[d.name]&&(S[d.name]={});var g=d.push?{}:a?S[d.name]:S;t(E.match(d.reg),g,d.names,d.name),d.push&&S[d.push].push(g)},u=Dt(),v=RegExp.prototype.test.bind(/^([a-z])=(.*)/);s.parse=function(d){var S={},E=[],a=S;return d.split(/(\r\n|\r|\n)/).filter(v).forEach(function(g){var _=g[0],k=g.slice(2);_==="m"&&(E.push({rtp:[],fmtp:[]}),a=E[E.length-1]);for(var R=0;R<(u[_]||[]).length;R+=1){var i=u[_][R];if(i.reg.test(k))return r(i,a,k)}}),S.media=E,S};var h=function(d,S){var E=S.split(/=(.+)/,2);return E.length===2?d[E[0]]=e(E[1]):E.length===1&&S.length>1&&(d[E[0]]=void 0),d};s.parseParams=function(d){return d.split(/;\s?/).reduce(h,{})},s.parseFmtpConfig=s.parseParams,s.parsePayloads=function(d){return d.toString().split(" ").map(Number)},s.parseRemoteCandidates=function(d){for(var S=[],E=d.split(" ").map(e),a=0;a<E.length;a+=3)S.push({component:E[a],ip:E[a+1],port:E[a+2]});return S},s.parseImageAttributes=function(d){return d.split(" ").map(function(S){return S.substring(1,S.length-1).split(",").reduce(h,{})})},s.parseSimulcastStreamList=function(d){return d.split(";").map(function(S){return S.split(",").map(function(E){var a,g=!1;return E[0]!=="~"?a=e(E):(a=e(E.substring(1,E.length)),g=!0),{scid:a,paused:g}})})}})(gt)),gt}var vt,or;function _s(){if(or)return vt;or=1;var s=Dt(),e=/%[sdv%]/g,t=function(h){var d=1,S=arguments,E=S.length;return h.replace(e,function(a){if(d>=E)return a;var g=S[d];switch(d+=1,a){case"%%":return"%";case"%s":return String(g);case"%d":return Number(g);case"%v":return""}})},r=function(h,d,S){var E=d.format instanceof Function?d.format(d.push?S:S[d.name]):d.format,a=[h+"="+E];if(d.names)for(var g=0;g<d.names.length;g+=1){var _=d.names[g];d.name?a.push(S[d.name][_]):a.push(S[d.names[g]])}else a.push(S[d.name]);return t.apply(null,a)},u=["v","o","s","i","u","e","p","c","b","t","r","z","a"],v=["i","c","b","a"];return vt=function(h,d){d=d||{},h.version==null&&(h.version=0),h.name==null&&(h.name=" "),h.media.forEach(function(g){g.payloads==null&&(g.payloads="")});var S=d.outerOrder||u,E=d.innerOrder||v,a=[];return S.forEach(function(g){s[g].forEach(function(_){_.name in h&&h[_.name]!=null?a.push(r(g,_,h)):_.push in h&&h[_.push]!=null&&h[_.push].forEach(function(k){a.push(r(g,_,k))})})}),h.media.forEach(function(g){a.push(r("m",s.m[0],g)),E.forEach(function(_){s[_].forEach(function(k){k.name in g&&g[k.name]!=null?a.push(r(_,k,g)):k.push in g&&g[k.push]!=null&&g[k.push].forEach(function(R){a.push(r(_,k,R))})})})}),a.join(`\r
`)+`\r
`},vt}var cr;function re(){if(cr)return H;cr=1;var s=gs(),e=_s(),t=Dt();return H.grammar=t,H.write=e,H.parse=s.parse,H.parseParams=s.parseParams,H.parseFmtpConfig=s.parseFmtpConfig,H.parsePayloads=s.parsePayloads,H.parseRemoteCandidates=s.parseRemoteCandidates,H.parseImageAttributes=s.parseImageAttributes,H.parseSimulcastStreamList=s.parseSimulcastStreamList,H}var Ue={},dr;function pe(){if(dr)return Ue;dr=1,Object.defineProperty(Ue,"__esModule",{value:!0}),Ue.parse=e;const s=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function e(t){const r=s.exec(t??"");return r?{spatialLayers:Number(r[1]),temporalLayers:Number(r[2])}:{spatialLayers:1,temporalLayers:1}}return Ue}var Ce={},J={},pr;function vs(){if(pr)return J;pr=1,Object.defineProperty(J,"__esModule",{value:!0}),J.OfferMediaSection=J.AnswerMediaSection=J.MediaSection=void 0;const s=re(),e=de();let t=class{_mediaObject;constructor({iceParameters:d,iceCandidates:S,dtlsParameters:E}){if(this._mediaObject={type:"",port:0,protocol:"",payloads:"",rtp:[],fmtp:[]},d&&this.setIceParameters(d),S){this._mediaObject.candidates=[];for(const a of S){const g={foundation:a.foundation,component:1,ip:a.address??a.ip,port:a.port,priority:a.priority,transport:a.protocol,type:a.type};a.tcpType&&(g.tcptype=a.tcpType),this._mediaObject.candidates.push(g)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}E&&this.setDtlsRole(E.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(d){this._mediaObject.iceUfrag=d.usernameFragment,this._mediaObject.icePwd=d.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}};J.MediaSection=t;class r extends t{constructor({iceParameters:d,iceCandidates:S,dtlsParameters:E,sctpParameters:a,plainRtpParameters:g,offerMediaObject:_,offerRtpParameters:k,answerRtpParameters:R,codecOptions:i}){switch(super({iceParameters:d,iceCandidates:S,dtlsParameters:E}),this._mediaObject.mid=String(_.mid),this._mediaObject.type=_.type,this._mediaObject.protocol=_.protocol,g?(this._mediaObject.connection={ip:g.ip,version:g.ipVersion},this._mediaObject.port=g.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),_.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const n of R.codecs){const o={payload:n.payloadType,codec:v(n),rate:n.clockRate};n.channels>1&&(o.encoding=n.channels),this._mediaObject.rtp.push(o);const l=e.clone(n.parameters)??{};let b=e.clone(n.rtcpFeedback)??[];if(i){const{opusStereo:w,opusFec:m,opusDtx:c,opusMaxPlaybackRate:f,opusMaxAverageBitrate:C,opusPtime:T,opusNack:I,videoGoogleStartBitrate:M,videoGoogleMaxBitrate:p,videoGoogleMinBitrate:P}=i,D=k.codecs.find(x=>x.payloadType===n.payloadType);switch(n.mimeType.toLowerCase()){case"audio/opus":case"audio/multiopus":{w!==void 0&&(D.parameters["sprop-stereo"]=w?1:0,l.stereo=w?1:0),m!==void 0&&(D.parameters.useinbandfec=m?1:0,l.useinbandfec=m?1:0),c!==void 0&&(D.parameters.usedtx=c?1:0,l.usedtx=c?1:0),f!==void 0&&(l.maxplaybackrate=f),C!==void 0&&(l.maxaveragebitrate=C),T!==void 0&&(D.parameters.ptime=T,l.ptime=T),I||(D.rtcpFeedback=D.rtcpFeedback.filter(x=>x.type!=="nack"||x.parameter),b=b.filter(x=>x.type!=="nack"||x.parameter));break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":case"video/av1":{M!==void 0&&(l["x-google-start-bitrate"]=M),p!==void 0&&(l["x-google-max-bitrate"]=p),P!==void 0&&(l["x-google-min-bitrate"]=P);break}}}const y={payload:n.payloadType,config:""};for(const w of Object.keys(l))y.config&&(y.config+=";"),y.config+=`${w}=${l[w]}`;y.config&&this._mediaObject.fmtp.push(y);for(const w of b)this._mediaObject.rtcpFb.push({payload:n.payloadType,type:w.type,subtype:w.parameter})}this._mediaObject.payloads=R.codecs.map(n=>n.payloadType).join(" "),this._mediaObject.ext=[];for(const n of R.headerExtensions)(_.ext??[]).some(l=>l.uri===n.uri)&&this._mediaObject.ext.push({uri:n.uri,value:n.id});if(_.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),_.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:_.simulcast.list1},this._mediaObject.rids=[];for(const n of _.rids??[])n.direction==="send"&&this._mediaObject.rids.push({id:n.id,direction:"recv"})}else if(_.simulcast_03){this._mediaObject.simulcast_03={value:_.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const n of _.rids??[])n.direction==="send"&&this._mediaObject.rids.push({id:n.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";break}case"application":{typeof _.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=a.port,this._mediaObject.maxMessageSize=a.maxMessageSize):_.sctpmap&&(this._mediaObject.payloads=String(a.port),this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:a.port,maxMessageSize:a.maxMessageSize});break}}}setDtlsRole(d){switch(d){case"client":{this._mediaObject.setup="active";break}case"server":{this._mediaObject.setup="passive";break}case"auto":{this._mediaObject.setup="actpass";break}}}resume(){this._mediaObject.direction="recvonly"}muxSimulcastStreams(d){if(!this._mediaObject.simulcast?.list1)return;const S={};for(const g of d)g.rid&&(S[g.rid]=g);const E=this._mediaObject.simulcast.list1,a=s.parseSimulcastStreamList(E);for(const g of a)for(const _ of g)_.paused=!S[_.scid]?.active;this._mediaObject.simulcast.list1=a.map(g=>g.map(_=>`${_.paused?"~":""}${_.scid}`).join(",")).join(";")}}J.AnswerMediaSection=r;class u extends t{constructor({iceParameters:d,iceCandidates:S,dtlsParameters:E,sctpParameters:a,plainRtpParameters:g,mid:_,kind:k,offerRtpParameters:R,streamId:i,trackId:n}){switch(super({iceParameters:d,iceCandidates:S,dtlsParameters:E}),this._mediaObject.mid=String(_),this._mediaObject.type=k,g?(this._mediaObject.connection={ip:g.ip,version:g.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=g.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},a?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),this._mediaObject.extmapAllowMixed="extmap-allow-mixed",k){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._mediaObject.msid=[{id:i,appdata:n}];for(const y of R.codecs){const w={payload:y.payloadType,codec:v(y),rate:y.clockRate};y.channels>1&&(w.encoding=y.channels),this._mediaObject.rtp.push(w);const m={payload:y.payloadType,config:""};for(const c of Object.keys(y.parameters??{}))m.config&&(m.config+=";"),m.config+=`${c}=${y.parameters[c]}`;m.config&&this._mediaObject.fmtp.push(m);for(const c of y.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:y.payloadType,type:c.type,subtype:c.parameter})}this._mediaObject.payloads=R.codecs.map(y=>y.payloadType).join(" "),this._mediaObject.ext=[];for(const y of R.headerExtensions)this._mediaObject.ext.push({uri:y.uri,value:y.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const o=R.encodings[0],l=o.ssrc,b=o.rtx?.ssrc;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],l&&R.rtcp.cname&&this._mediaObject.ssrcs.push({id:l,attribute:"cname",value:R.rtcp.cname}),b&&(R.rtcp.cname&&this._mediaObject.ssrcs.push({id:b,attribute:"cname",value:R.rtcp.cname}),l&&this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${l} ${b}`}));break}case"application":{this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=a.port,this._mediaObject.maxMessageSize=a.maxMessageSize;break}}}setDtlsRole(d){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}}J.OfferMediaSection=u;function v(h){const S=new RegExp("^(audio|video)/(.+)","i").exec(h.mimeType);if(!S)throw new TypeError("invalid codec.mimeType");return S[2]}return J}var lr;function Fe(){if(lr)return Ce;lr=1,Object.defineProperty(Ce,"__esModule",{value:!0}),Ce.RemoteSdp=void 0;const s=re(),e=q(),t=vs(),r=["av1","h264"],u=new e.Logger("RemoteSdp");let v=class{_iceParameters;_iceCandidates;_dtlsParameters;_sctpParameters;_plainRtpParameters;_mediaSections=[];_midToIndex=new Map;_firstMid;_sdpObject;constructor({iceParameters:d,iceCandidates:S,dtlsParameters:E,sctpParameters:a,plainRtpParameters:g}){if(this._iceParameters=d,this._iceCandidates=S,this._dtlsParameters=E,this._sctpParameters=a,this._plainRtpParameters=g,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:"10000",sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},this._sdpObject.iceOptions="ice2",d?.iceLite&&(this._sdpObject.icelite="ice-lite"),E){const _=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:E.fingerprints[_-1].algorithm,hash:E.fingerprints[_-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}g&&(this._sdpObject.origin.address=g.ip,this._sdpObject.origin.ipVer=g.ipVersion)}updateIceParameters(d){u.debug("updateIceParameters() [iceParameters:%o]",d),this._iceParameters=d,this._sdpObject.icelite=d.iceLite?"ice-lite":void 0;for(const S of this._mediaSections)S.setIceParameters(d)}updateDtlsRole(d){u.debug("updateDtlsRole() [role:%s]",d),this._dtlsParameters.role=d;for(const S of this._mediaSections)S.setDtlsRole(d)}setSessionExtmapAllowMixed(){u.debug("setSessionExtmapAllowMixed()"),this._sdpObject.extmapAllowMixed="extmap-allow-mixed"}getNextMediaSectionIdx(){for(let d=0;d<this._mediaSections.length;++d){const S=this._mediaSections[d];if(S.closed)return{idx:d,reuseMid:S.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:d,reuseMid:S,offerRtpParameters:E,answerRtpParameters:a,codecOptions:g}){const _=new t.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:d,offerRtpParameters:E,answerRtpParameters:a,codecOptions:g}),k=_.getObject();k.rtp.find(i=>r.includes(i.codec.toLowerCase()))||(k.ext=k.ext?.filter(i=>i.uri!=="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension")),S?this.replaceMediaSection(_,S):this._midToIndex.has(_.mid)?this.replaceMediaSection(_):this.addMediaSection(_)}receive({mid:d,kind:S,offerRtpParameters:E,streamId:a,trackId:g}){this.setSessionExtmapAllowMixed();const _=new t.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,mid:d,kind:S,offerRtpParameters:E,streamId:a,trackId:g}),k=this._mediaSections.find(R=>R.closed);k?this.replaceMediaSection(_,k.mid):this.addMediaSection(_)}pauseMediaSection(d){this.findMediaSection(d).pause()}resumeSendingMediaSection(d){this.findMediaSection(d).resume()}resumeReceivingMediaSection(d){this.findMediaSection(d).resume()}disableMediaSection(d){this.findMediaSection(d).disable()}closeMediaSection(d){const S=this.findMediaSection(d);return d===this._firstMid?(u.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",d),this.disableMediaSection(d),!1):(S.close(),this.regenerateBundleMids(),!0)}muxMediaSectionSimulcast(d,S){const E=this.findMediaSection(d);E.muxSimulcastStreams(S),this.replaceMediaSection(E)}sendSctpAssociation({offerMediaObject:d}){const S=new t.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:d});this.addMediaSection(S)}receiveSctpAssociation(){const d=new t.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application"});this.addMediaSection(d)}getSdp(){return this._sdpObject.origin.sessionVersion++,s.write(this._sdpObject)}addMediaSection(d){this._firstMid||(this._firstMid=d.mid),this._mediaSections.push(d),this._midToIndex.set(d.mid,this._mediaSections.length-1),this._sdpObject.media.push(d.getObject()),this.regenerateBundleMids()}replaceMediaSection(d,S){if(typeof S=="string"){const E=this._midToIndex.get(S);if(E===void 0)throw new Error(`no media section found for reuseMid '${S}'`);const a=this._mediaSections[E];this._mediaSections[E]=d,this._midToIndex.delete(a.mid),this._midToIndex.set(d.mid,E),this._sdpObject.media[E]=d.getObject(),this.regenerateBundleMids()}else{const E=this._midToIndex.get(d.mid);if(E===void 0)throw new Error(`no media section found with mid '${d.mid}'`);this._mediaSections[E]=d,this._sdpObject.media[E]=d.getObject()}}findMediaSection(d){const S=this._midToIndex.get(d);if(S===void 0)throw new Error(`no media section found with mid '${d}'`);return this._mediaSections[S]}regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(d=>!d.closed).map(d=>d.mid).join(" "))}};return Ce.RemoteSdp=v,Ce}var Z={},ur;function je(){if(ur)return Z;ur=1,Object.defineProperty(Z,"__esModule",{value:!0}),Z.extractRtpCapabilities=e,Z.extractDtlsParameters=t,Z.getCname=r,Z.applyCodecParameters=u,Z.addHeaderExtension=v;const s=re();function e({sdpObject:h}){const d=new Map,S=new Map;for(const a of h.media){const g=a.type;switch(g){case"audio":case"video":break;default:continue}for(const _ of a.rtp){const k={kind:g,mimeType:`${g}/${_.codec}`,preferredPayloadType:_.payload,clockRate:_.rate,channels:_.encoding,parameters:{},rtcpFeedback:[]};d.set(k.preferredPayloadType,k)}for(const _ of a.fmtp??[]){const k=s.parseParams(_.config),R=d.get(_.payload);R&&(k?.hasOwnProperty("profile-level-id")&&(k["profile-level-id"]=String(k["profile-level-id"])),R.parameters=k)}for(const _ of a.rtcpFb??[]){const k={type:_.type,parameter:_.subtype};if(k.parameter||delete k.parameter,_.payload!=="*"){const R=d.get(Number(_.payload));if(!R)continue;R.rtcpFeedback.push(k)}else for(const R of d.values())R.kind===g&&!/.+\/rtx$/i.test(R.mimeType)&&R.rtcpFeedback.push(k)}for(const _ of a.ext??[]){if(_["encrypt-uri"])continue;const k={kind:g,uri:_.uri,preferredId:_.value};S.set(k.preferredId,k)}}return{codecs:Array.from(d.values()),headerExtensions:Array.from(S.values())}}function t({sdpObject:h}){let d=h.setup,S=h.fingerprint;if(!d||!S){const g=(h.media??[]).find(_=>_.port!==0);g&&(d=d??g.setup,S=S??g.fingerprint)}if(d){if(!S)throw new Error("no a=fingerprint found at SDP session or media level")}else throw new Error("no a=setup found at SDP session or media level");let E;switch(d){case"active":{E="client";break}case"passive":{E="server";break}case"actpass":{E="auto";break}}return{role:E,fingerprints:[{algorithm:S.type,value:S.hash}]}}function r({offerMediaObject:h}){const d=(h.ssrcs??[]).find(S=>S.attribute==="cname");return d?d.value:""}function u({offerRtpParameters:h,answerMediaObject:d}){for(const S of h.codecs){const E=S.mimeType.toLowerCase();if(E!=="audio/opus"||!(d.rtp??[]).find(k=>k.payload===S.payloadType))continue;d.fmtp=d.fmtp??[];let g=d.fmtp.find(k=>k.payload===S.payloadType);g||(g={payload:S.payloadType,config:""},d.fmtp.push(g));const _=s.parseParams(g.config);switch(E){case"audio/opus":{const k=S.parameters?.["sprop-stereo"];k!==void 0&&(_.stereo=Number(k)?1:0);break}}g.config="";for(const k of Object.keys(_))g.config&&(g.config+=";"),g.config+=`${k}=${_[k]}`}}function v({offerMediaObject:h,headerExtensionUri:d,headerExtensionId:S}){h.ext||(h.ext=[]),h.ext.push({uri:d,value:S})}return Z}var Re={},hr;function Be(){if(hr)return Re;hr=1,Object.defineProperty(Re,"__esModule",{value:!0}),Re.getRtpEncodings=s,Re.addLegacySimulcast=e;function s({offerMediaObject:t}){const r=new Set;for(const h of t.ssrcs??[]){const d=h.id;d&&r.add(d)}if(r.size===0)throw new Error("no a=ssrc lines found");const u=new Map;for(const h of t.ssrcGroups??[]){if(h.semantics!=="FID")continue;const d=h.ssrcs.split(/\s+/),S=Number(d[0]),E=Number(d[1]);r.has(S)&&(r.delete(S),r.delete(E),u.set(S,E))}for(const h of r)u.set(h,void 0);const v=[];for(const[h,d]of u){const S={ssrc:h};d&&(S.rtx={ssrc:d}),v.push(S)}return v}function e({offerMediaObject:t,numStreams:r}){if(r<=1)throw new TypeError("numStreams must be greater than 1");const u=(t.ssrcs??[]).find(k=>k.attribute==="msid");if(!u)throw new Error("a=ssrc line with msid information not found");const[v,h]=u.value.split(" "),d=Number(u.id);let S;(t.ssrcGroups??[]).some(k=>{if(k.semantics!=="FID")return!1;const R=k.ssrcs.split(/\s+/);return Number(R[0])===d?(S=Number(R[1]),!0):!1});const E=(t.ssrcs??[]).find(k=>k.attribute==="cname");if(!E)throw new Error("a=ssrc line with cname information not found");const a=E.value,g=[],_=[];for(let k=0;k<r;++k)g.push(d+k),S&&_.push(S+k);t.ssrcGroups=[],t.ssrcs=[],t.ssrcGroups.push({semantics:"SIM",ssrcs:g.join(" ")});for(const k of g)t.ssrcs.push({id:k,attribute:"cname",value:a}),t.ssrcs.push({id:k,attribute:"msid",value:`${v} ${h}`});for(let k=0;k<_.length;++k){const R=g[k],i=_[k];t.ssrcs.push({id:i,attribute:"cname",value:a}),t.ssrcs.push({id:i,attribute:"msid",value:`${v} ${h}`}),t.ssrcGroups.push({semantics:"FID",ssrcs:`${R} ${i}`})}}return Re}var ce={},fr;function $e(){if(fr)return ce;fr=1,Object.defineProperty(ce,"__esModule",{value:!0}),ce.addNackSupportForOpus=s,ce.addHeaderExtensionSupport=e,ce.getMsidStreamIdAndTrackId=t;function s(r){for(const u of r.codecs??[])(u.mimeType.toLowerCase()==="audio/opus"||u.mimeType.toLowerCase()==="audio/multiopus")&&!u.rtcpFeedback?.some(v=>v.type==="nack"&&!v.parameter)&&(u.rtcpFeedback||(u.rtcpFeedback=[]),u.rtcpFeedback.push({type:"nack"}))}function e(r,u){if(r.headerExtensions?.some(S=>S.kind===u.kind&&S.uri===u.uri))return;r.headerExtensions||(r.headerExtensions=[]);const v=new Set(r.headerExtensions.filter(S=>S.uri!==u.uri).map(S=>S.preferredId));let h=1;for(;v.has(h);)++h;const d={kind:u.kind,uri:u.uri,preferredId:h,preferredEncrypt:!1,direction:u.direction};r.headerExtensions.push(d)}function t(r){if(!r||typeof r!="string")return{msidStreamId:void 0,msidTrackId:void 0};const[u,v]=r.trim().split(/\s+/);return u?{msidStreamId:u,msidTrackId:v}:{msidStreamId:void 0,msidTrackId:void 0}}return ce}var mr;function ys(){if(mr)return Se;mr=1,Object.defineProperty(Se,"__esModule",{value:!0}),Se.Chrome111=void 0;const s=re(),e=z(),t=q(),r=X(),u=Q(),v=pe(),h=Fe(),d=je(),S=Be(),E=$e(),a=new t.Logger("Chrome111"),g="Chrome111",_={OS:1024,MIS:1024};let k=class Ke extends e.EnhancedEventEmitter{_closed=!1;_direction;_remoteSdp;_getSendExtendedRtpCapabilities;_forcedLocalDtlsRole;_pc;_mapMidTransceiver=new Map;_sendStream=new MediaStream;_hasDataChannelMediaSection=!1;_nextSendSctpStreamId=0;_transportReady=!1;static createFactory(){return{name:g,factory:i=>new Ke(i),getNativeRtpCapabilities:async()=>{a.debug("getNativeRtpCapabilities()");let i=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{i.addTransceiver("audio"),i.addTransceiver("video",{sendEncodings:[{scalabilityMode:"L3T3"}]});const n=await i.createOffer();try{i.close()}catch{}i=void 0;const o=s.parse(n.sdp);return Ke.getLocalRtpCapabilities(o)}catch(n){try{i?.close()}catch{}throw i=void 0,n}},getNativeSctpCapabilities:async()=>(a.debug("getNativeSctpCapabilities()"),{numStreams:_})}}static getLocalRtpCapabilities(i,n=[]){const o=d.extractRtpCapabilities({sdpObject:i});r.validateAndNormalizeRtpCapabilities(o),E.addNackSupportForOpus(o);for(const l of n)E.addHeaderExtensionSupport(o,l);return o}constructor({direction:i,iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b,iceServers:y,iceTransportPolicy:w,additionalSettings:m,getSendExtendedRtpCapabilities:c}){super(),a.debug("constructor()"),this._direction=i,this._remoteSdp=new h.RemoteSdp({iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b}),this._getSendExtendedRtpCapabilities=c,l.role&&l.role!=="auto"&&(this._forcedLocalDtlsRole=l.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:y??[],iceTransportPolicy:w??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...m}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(a.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}get name(){return g}close(){if(a.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(i){this.assertNotClosed(),a.debug("updateIceServers()");const n=this._pc.getConfiguration();n.iceServers=i,this._pc.setConfiguration(n)}async restartIce(i){if(this.assertNotClosed(),a.debug("restartIce()"),this._remoteSdp.updateIceParameters(i),!!this._transportReady)if(this._direction==="send"){const n=await this._pc.createOffer({iceRestart:!0});a.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}else{const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:i,streamId:n,encodings:o,codecOptions:l,headerExtensionOptions:b,codec:y,onRtpSender:w}){if(this.assertNotClosed(),this.assertSendDirection(),a.debug("send() [kind:%s, track.id:%s, streamId:%s]",i.kind,i.id,n),o&&o.length>1){let O=1;for(const A of o){const N=A.scalabilityMode?(0,v.parse)(A.scalabilityMode).temporalLayers:3;N>O&&(O=N)}o.forEach((A,N)=>{A.rid=`r${N}`,A.scalabilityMode=`L1T${O}`})}const m=this._remoteSdp.getNextMediaSectionIdx(),c=this._pc.addTransceiver(i,{direction:"sendonly",streams:[this._sendStream],sendEncodings:o});w&&w(c.sender);let f=await this._pc.createOffer(),C=s.parse(f.sdp);C.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const T=[];T.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:i.kind,direction:"sendonly"});const I=Ke.getLocalRtpCapabilities(C,T),M=this._getSendExtendedRtpCapabilities(I),p=r.getSendingRtpParameters(i.kind,M);p.codecs=r.reduceCodecs(p.codecs,y);const P=r.getSendingRemoteRtpParameters(i.kind,M);if(P.codecs=r.reduceCodecs(P.codecs,y),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:C}),b?.absCaptureTime){const O=C.media[m.idx];d.addHeaderExtension({offerMediaObject:O,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:P.headerExtensions.find(A=>A.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),f={type:"offer",sdp:s.write(C)}}a.debug("send() | calling pc.setLocalDescription() [offer:%o]",f),await this._pc.setLocalDescription(f);const D=c.mid;p.mid=D,C=s.parse(this._pc.localDescription.sdp);const x=C.media[m.idx];if(p.rtcp.cname=d.getCname({offerMediaObject:x}),p.msid=`${n??this._sendStream.id} ${i.id}`,!o)p.encodings=S.getRtpEncodings({offerMediaObject:x});else if(o.length===1){const O=S.getRtpEncodings({offerMediaObject:x});Object.assign(O[0],o[0]),p.encodings=O}else p.encodings=o;this._remoteSdp.send({offerMediaObject:x,reuseMid:m.reuseMid,offerRtpParameters:p,answerRtpParameters:P,codecOptions:l});const L={type:"answer",sdp:this._remoteSdp.getSdp()};return a.debug("send() | calling pc.setRemoteDescription() [answer:%o]",L),await this._pc.setRemoteDescription(L),this._mapMidTransceiver.set(D,c),{localId:D,rtpParameters:p,rtpSender:c.sender}}async stopSending(i){if(this.assertSendDirection(),a.debug("stopSending() [localId:%s]",i),this._closed)return;const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");if(n.sender.replaceTrack(null),this._pc.removeTrack(n.sender),this._remoteSdp.closeMediaSection(n.mid))try{n.stop()}catch{}const l=await this._pc.createOffer();a.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);const b={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",b),await this._pc.setRemoteDescription(b),this._mapMidTransceiver.delete(i)}async pauseSending(i){this.assertNotClosed(),this.assertSendDirection(),a.debug("pauseSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i);const o=await this._pc.createOffer();a.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const l={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async resumeSending(i){this.assertNotClosed(),this.assertSendDirection(),a.debug("resumeSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(this._remoteSdp.resumeSendingMediaSection(i),!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="sendonly";const o=await this._pc.createOffer();a.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const l={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async replaceTrack(i,n){this.assertNotClosed(),this.assertSendDirection(),n?a.debug("replaceTrack() [localId:%s, track.id:%s]",i,n.id):a.debug("replaceTrack() [localId:%s, no track]",i);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");await o.sender.replaceTrack(n)}async setMaxSpatialLayer(i,n){this.assertNotClosed(),this.assertSendDirection(),a.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",i,n);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");const l=o.sender.getParameters();l.encodings.forEach((w,m)=>{m<=n?w.active=!0:w.active=!1}),await o.sender.setParameters(l),this._remoteSdp.muxMediaSectionSimulcast(i,l.encodings);const b=await this._pc.createOffer();a.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",b),await this._pc.setLocalDescription(b);const y={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",y),await this._pc.setRemoteDescription(y)}async setRtpEncodingParameters(i,n){this.assertNotClosed(),this.assertSendDirection(),a.debug("setRtpEncodingParameters() [localId:%s, params:%o]",i,n);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");const l=o.sender.getParameters();l.encodings.forEach((w,m)=>{l.encodings[m]={...w,...n}}),await o.sender.setParameters(l),this._remoteSdp.muxMediaSectionSimulcast(i,l.encodings);const b=await this._pc.createOffer();a.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",b),await this._pc.setLocalDescription(b);const y={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",y),await this._pc.setRemoteDescription(y)}async getSenderStats(i){this.assertNotClosed(),this.assertSendDirection();const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");return n.sender.getStats()}async sendDataChannel({ordered:i,maxPacketLifeTime:n,maxRetransmits:o,label:l,protocol:b}){this.assertNotClosed(),this.assertSendDirection();const y={negotiated:!0,id:this._nextSendSctpStreamId,ordered:i,maxPacketLifeTime:n,maxRetransmits:o,protocol:b};a.debug("sendDataChannel() [options:%o]",y);const w=this._pc.createDataChannel(l,y);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%_.MIS,!this._hasDataChannelMediaSection){const c=await this._pc.createOffer(),f=s.parse(c.sdp),C=f.media.find(I=>I.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:f}),a.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c),this._remoteSdp.sendSctpAssociation({offerMediaObject:C});const T={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",T),await this._pc.setRemoteDescription(T),this._hasDataChannelMediaSection=!0}const m={streamId:y.id,ordered:y.ordered,maxPacketLifeTime:y.maxPacketLifeTime,maxRetransmits:y.maxRetransmits};return{dataChannel:w,sctpStreamParameters:m}}async receive(i){this.assertNotClosed(),this.assertRecvDirection();const n=[],o=new Map;for(const w of i){const{trackId:m,kind:c,rtpParameters:f,streamId:C}=w;a.debug("receive() [trackId:%s, kind:%s]",m,c);const T=f.mid??String(this._mapMidTransceiver.size);o.set(m,T);const{msidStreamId:I}=E.getMsidStreamIdAndTrackId(f.msid);this._remoteSdp.receive({mid:T,kind:c,offerRtpParameters:f,streamId:C??I??f.rtcp?.cname??"-",trackId:m})}const l={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",l),await this._pc.setRemoteDescription(l);for(const w of i){const{trackId:m,onRtpReceiver:c}=w;if(c){const f=o.get(m),C=this._pc.getTransceivers().find(T=>T.mid===f);if(!C)throw new Error("transceiver not found");c(C.receiver)}}let b=await this._pc.createAnswer();const y=s.parse(b.sdp);for(const w of i){const{trackId:m,rtpParameters:c}=w,f=o.get(m),C=y.media.find(T=>String(T.mid)===f);d.applyCodecParameters({offerRtpParameters:c,answerMediaObject:C})}b={type:"answer",sdp:s.write(y)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:y}),a.debug("receive() | calling pc.setLocalDescription() [answer:%o]",b),await this._pc.setLocalDescription(b);for(const w of i){const{trackId:m}=w,c=o.get(m),f=this._pc.getTransceivers().find(C=>C.mid===c);if(f)this._mapMidTransceiver.set(c,f),n.push({localId:c,track:f.receiver.track,rtpReceiver:f.receiver});else throw new Error("new RTCRtpTransceiver not found")}return n}async stopReceiving(i){if(this.assertRecvDirection(),this._closed)return;for(const l of i){a.debug("stopReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(b.mid)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);for(const l of i)this._mapMidTransceiver.delete(l)}async pauseReceiving(i){this.assertNotClosed(),this.assertRecvDirection();for(const l of i){a.debug("pauseReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");b.direction="inactive",this._remoteSdp.pauseMediaSection(l)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}async resumeReceiving(i){this.assertNotClosed(),this.assertRecvDirection();for(const l of i){a.debug("resumeReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");b.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(l)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}async getReceiverStats(i){this.assertNotClosed(),this.assertRecvDirection();const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");return n.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:i,label:n,protocol:o}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:l,ordered:b,maxPacketLifeTime:y,maxRetransmits:w}=i,m={negotiated:!0,id:l,ordered:b,maxPacketLifeTime:y,maxRetransmits:w,protocol:o};a.debug("receiveDataChannel() [options:%o]",m);const c=this._pc.createDataChannel(n,m);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const f={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",f),await this._pc.setRemoteDescription(f);const C=await this._pc.createAnswer();if(!this._transportReady){const T=s.parse(C.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:T})}a.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",C),await this._pc.setLocalDescription(C),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async setupTransport({localDtlsRole:i,localSdpObject:n}){n||(n=s.parse(this._pc.localDescription.sdp));const o=d.extractDtlsParameters({sdpObject:n});o.role=i,this._remoteSdp.updateDtlsRole(i==="client"?"server":"client"),await new Promise((l,b)=>{this.safeEmit("@connect",{dtlsParameters:o},l,b)}),this._transportReady=!0}onIceGatheringStateChange=()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)};onIceCandidateError=i=>{this.emit("@icecandidateerror",i)};onConnectionStateChange=()=>{this.emit("@connectionstatechange",this._pc.connectionState)};onIceConnectionStateChange=()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}};assertNotClosed(){if(this._closed)throw new u.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};return Se.Chrome111=k,Se}var Ee={},gr;function ws(){if(gr)return Ee;gr=1,Object.defineProperty(Ee,"__esModule",{value:!0}),Ee.Chrome74=void 0;const s=re(),e=q(),t=z(),r=X(),u=Q(),v=pe(),h=Fe(),d=je(),S=Be(),E=$e(),a=new e.Logger("Chrome74"),g="Chrome74",_={OS:1024,MIS:1024};let k=class Qe extends t.EnhancedEventEmitter{_closed=!1;_direction;_remoteSdp;_getSendExtendedRtpCapabilities;_forcedLocalDtlsRole;_pc;_mapMidTransceiver=new Map;_sendStream=new MediaStream;_hasDataChannelMediaSection=!1;_nextSendSctpStreamId=0;_transportReady=!1;static createFactory(){return{name:g,factory:i=>new Qe(i),getNativeRtpCapabilities:async()=>{a.debug("getNativeRtpCapabilities()");let i=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{i.addTransceiver("audio"),i.addTransceiver("video");const n=await i.createOffer();try{i.close()}catch{}i=void 0;const o=s.parse(n.sdp);return Qe.getLocalRtpCapabilities(o)}catch(n){try{i?.close()}catch{}throw i=void 0,n}},getNativeSctpCapabilities:async()=>(a.debug("getNativeSctpCapabilities()"),{numStreams:_})}}static getLocalRtpCapabilities(i,n=[]){const o=d.extractRtpCapabilities({sdpObject:i});r.validateAndNormalizeRtpCapabilities(o),E.addNackSupportForOpus(o);for(const l of n)E.addHeaderExtensionSupport(o,l);return o}constructor({direction:i,iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b,iceServers:y,iceTransportPolicy:w,additionalSettings:m,getSendExtendedRtpCapabilities:c}){super(),a.debug("constructor()"),this._direction=i,this._remoteSdp=new h.RemoteSdp({iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b}),this._getSendExtendedRtpCapabilities=c,l.role&&l.role!=="auto"&&(this._forcedLocalDtlsRole=l.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:y??[],iceTransportPolicy:w??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...m}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(a.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}get name(){return g}close(){if(a.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(i){this.assertNotClosed(),a.debug("updateIceServers()");const n=this._pc.getConfiguration();n.iceServers=i,this._pc.setConfiguration(n)}async restartIce(i){if(this.assertNotClosed(),a.debug("restartIce()"),this._remoteSdp.updateIceParameters(i),!!this._transportReady)if(this._direction==="send"){const n=await this._pc.createOffer({iceRestart:!0});a.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}else{const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:i,streamId:n,encodings:o,codecOptions:l,headerExtensionOptions:b,codec:y}){this.assertNotClosed(),this.assertSendDirection(),a.debug("send() [kind:%s, track.id:%s, streamId:%s]",i.kind,i.id,n),o&&o.length>1&&o.forEach((A,N)=>{A.rid=`r${N}`});const w=this._remoteSdp.getNextMediaSectionIdx(),m=this._pc.addTransceiver(i,{direction:"sendonly",streams:[this._sendStream],sendEncodings:o});let c=await this._pc.createOffer(),f=s.parse(c.sdp);f.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const C=[];C.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:i.kind,direction:"sendonly"});const T=Qe.getLocalRtpCapabilities(f,C),I=this._getSendExtendedRtpCapabilities(T),M=r.getSendingRtpParameters(i.kind,I);M.codecs=r.reduceCodecs(M.codecs,y);const p=r.getSendingRemoteRtpParameters(i.kind,I);p.codecs=r.reduceCodecs(p.codecs,y),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:f});let P=!1;const D=(0,v.parse)((o??[{}])[0].scalabilityMode);let x;o?.length===1&&D.spatialLayers>1&&M.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(a.debug("send() | enabling legacy simulcast for VP9 SVC"),P=!0,f=s.parse(c.sdp),x=f.media[w.idx],S.addLegacySimulcast({offerMediaObject:x,numStreams:D.spatialLayers}),c={type:"offer",sdp:s.write(f)}),a.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),b?.absCaptureTime&&(x=f.media[w.idx],d.addHeaderExtension({offerMediaObject:x,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:p.headerExtensions.find(A=>A.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),c={type:"offer",sdp:s.write(f)}),await this._pc.setLocalDescription(c);const L=m.mid;if(M.mid=L,f=s.parse(this._pc.localDescription.sdp),x=f.media[w.idx],M.rtcp.cname=d.getCname({offerMediaObject:x}),M.msid=`${n??this._sendStream.id} ${i.id}`,!o)M.encodings=S.getRtpEncodings({offerMediaObject:x});else if(o.length===1){let A=S.getRtpEncodings({offerMediaObject:x});Object.assign(A[0],o[0]),P&&(A=[A[0]]),M.encodings=A}else M.encodings=o;if(M.encodings.length>1&&(M.codecs[0].mimeType.toLowerCase()==="video/vp8"||M.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const A of M.encodings)A.scalabilityMode?A.scalabilityMode=`L1T${D.temporalLayers}`:A.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:x,reuseMid:w.reuseMid,offerRtpParameters:M,answerRtpParameters:p,codecOptions:l});const O={type:"answer",sdp:this._remoteSdp.getSdp()};return a.debug("send() | calling pc.setRemoteDescription() [answer:%o]",O),await this._pc.setRemoteDescription(O),this._mapMidTransceiver.set(L,m),{localId:L,rtpParameters:M,rtpSender:m.sender}}async stopSending(i){if(this.assertSendDirection(),a.debug("stopSending() [localId:%s]",i),this._closed)return;const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");if(n.sender.replaceTrack(null),this._pc.removeTrack(n.sender),this._remoteSdp.closeMediaSection(n.mid))try{n.stop()}catch{}const l=await this._pc.createOffer();a.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);const b={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",b),await this._pc.setRemoteDescription(b),this._mapMidTransceiver.delete(i)}async pauseSending(i){this.assertNotClosed(),this.assertSendDirection(),a.debug("pauseSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i);const o=await this._pc.createOffer();a.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const l={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async resumeSending(i){this.assertNotClosed(),this.assertSendDirection(),a.debug("resumeSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(this._remoteSdp.resumeSendingMediaSection(i),!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="sendonly";const o=await this._pc.createOffer();a.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const l={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async replaceTrack(i,n){this.assertNotClosed(),this.assertSendDirection(),n?a.debug("replaceTrack() [localId:%s, track.id:%s]",i,n.id):a.debug("replaceTrack() [localId:%s, no track]",i);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");await o.sender.replaceTrack(n)}async setMaxSpatialLayer(i,n){this.assertNotClosed(),this.assertSendDirection(),a.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",i,n);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");const l=o.sender.getParameters();l.encodings.forEach((w,m)=>{m<=n?w.active=!0:w.active=!1}),await o.sender.setParameters(l),this._remoteSdp.muxMediaSectionSimulcast(i,l.encodings);const b=await this._pc.createOffer();a.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",b),await this._pc.setLocalDescription(b);const y={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",y),await this._pc.setRemoteDescription(y)}async setRtpEncodingParameters(i,n){this.assertNotClosed(),this.assertSendDirection(),a.debug("setRtpEncodingParameters() [localId:%s, params:%o]",i,n);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");const l=o.sender.getParameters();l.encodings.forEach((w,m)=>{l.encodings[m]={...w,...n}}),await o.sender.setParameters(l),this._remoteSdp.muxMediaSectionSimulcast(i,l.encodings);const b=await this._pc.createOffer();a.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",b),await this._pc.setLocalDescription(b);const y={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",y),await this._pc.setRemoteDescription(y)}async getSenderStats(i){this.assertNotClosed(),this.assertSendDirection();const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");return n.sender.getStats()}async sendDataChannel({ordered:i,maxPacketLifeTime:n,maxRetransmits:o,label:l,protocol:b}){this.assertNotClosed(),this.assertSendDirection();const y={negotiated:!0,id:this._nextSendSctpStreamId,ordered:i,maxPacketLifeTime:n,maxRetransmits:o,protocol:b};a.debug("sendDataChannel() [options:%o]",y);const w=this._pc.createDataChannel(l,y);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%_.MIS,!this._hasDataChannelMediaSection){const c=await this._pc.createOffer(),f=s.parse(c.sdp),C=f.media.find(I=>I.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:f}),a.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c),this._remoteSdp.sendSctpAssociation({offerMediaObject:C});const T={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",T),await this._pc.setRemoteDescription(T),this._hasDataChannelMediaSection=!0}const m={streamId:y.id,ordered:y.ordered,maxPacketLifeTime:y.maxPacketLifeTime,maxRetransmits:y.maxRetransmits};return{dataChannel:w,sctpStreamParameters:m}}async receive(i){this.assertNotClosed(),this.assertRecvDirection();const n=[],o=new Map;for(const w of i){const{trackId:m,kind:c,rtpParameters:f,streamId:C}=w;a.debug("receive() [trackId:%s, kind:%s]",m,c);const T=f.mid??String(this._mapMidTransceiver.size);o.set(m,T);const{msidStreamId:I}=E.getMsidStreamIdAndTrackId(f.msid);this._remoteSdp.receive({mid:T,kind:c,offerRtpParameters:f,streamId:C??I??f.rtcp?.cname??"-",trackId:m})}const l={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",l),await this._pc.setRemoteDescription(l);let b=await this._pc.createAnswer();const y=s.parse(b.sdp);for(const w of i){const{trackId:m,rtpParameters:c}=w,f=o.get(m),C=y.media.find(T=>String(T.mid)===f);d.applyCodecParameters({offerRtpParameters:c,answerMediaObject:C})}b={type:"answer",sdp:s.write(y)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:y}),a.debug("receive() | calling pc.setLocalDescription() [answer:%o]",b),await this._pc.setLocalDescription(b);for(const w of i){const{trackId:m}=w,c=o.get(m),f=this._pc.getTransceivers().find(C=>C.mid===c);if(f)this._mapMidTransceiver.set(c,f),n.push({localId:c,track:f.receiver.track,rtpReceiver:f.receiver});else throw new Error("new RTCRtpTransceiver not found")}return n}async stopReceiving(i){if(this.assertRecvDirection(),this._closed)return;for(const l of i){a.debug("stopReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(b.mid)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);for(const l of i)this._mapMidTransceiver.delete(l)}async pauseReceiving(i){this.assertNotClosed(),this.assertRecvDirection();for(const l of i){a.debug("pauseReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");b.direction="inactive",this._remoteSdp.pauseMediaSection(l)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}async resumeReceiving(i){this.assertNotClosed(),this.assertRecvDirection();for(const l of i){a.debug("resumeReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");b.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(l)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}async getReceiverStats(i){this.assertNotClosed(),this.assertRecvDirection();const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");return n.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:i,label:n,protocol:o}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:l,ordered:b,maxPacketLifeTime:y,maxRetransmits:w}=i,m={negotiated:!0,id:l,ordered:b,maxPacketLifeTime:y,maxRetransmits:w,protocol:o};a.debug("receiveDataChannel() [options:%o]",m);const c=this._pc.createDataChannel(n,m);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const f={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",f),await this._pc.setRemoteDescription(f);const C=await this._pc.createAnswer();if(!this._transportReady){const T=s.parse(C.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:T})}a.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",C),await this._pc.setLocalDescription(C),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async setupTransport({localDtlsRole:i,localSdpObject:n}){n||(n=s.parse(this._pc.localDescription.sdp));const o=d.extractDtlsParameters({sdpObject:n});o.role=i,this._remoteSdp.updateDtlsRole(i==="client"?"server":"client"),await new Promise((l,b)=>{this.safeEmit("@connect",{dtlsParameters:o},l,b)}),this._transportReady=!0}onIceGatheringStateChange=()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)};onIceCandidateError=i=>{this.emit("@icecandidateerror",i)};onConnectionStateChange=()=>{this.emit("@connectionstatechange",this._pc.connectionState)};onIceConnectionStateChange=()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}};assertNotClosed(){if(this._closed)throw new u.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};return Ee.Chrome74=k,Ee}var Te={},_r;function bs(){if(_r)return Te;_r=1,Object.defineProperty(Te,"__esModule",{value:!0}),Te.Firefox120=void 0;const s=re(),e=z(),t=q(),r=Q(),u=X(),v=pe(),h=Fe(),d=je(),S=Be(),E=$e(),a=new t.Logger("Firefox120"),g="Firefox120",_={OS:16,MIS:2048};let k=class Ge extends e.EnhancedEventEmitter{_closed=!1;_direction;_remoteSdp;_getSendExtendedRtpCapabilities;_pc;_mapMidTransceiver=new Map;_sendStream=new MediaStream;_hasDataChannelMediaSection=!1;_nextSendSctpStreamId=0;_transportReady=!1;static createFactory(){return{name:g,factory:i=>new Ge(i),getNativeRtpCapabilities:async()=>{a.debug("getNativeRtpCapabilities()");let i=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});const n=document.createElement("canvas");n.getContext("2d");const l=n.captureStream().getVideoTracks()[0];try{i.addTransceiver("audio",{direction:"sendrecv"}),i.addTransceiver(l,{direction:"sendrecv",sendEncodings:[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}]});const b=await i.createOffer();try{n.remove()}catch{}try{l.stop()}catch{}try{i.close()}catch{}i=void 0;const y=s.parse(b.sdp);return Ge.getLocalRtpCapabilities(y)}catch(b){try{n.remove()}catch{}try{l.stop()}catch{}try{i?.close()}catch{}throw i=void 0,b}},getNativeSctpCapabilities:async()=>(a.debug("getNativeSctpCapabilities()"),{numStreams:_})}}static getLocalRtpCapabilities(i){const n=d.extractRtpCapabilities({sdpObject:i});return u.validateAndNormalizeRtpCapabilities(n),n}constructor({direction:i,iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b,iceServers:y,iceTransportPolicy:w,additionalSettings:m,getSendExtendedRtpCapabilities:c}){super(),a.debug("constructor()"),this._direction=i,this._remoteSdp=new h.RemoteSdp({iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b}),this._getSendExtendedRtpCapabilities=c,this._pc=new RTCPeerConnection({iceServers:y??[],iceTransportPolicy:w??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...m}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(a.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}get name(){return g}close(){if(a.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(i){throw this.assertNotClosed(),new r.UnsupportedError("not supported")}async restartIce(i){if(this.assertNotClosed(),a.debug("restartIce()"),this._remoteSdp.updateIceParameters(i),!!this._transportReady)if(this._direction==="send"){const n=await this._pc.createOffer({iceRestart:!0});a.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}else{const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:i,streamId:n,encodings:o,codecOptions:l,codec:b,onRtpSender:y}){this.assertNotClosed(),this.assertSendDirection(),a.debug("send() [kind:%s, track.id:%s, streamId:%s]",i.kind,i.id,n),o&&o.length>1&&o.forEach((x,L)=>{x.rid=`r${L}`});const w=this._pc.addTransceiver(i,{direction:"sendonly",streams:[this._sendStream],sendEncodings:o});y&&y(w.sender);const m=await this._pc.createOffer();let c=s.parse(m.sdp);c.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const f=Ge.getLocalRtpCapabilities(c),C=this._getSendExtendedRtpCapabilities(f),T=u.getSendingRtpParameters(i.kind,C);T.codecs=u.reduceCodecs(T.codecs,b);const I=u.getSendingRemoteRtpParameters(i.kind,C);I.codecs=u.reduceCodecs(I.codecs,b),this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:c});const M=(0,v.parse)((o??[{}])[0].scalabilityMode);a.debug("send() | calling pc.setLocalDescription() [offer:%o]",m),await this._pc.setLocalDescription(m);const p=w.mid;T.mid=p,c=s.parse(this._pc.localDescription.sdp);const P=c.media[c.media.length-1];if(T.rtcp.cname=d.getCname({offerMediaObject:P}),T.msid=`${n??this._sendStream.id} ${i.id}`,!o)T.encodings=S.getRtpEncodings({offerMediaObject:P});else if(o.length===1){const x=S.getRtpEncodings({offerMediaObject:P});Object.assign(x[0],o[0]),T.encodings=x}else T.encodings=o;if(T.encodings.length>1&&(T.codecs[0].mimeType.toLowerCase()==="video/vp8"||T.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const x of T.encodings)x.scalabilityMode?x.scalabilityMode=`L1T${M.temporalLayers}`:x.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:P,offerRtpParameters:T,answerRtpParameters:I,codecOptions:l});const D={type:"answer",sdp:this._remoteSdp.getSdp()};return a.debug("send() | calling pc.setRemoteDescription() [answer:%o]",D),await this._pc.setRemoteDescription(D),this._mapMidTransceiver.set(p,w),{localId:p,rtpParameters:T,rtpSender:w.sender}}async stopSending(i){if(this.assertSendDirection(),a.debug("stopSending() [localId:%s]",i),this._closed)return;const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated transceiver not found");n.sender.replaceTrack(null),this._pc.removeTrack(n.sender),this._remoteSdp.disableMediaSection(n.mid);const o=await this._pc.createOffer();a.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const l={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._mapMidTransceiver.delete(i)}async pauseSending(i){this.assertNotClosed(),this.assertSendDirection(),a.debug("pauseSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i);const o=await this._pc.createOffer();a.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const l={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async resumeSending(i){this.assertNotClosed(),this.assertSendDirection(),a.debug("resumeSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(i);const o=await this._pc.createOffer();a.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const l={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async replaceTrack(i,n){this.assertNotClosed(),this.assertSendDirection(),n?a.debug("replaceTrack() [localId:%s, track.id:%s]",i,n.id):a.debug("replaceTrack() [localId:%s, no track]",i);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");await o.sender.replaceTrack(n)}async setMaxSpatialLayer(i,n){this.assertNotClosed(),this.assertSendDirection(),a.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",i,n);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated transceiver not found");const l=o.sender.getParameters();l.encodings.forEach((w,m)=>{m<=n?w.active=!0:w.active=!1}),await o.sender.setParameters(l),this._remoteSdp.muxMediaSectionSimulcast(i,l.encodings);const b=await this._pc.createOffer();a.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",b),await this._pc.setLocalDescription(b);const y={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",y),await this._pc.setRemoteDescription(y)}async setRtpEncodingParameters(i,n){this.assertNotClosed(),this.assertSendDirection(),a.debug("setRtpEncodingParameters() [localId:%s, params:%o]",i,n);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");const l=o.sender.getParameters();l.encodings.forEach((w,m)=>{l.encodings[m]={...w,...n}}),await o.sender.setParameters(l),this._remoteSdp.muxMediaSectionSimulcast(i,l.encodings);const b=await this._pc.createOffer();a.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",b),await this._pc.setLocalDescription(b);const y={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",y),await this._pc.setRemoteDescription(y)}async getSenderStats(i){this.assertNotClosed(),this.assertSendDirection();const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");return n.sender.getStats()}async sendDataChannel({ordered:i,maxPacketLifeTime:n,maxRetransmits:o,label:l,protocol:b}){this.assertNotClosed(),this.assertSendDirection();const y={negotiated:!0,id:this._nextSendSctpStreamId,ordered:i,maxPacketLifeTime:n,maxRetransmits:o,protocol:b};a.debug("sendDataChannel() [options:%o]",y);const w=this._pc.createDataChannel(l,y);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%_.MIS,!this._hasDataChannelMediaSection){const c=await this._pc.createOffer(),f=s.parse(c.sdp),C=f.media.find(I=>I.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:f}),a.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c),this._remoteSdp.sendSctpAssociation({offerMediaObject:C});const T={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",T),await this._pc.setRemoteDescription(T),this._hasDataChannelMediaSection=!0}const m={streamId:y.id,ordered:y.ordered,maxPacketLifeTime:y.maxPacketLifeTime,maxRetransmits:y.maxRetransmits};return{dataChannel:w,sctpStreamParameters:m}}async receive(i){this.assertNotClosed(),this.assertRecvDirection();const n=[],o=new Map;for(const w of i){const{trackId:m,kind:c,rtpParameters:f,streamId:C}=w;a.debug("receive() [trackId:%s, kind:%s]",m,c);const T=f.mid??String(this._mapMidTransceiver.size);o.set(m,T);const{msidStreamId:I}=E.getMsidStreamIdAndTrackId(f.msid);this._remoteSdp.receive({mid:T,kind:c,offerRtpParameters:f,streamId:C??I??f.rtcp?.cname??"-",trackId:m})}const l={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",l),await this._pc.setRemoteDescription(l);for(const w of i){const{trackId:m,onRtpReceiver:c}=w;if(c){const f=o.get(m),C=this._pc.getTransceivers().find(T=>T.mid===f);if(!C)throw new Error("transceiver not found");c(C.receiver)}}let b=await this._pc.createAnswer();const y=s.parse(b.sdp);for(const w of i){const{trackId:m,rtpParameters:c}=w,f=o.get(m),C=y.media.find(T=>String(T.mid)===f);d.applyCodecParameters({offerRtpParameters:c,answerMediaObject:C}),b={type:"answer",sdp:s.write(y)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:y}),a.debug("receive() | calling pc.setLocalDescription() [answer:%o]",b),await this._pc.setLocalDescription(b);for(const w of i){const{trackId:m}=w,c=o.get(m),f=this._pc.getTransceivers().find(C=>C.mid===c);if(!f)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(c,f),n.push({localId:c,track:f.receiver.track,rtpReceiver:f.receiver})}return n}async stopReceiving(i){if(this.assertRecvDirection(),this._closed)return;for(const l of i){a.debug("stopReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(b.mid)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);for(const l of i)this._mapMidTransceiver.delete(l)}async pauseReceiving(i){this.assertNotClosed(),this.assertRecvDirection();for(const l of i){a.debug("pauseReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");b.direction="inactive",this._remoteSdp.pauseMediaSection(l)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}async resumeReceiving(i){this.assertNotClosed(),this.assertRecvDirection();for(const l of i){a.debug("resumeReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");b.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(l)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}async getReceiverStats(i){this.assertRecvDirection();const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");return n.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:i,label:n,protocol:o}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:l,ordered:b,maxPacketLifeTime:y,maxRetransmits:w}=i,m={negotiated:!0,id:l,ordered:b,maxPacketLifeTime:y,maxRetransmits:w,protocol:o};a.debug("receiveDataChannel() [options:%o]",m);const c=this._pc.createDataChannel(n,m);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const f={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",f),await this._pc.setRemoteDescription(f);const C=await this._pc.createAnswer();if(!this._transportReady){const T=s.parse(C.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:T})}a.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",C),await this._pc.setLocalDescription(C),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async setupTransport({localDtlsRole:i,localSdpObject:n}){n||(n=s.parse(this._pc.localDescription.sdp));const o=d.extractDtlsParameters({sdpObject:n});o.role=i,this._remoteSdp.updateDtlsRole(i==="client"?"server":"client"),await new Promise((l,b)=>{this.safeEmit("@connect",{dtlsParameters:o},l,b)}),this._transportReady=!0}onIceGatheringStateChange=()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)};onIceCandidateError=i=>{this.emit("@icecandidateerror",i)};onConnectionStateChange=()=>{this.emit("@connectionstatechange",this._pc.connectionState)};onIceConnectionStateChange=()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}};assertNotClosed(){if(this._closed)throw new r.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};return Te.Firefox120=k,Te}var ke={},vr;function Ss(){if(vr)return ke;vr=1,Object.defineProperty(ke,"__esModule",{value:!0}),ke.Safari12=void 0;const s=re(),e=z(),t=q(),r=X(),u=Q(),v=pe(),h=Fe(),d=je(),S=Be(),E=$e(),a=new t.Logger("Safari12"),g="Safari12",_={OS:1024,MIS:1024};let k=class Ye extends e.EnhancedEventEmitter{_closed=!1;_direction;_remoteSdp;_getSendExtendedRtpCapabilities;_forcedLocalDtlsRole;_pc;_mapMidTransceiver=new Map;_sendStream=new MediaStream;_hasDataChannelMediaSection=!1;_nextSendSctpStreamId=0;_transportReady=!1;static createFactory(){return{name:g,factory:i=>new Ye(i),getNativeRtpCapabilities:async()=>{a.debug("getNativeRtpCapabilities()");let i=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{i.addTransceiver("audio"),i.addTransceiver("video");const n=await i.createOffer();try{i.close()}catch{}i=void 0;const o=s.parse(n.sdp);return Ye.getLocalRtpCapabilities(o)}catch(n){try{i?.close()}catch{}throw i=void 0,n}},getNativeSctpCapabilities:async()=>(a.debug("getNativeSctpCapabilities()"),{numStreams:_})}}static getLocalRtpCapabilities(i,n=[]){const o=d.extractRtpCapabilities({sdpObject:i});r.validateAndNormalizeRtpCapabilities(o),E.addNackSupportForOpus(o);for(const l of n)E.addHeaderExtensionSupport(o,l);return o}constructor({direction:i,iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b,iceServers:y,iceTransportPolicy:w,additionalSettings:m,getSendExtendedRtpCapabilities:c}){super(),a.debug("constructor()"),this._direction=i,this._remoteSdp=new h.RemoteSdp({iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b}),this._getSendExtendedRtpCapabilities=c,l.role&&l.role!=="auto"&&(this._forcedLocalDtlsRole=l.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:y??[],iceTransportPolicy:w??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...m}),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",f=>{this.emit("@icecandidateerror",f)}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(a.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}get name(){return g}close(){if(a.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(i){this.assertNotClosed(),a.debug("updateIceServers()");const n=this._pc.getConfiguration();n.iceServers=i,this._pc.setConfiguration(n)}async restartIce(i){if(this.assertNotClosed(),a.debug("restartIce()"),this._remoteSdp.updateIceParameters(i),!!this._transportReady)if(this._direction==="send"){const n=await this._pc.createOffer({iceRestart:!0});a.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}else{const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:i,streamId:n,encodings:o,codecOptions:l,headerExtensionOptions:b,codec:y,onRtpSender:w}){this.assertNotClosed(),this.assertSendDirection(),a.debug("send() [kind:%s, track.id:%s, streamId:%s]",i.kind,i.id,n);const m=this._remoteSdp.getNextMediaSectionIdx(),c=this._pc.addTransceiver(i,{direction:"sendonly",streams:[this._sendStream]});w&&w(c.sender);let f=await this._pc.createOffer(),C=s.parse(f.sdp);C.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const T=[];T.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:i.kind,direction:"sendonly"});const I=Ye.getLocalRtpCapabilities(C,T),M=this._getSendExtendedRtpCapabilities(I),p=r.getSendingRtpParameters(i.kind,M);p.codecs=r.reduceCodecs(p.codecs,y);const P=r.getSendingRemoteRtpParameters(i.kind,M);P.codecs=r.reduceCodecs(P.codecs,y);let D;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:C});const x=(0,v.parse)((o??[{}])[0].scalabilityMode);o&&o.length>1&&(a.debug("send() | enabling legacy simulcast"),C=s.parse(f.sdp),D=C.media[m.idx],S.addLegacySimulcast({offerMediaObject:D,numStreams:o.length}),f={type:"offer",sdp:s.write(C)}),b?.absCaptureTime&&(D=C.media[m.idx],d.addHeaderExtension({offerMediaObject:D,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:P.headerExtensions.find(A=>A.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),f={type:"offer",sdp:s.write(C)}),a.debug("send() | calling pc.setLocalDescription() [offer:%o]",f),await this._pc.setLocalDescription(f);const L=c.mid;if(p.mid=L,C=s.parse(this._pc.localDescription.sdp),D=C.media[m.idx],p.rtcp.cname=d.getCname({offerMediaObject:D}),p.msid=`${n??this._sendStream.id} ${i.id}`,p.encodings=S.getRtpEncodings({offerMediaObject:D}),o)for(let A=0;A<p.encodings.length;++A)o[A]&&Object.assign(p.encodings[A],o[A]);if(p.encodings.length>1&&(p.codecs[0].mimeType.toLowerCase()==="video/vp8"||p.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const A of p.encodings)A.scalabilityMode?A.scalabilityMode=`L1T${x.temporalLayers}`:A.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:D,reuseMid:m.reuseMid,offerRtpParameters:p,answerRtpParameters:P,codecOptions:l});const O={type:"answer",sdp:this._remoteSdp.getSdp()};return a.debug("send() | calling pc.setRemoteDescription() [answer:%o]",O),await this._pc.setRemoteDescription(O),this._mapMidTransceiver.set(L,c),{localId:L,rtpParameters:p,rtpSender:c.sender}}async stopSending(i){if(this.assertSendDirection(),this._closed)return;a.debug("stopSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");if(n.sender.replaceTrack(null),this._pc.removeTrack(n.sender),this._remoteSdp.closeMediaSection(n.mid))try{n.stop()}catch{}const l=await this._pc.createOffer();a.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);const b={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",b),await this._pc.setRemoteDescription(b),this._mapMidTransceiver.delete(i)}async pauseSending(i){this.assertNotClosed(),this.assertSendDirection(),a.debug("pauseSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i);const o=await this._pc.createOffer();a.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const l={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async resumeSending(i){this.assertNotClosed(),this.assertSendDirection(),a.debug("resumeSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(i);const o=await this._pc.createOffer();a.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const l={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async replaceTrack(i,n){this.assertNotClosed(),this.assertSendDirection(),n?a.debug("replaceTrack() [localId:%s, track.id:%s]",i,n.id):a.debug("replaceTrack() [localId:%s, no track]",i);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");await o.sender.replaceTrack(n)}async setMaxSpatialLayer(i,n){this.assertNotClosed(),this.assertSendDirection(),a.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",i,n);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");const l=o.sender.getParameters();l.encodings.forEach((w,m)=>{m<=n?w.active=!0:w.active=!1}),await o.sender.setParameters(l),this._remoteSdp.muxMediaSectionSimulcast(i,l.encodings);const b=await this._pc.createOffer();a.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",b),await this._pc.setLocalDescription(b);const y={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",y),await this._pc.setRemoteDescription(y)}async setRtpEncodingParameters(i,n){this.assertNotClosed(),this.assertSendDirection(),a.debug("setRtpEncodingParameters() [localId:%s, params:%o]",i,n);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");const l=o.sender.getParameters();l.encodings.forEach((w,m)=>{l.encodings[m]={...w,...n}}),await o.sender.setParameters(l),this._remoteSdp.muxMediaSectionSimulcast(i,l.encodings);const b=await this._pc.createOffer();a.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",b),await this._pc.setLocalDescription(b);const y={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",y),await this._pc.setRemoteDescription(y)}async getSenderStats(i){this.assertNotClosed(),this.assertSendDirection();const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");return n.sender.getStats()}async sendDataChannel({ordered:i,maxPacketLifeTime:n,maxRetransmits:o,label:l,protocol:b}){this.assertNotClosed(),this.assertSendDirection();const y={negotiated:!0,id:this._nextSendSctpStreamId,ordered:i,maxPacketLifeTime:n,maxRetransmits:o,protocol:b};a.debug("sendDataChannel() [options:%o]",y);const w=this._pc.createDataChannel(l,y);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%_.MIS,!this._hasDataChannelMediaSection){const c=await this._pc.createOffer(),f=s.parse(c.sdp),C=f.media.find(I=>I.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:f}),a.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c),this._remoteSdp.sendSctpAssociation({offerMediaObject:C});const T={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",T),await this._pc.setRemoteDescription(T),this._hasDataChannelMediaSection=!0}const m={streamId:y.id,ordered:y.ordered,maxPacketLifeTime:y.maxPacketLifeTime,maxRetransmits:y.maxRetransmits};return{dataChannel:w,sctpStreamParameters:m}}async receive(i){this.assertNotClosed(),this.assertRecvDirection();const n=[],o=new Map;for(const w of i){const{trackId:m,kind:c,rtpParameters:f,streamId:C}=w;a.debug("receive() [trackId:%s, kind:%s]",m,c);const T=f.mid??String(this._mapMidTransceiver.size);o.set(m,T);const{msidStreamId:I}=E.getMsidStreamIdAndTrackId(f.msid);this._remoteSdp.receive({mid:T,kind:c,offerRtpParameters:f,streamId:C??I??f.rtcp?.cname??"-",trackId:m})}const l={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",l),await this._pc.setRemoteDescription(l);for(const w of i){const{trackId:m,onRtpReceiver:c}=w;if(c){const f=o.get(m),C=this._pc.getTransceivers().find(T=>T.mid===f);if(!C)throw new Error("transceiver not found");c(C.receiver)}}let b=await this._pc.createAnswer();const y=s.parse(b.sdp);for(const w of i){const{trackId:m,rtpParameters:c}=w,f=o.get(m),C=y.media.find(T=>String(T.mid)===f);d.applyCodecParameters({offerRtpParameters:c,answerMediaObject:C})}b={type:"answer",sdp:s.write(y)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:y}),a.debug("receive() | calling pc.setLocalDescription() [answer:%o]",b),await this._pc.setLocalDescription(b);for(const w of i){const{trackId:m}=w,c=o.get(m),f=this._pc.getTransceivers().find(C=>C.mid===c);if(!f)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(c,f),n.push({localId:c,track:f.receiver.track,rtpReceiver:f.receiver})}return n}async stopReceiving(i){if(this.assertRecvDirection(),this._closed)return;for(const l of i){a.debug("stopReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(b.mid)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);for(const l of i)this._mapMidTransceiver.delete(l)}async pauseReceiving(i){this.assertNotClosed(),this.assertRecvDirection();for(const l of i){a.debug("pauseReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");b.direction="inactive",this._remoteSdp.pauseMediaSection(l)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}async resumeReceiving(i){this.assertNotClosed(),this.assertRecvDirection();for(const l of i){a.debug("resumeReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");b.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(l)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}async getReceiverStats(i){this.assertNotClosed(),this.assertRecvDirection();const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");return n.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:i,label:n,protocol:o}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:l,ordered:b,maxPacketLifeTime:y,maxRetransmits:w}=i,m={negotiated:!0,id:l,ordered:b,maxPacketLifeTime:y,maxRetransmits:w,protocol:o};a.debug("receiveDataChannel() [options:%o]",m);const c=this._pc.createDataChannel(n,m);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const f={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",f),await this._pc.setRemoteDescription(f);const C=await this._pc.createAnswer();if(!this._transportReady){const T=s.parse(C.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:T})}a.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",C),await this._pc.setLocalDescription(C),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async setupTransport({localDtlsRole:i,localSdpObject:n}){n||(n=s.parse(this._pc.localDescription.sdp));const o=d.extractDtlsParameters({sdpObject:n});o.role=i,this._remoteSdp.updateDtlsRole(i==="client"?"server":"client"),await new Promise((l,b)=>{this.safeEmit("@connect",{dtlsParameters:o},l,b)}),this._transportReady=!0}onIceGatheringStateChange=()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)};onIceCandidateError=i=>{this.emit("@icecandidateerror",i)};onConnectionStateChange=()=>{this.emit("@connectionstatechange",this._pc.connectionState)};onIceConnectionStateChange=()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}};assertNotClosed(){if(this._closed)throw new u.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};return ke.Safari12=k,ke}var xe={},yr;function Cs(){if(yr)return xe;yr=1,Object.defineProperty(xe,"__esModule",{value:!0}),xe.ReactNative106=void 0;const s=re(),e=z(),t=q(),r=X(),u=Q(),v=pe(),h=Fe(),d=je(),S=Be(),E=$e(),a=new t.Logger("ReactNative106"),g="ReactNative106",_={OS:1024,MIS:1024};let k=class Je extends e.EnhancedEventEmitter{_closed=!1;_direction;_remoteSdp;_getSendExtendedRtpCapabilities;_forcedLocalDtlsRole;_pc;_mapMidTransceiver=new Map;_sendStream=new MediaStream;_hasDataChannelMediaSection=!1;_nextSendSctpStreamId=0;_transportReady=!1;static createFactory(){return{name:g,factory:i=>new Je(i),getNativeRtpCapabilities:async()=>{a.debug("getNativeRtpCapabilities()");let i=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{i.addTransceiver("audio"),i.addTransceiver("video");const n=await i.createOffer();try{i.close()}catch{}i=void 0;const o=s.parse(n.sdp);return Je.getLocalRtpCapabilities(o)}catch(n){try{i?.close()}catch{}throw i=void 0,n}},getNativeSctpCapabilities:async()=>(a.debug("getNativeSctpCapabilities()"),{numStreams:_})}}static getLocalRtpCapabilities(i,n=[]){const o=d.extractRtpCapabilities({sdpObject:i});r.validateAndNormalizeRtpCapabilities(o),E.addNackSupportForOpus(o);for(const l of n)E.addHeaderExtensionSupport(o,l);return o}constructor({direction:i,iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b,iceServers:y,iceTransportPolicy:w,additionalSettings:m,getSendExtendedRtpCapabilities:c}){super(),a.debug("constructor()"),this._direction=i,this._remoteSdp=new h.RemoteSdp({iceParameters:n,iceCandidates:o,dtlsParameters:l,sctpParameters:b}),this._getSendExtendedRtpCapabilities=c,l.role&&l.role!=="auto"&&(this._forcedLocalDtlsRole=l.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:y??[],iceTransportPolicy:w??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...m}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(a.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}get name(){return g}close(){if(a.debug("close()"),!this._closed){this._closed=!0,this._sendStream.release(!1);try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(i){this.assertNotClosed(),a.debug("updateIceServers()");const n=this._pc.getConfiguration();n.iceServers=i,this._pc.setConfiguration(n)}async restartIce(i){if(this.assertNotClosed(),a.debug("restartIce()"),this._remoteSdp.updateIceParameters(i),!!this._transportReady)if(this._direction==="send"){const n=await this._pc.createOffer({iceRestart:!0});a.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}else{const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:i,streamId:n,encodings:o,codecOptions:l,headerExtensionOptions:b,codec:y,onRtpSender:w}){this.assertNotClosed(),this.assertSendDirection(),a.debug("send() [kind:%s, track.id:%s, streamId:%s]",i.kind,i.id,n),o&&o.length>1&&o.forEach((N,ae)=>{N.rid=`r${ae}`});const m=this._remoteSdp.getNextMediaSectionIdx(),c=this._pc.addTransceiver(i,{direction:"sendonly",streams:[this._sendStream],sendEncodings:o});w&&w(c.sender);let f=await this._pc.createOffer(),C=s.parse(f.sdp);C.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const T=[];T.push({uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",kind:i.kind,direction:"sendonly"});const I=Je.getLocalRtpCapabilities(C,T),M=this._getSendExtendedRtpCapabilities(I),p=r.getSendingRtpParameters(i.kind,M);p.codecs=r.reduceCodecs(p.codecs,y);const P=r.getSendingRemoteRtpParameters(i.kind,M);P.codecs=r.reduceCodecs(P.codecs,y),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:C});let D=!1;const x=(0,v.parse)((o??[{}])[0].scalabilityMode);let L;o?.length===1&&x.spatialLayers>1&&p.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(a.debug("send() | enabling legacy simulcast for VP9 SVC"),D=!0,C=s.parse(f.sdp),L=C.media[m.idx],S.addLegacySimulcast({offerMediaObject:L,numStreams:x.spatialLayers}),f={type:"offer",sdp:s.write(C)}),b?.absCaptureTime&&(L=C.media[m.idx],d.addHeaderExtension({offerMediaObject:L,headerExtensionUri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",headerExtensionId:P.headerExtensions.find(N=>N.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time").id}),f={type:"offer",sdp:s.write(C)}),a.debug("send() | calling pc.setLocalDescription() [offer:%o]",f),await this._pc.setLocalDescription(f);let O=c.mid??void 0;if(O||a.warn("send() | missing transceiver.mid (bug in react-native-webrtc, using a workaround"),p.mid=O,C=s.parse(this._pc.localDescription.sdp),L=C.media[m.idx],p.rtcp.cname=d.getCname({offerMediaObject:L}),p.msid=`${n??this._sendStream.id} ${i.id}`,!o)p.encodings=S.getRtpEncodings({offerMediaObject:L});else if(o.length===1){let N=S.getRtpEncodings({offerMediaObject:L});Object.assign(N[0],o[0]),D&&(N=[N[0]]),p.encodings=N}else p.encodings=o;if(p.encodings.length>1&&(p.codecs[0].mimeType.toLowerCase()==="video/vp8"||p.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const N of p.encodings)N.scalabilityMode?N.scalabilityMode=`L1T${x.temporalLayers}`:N.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:L,reuseMid:m.reuseMid,offerRtpParameters:p,answerRtpParameters:P,codecOptions:l});const A={type:"answer",sdp:this._remoteSdp.getSdp()};return a.debug("send() | calling pc.setRemoteDescription() [answer:%o]",A),await this._pc.setRemoteDescription(A),O||(O=c.mid,p.mid=O),this._mapMidTransceiver.set(O,c),{localId:O,rtpParameters:p,rtpSender:c.sender}}async stopSending(i){if(this.assertSendDirection(),this._closed)return;a.debug("stopSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");if(n.sender.replaceTrack(null),this._pc.removeTrack(n.sender),this._remoteSdp.closeMediaSection(n.mid))try{n.stop()}catch{}const l=await this._pc.createOffer();a.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);const b={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",b),await this._pc.setRemoteDescription(b),this._mapMidTransceiver.delete(i)}async pauseSending(i){this.assertNotClosed(),this.assertSendDirection(),a.debug("pauseSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i);const o=await this._pc.createOffer();a.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const l={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async resumeSending(i){this.assertNotClosed(),this.assertSendDirection(),a.debug("resumeSending() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(this._remoteSdp.resumeSendingMediaSection(i),!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="sendonly";const o=await this._pc.createOffer();a.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const l={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l)}async replaceTrack(i,n){this.assertNotClosed(),this.assertSendDirection(),n?a.debug("replaceTrack() [localId:%s, track.id:%s]",i,n.id):a.debug("replaceTrack() [localId:%s, no track]",i);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");await o.sender.replaceTrack(n)}async setMaxSpatialLayer(i,n){this.assertNotClosed(),this.assertSendDirection(),a.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",i,n);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");const l=o.sender.getParameters();l.encodings.forEach((w,m)=>{m<=n?w.active=!0:w.active=!1}),await o.sender.setParameters(l),this._remoteSdp.muxMediaSectionSimulcast(i,l.encodings);const b=await this._pc.createOffer();a.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",b),await this._pc.setLocalDescription(b);const y={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",y),await this._pc.setRemoteDescription(y)}async setRtpEncodingParameters(i,n){this.assertNotClosed(),this.assertSendDirection(),a.debug("setRtpEncodingParameters() [localId:%s, params:%o]",i,n);const o=this._mapMidTransceiver.get(i);if(!o)throw new Error("associated RTCRtpTransceiver not found");const l=o.sender.getParameters();l.encodings.forEach((w,m)=>{l.encodings[m]={...w,...n}}),await o.sender.setParameters(l),this._remoteSdp.muxMediaSectionSimulcast(i,l.encodings);const b=await this._pc.createOffer();a.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",b),await this._pc.setLocalDescription(b);const y={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",y),await this._pc.setRemoteDescription(y)}async getSenderStats(i){this.assertNotClosed(),this.assertSendDirection();const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");return n.sender.getStats()}async sendDataChannel({ordered:i,maxPacketLifeTime:n,maxRetransmits:o,label:l,protocol:b}){this.assertNotClosed(),this.assertSendDirection();const y={negotiated:!0,id:this._nextSendSctpStreamId,ordered:i,maxPacketLifeTime:n,maxRetransmits:o,protocol:b};a.debug("sendDataChannel() [options:%o]",y);const w=this._pc.createDataChannel(l,y);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%_.MIS,!this._hasDataChannelMediaSection){const c=await this._pc.createOffer(),f=s.parse(c.sdp),C=f.media.find(I=>I.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:f}),a.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c),this._remoteSdp.sendSctpAssociation({offerMediaObject:C});const T={type:"answer",sdp:this._remoteSdp.getSdp()};a.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",T),await this._pc.setRemoteDescription(T),this._hasDataChannelMediaSection=!0}const m={streamId:y.id,ordered:y.ordered,maxPacketLifeTime:y.maxPacketLifeTime,maxRetransmits:y.maxRetransmits};return{dataChannel:w,sctpStreamParameters:m}}async receive(i){this.assertNotClosed(),this.assertRecvDirection();const n=[],o=new Map;for(const w of i){const{trackId:m,kind:c,rtpParameters:f,streamId:C}=w;a.debug("receive() [trackId:%s, kind:%s]",m,c);const T=f.mid??String(this._mapMidTransceiver.size);o.set(m,T);const{msidStreamId:I}=E.getMsidStreamIdAndTrackId(f.msid);this._remoteSdp.receive({mid:T,kind:c,offerRtpParameters:f,streamId:C??I??f.rtcp?.cname??"-",trackId:m})}const l={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",l),await this._pc.setRemoteDescription(l);for(const w of i){const{trackId:m,onRtpReceiver:c}=w;if(c){const f=o.get(m),C=this._pc.getTransceivers().find(T=>T.mid===f);if(!C)throw new Error("transceiver not found");c(C.receiver)}}let b=await this._pc.createAnswer();const y=s.parse(b.sdp);for(const w of i){const{trackId:m,rtpParameters:c}=w,f=o.get(m),C=y.media.find(T=>String(T.mid)===f);d.applyCodecParameters({offerRtpParameters:c,answerMediaObject:C})}b={type:"answer",sdp:s.write(y)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:y}),a.debug("receive() | calling pc.setLocalDescription() [answer:%o]",b),await this._pc.setLocalDescription(b);for(const w of i){const{trackId:m}=w,c=o.get(m),f=this._pc.getTransceivers().find(C=>C.mid===c);if(f)this._mapMidTransceiver.set(c,f),n.push({localId:c,track:f.receiver.track,rtpReceiver:f.receiver});else throw new Error("new RTCRtpTransceiver not found")}return n}async stopReceiving(i){if(this.assertRecvDirection(),this._closed)return;for(const l of i){a.debug("stopReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(b.mid)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);for(const l of i)this._mapMidTransceiver.delete(l)}async pauseReceiving(i){this.assertNotClosed(),this.assertRecvDirection();for(const l of i){a.debug("pauseReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");b.direction="inactive",this._remoteSdp.pauseMediaSection(l)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}async resumeReceiving(i){this.assertNotClosed(),this.assertRecvDirection();for(const l of i){a.debug("resumeReceiving() [localId:%s]",l);const b=this._mapMidTransceiver.get(l);if(!b)throw new Error("associated RTCRtpTransceiver not found");b.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(l)}const n={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);const o=await this._pc.createAnswer();a.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o)}async getReceiverStats(i){this.assertNotClosed(),this.assertRecvDirection();const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");return n.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:i,label:n,protocol:o}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:l,ordered:b,maxPacketLifeTime:y,maxRetransmits:w}=i,m={negotiated:!0,id:l,ordered:b,maxPacketLifeTime:y,maxRetransmits:w,protocol:o};a.debug("receiveDataChannel() [options:%o]",m);const c=this._pc.createDataChannel(n,m);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const f={type:"offer",sdp:this._remoteSdp.getSdp()};a.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",f),await this._pc.setRemoteDescription(f);const C=await this._pc.createAnswer();if(!this._transportReady){const T=s.parse(C.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:T})}a.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",C),await this._pc.setLocalDescription(C),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async setupTransport({localDtlsRole:i,localSdpObject:n}){n||(n=s.parse(this._pc.localDescription.sdp));const o=d.extractDtlsParameters({sdpObject:n});o.role=i,this._remoteSdp.updateDtlsRole(i==="client"?"server":"client"),await new Promise((l,b)=>{this.safeEmit("@connect",{dtlsParameters:o},l,b)}),this._transportReady=!0}onIceGatheringStateChange=()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)};onIceCandidateError=i=>{this.emit("@icecandidateerror",i)};onConnectionStateChange=()=>{this.emit("@connectionstatechange",this._pc.connectionState)};onIceConnectionStateChange=()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}};assertNotClosed(){if(this._closed)throw new u.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};return xe.ReactNative106=k,xe}var wr;function Rs(){if(wr)return se;wr=1,Object.defineProperty(se,"__esModule",{value:!0}),se.Device=void 0,se.detectDevice=_,se.detectDeviceAsync=k;const s=q(),e=z(),t=Q(),r=de(),u=X(),v=ms(),h=ys(),d=ws(),S=bs(),E=Ss(),a=Cs(),g=new s.Logger("Device");function _(m,c){return g.debug("detectDevice()"),!m&&typeof navigator=="object"&&(m=navigator.userAgent),!c&&typeof navigator=="object"&&(c=navigator.userAgentData),i(m,c)}async function k(m,c){return g.debug("detectDeviceAsync()"),!m&&typeof navigator=="object"&&(m=navigator.userAgent),!c&&typeof navigator=="object"&&(c=navigator.userAgentData),i(m,c)}let R=class Fr{_handlerFactory;_handlerName;_loaded=!1;_getSendExtendedRtpCapabilities;_recvRtpCapabilities;_canProduceByKind={audio:!1,video:!1};_sctpCapabilities;_observer=new e.EnhancedEventEmitter;static async factory({handlerName:c,handlerFactory:f}={}){if(g.debug("factory()"),c&&f)throw new TypeError("just one of handlerName or handlerInterface can be given");if(!c&&!f&&(c=await k(),!c))throw new t.UnsupportedError("device not supported");return new Fr({handlerName:c,handlerFactory:f})}constructor({handlerName:c,handlerFactory:f}={}){if(g.debug("constructor()"),c&&f)throw new TypeError("just one of handlerName or handlerInterface can be given");if(f)this._handlerFactory=f;else{if(c)g.debug("constructor() | handler given: %s",c);else if(c=_(),c)g.debug("constructor() | detected handler: %s",c);else throw new t.UnsupportedError("device not supported");switch(c){case"Chrome111":{this._handlerFactory=h.Chrome111.createFactory();break}case"Chrome74":{this._handlerFactory=d.Chrome74.createFactory();break}case"Firefox120":{this._handlerFactory=S.Firefox120.createFactory();break}case"Safari12":{this._handlerFactory=E.Safari12.createFactory();break}case"ReactNative106":{this._handlerFactory=a.ReactNative106.createFactory();break}default:throw new TypeError(`unknown handlerName "${c}"`)}}this._handlerName=this._handlerFactory.name}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new t.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new t.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:c,preferLocalCodecsOrder:f=!1}){if(g.debug("load() [routerRtpCapabilities:%o]",c),this._loaded)throw new t.InvalidStateError("already loaded");const C=r.clone(c);u.validateAndNormalizeRtpCapabilities(C);const{getNativeRtpCapabilities:T,getNativeSctpCapabilities:I}=this._handlerFactory,M=r.clone(await T());u.validateAndNormalizeRtpCapabilities(M),g.debug("load() | got native RTP capabilities:%o",M),this._getSendExtendedRtpCapabilities=P=>r.clone(u.getExtendedRtpCapabilities(P,C,f));const p=u.getExtendedRtpCapabilities(M,C,!1);this._recvRtpCapabilities=u.getRecvRtpCapabilities(p),u.validateAndNormalizeRtpCapabilities(this._recvRtpCapabilities),g.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._canProduceByKind.audio=u.canSend("audio",this._recvRtpCapabilities),this._canProduceByKind.video=u.canSend("video",this._recvRtpCapabilities),this._sctpCapabilities=await I(),u.validateSctpCapabilities(this._sctpCapabilities),g.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),g.debug("load() succeeded"),this._loaded=!0}canProduce(c){if(this._loaded){if(c!=="audio"&&c!=="video")throw new TypeError(`invalid kind "${c}"`)}else throw new t.InvalidStateError("not loaded");return this._canProduceByKind[c]}createSendTransport({id:c,iceParameters:f,iceCandidates:C,dtlsParameters:T,sctpParameters:I,iceServers:M,iceTransportPolicy:p,additionalSettings:P,appData:D}){return g.debug("createSendTransport()"),this.createTransport({direction:"send",id:c,iceParameters:f,iceCandidates:C,dtlsParameters:T,sctpParameters:I,iceServers:M,iceTransportPolicy:p,additionalSettings:P,appData:D})}createRecvTransport({id:c,iceParameters:f,iceCandidates:C,dtlsParameters:T,sctpParameters:I,iceServers:M,iceTransportPolicy:p,additionalSettings:P,appData:D}){return g.debug("createRecvTransport()"),this.createTransport({direction:"recv",id:c,iceParameters:f,iceCandidates:C,dtlsParameters:T,sctpParameters:I,iceServers:M,iceTransportPolicy:p,additionalSettings:P,appData:D})}createTransport({direction:c,id:f,iceParameters:C,iceCandidates:T,dtlsParameters:I,sctpParameters:M,iceServers:p,iceTransportPolicy:P,additionalSettings:D,appData:x}){if(this._loaded){if(typeof f!="string")throw new TypeError("missing id");if(typeof C!="object")throw new TypeError("missing iceParameters");if(Array.isArray(T)){if(typeof I!="object")throw new TypeError("missing dtlsParameters");if(M&&typeof M!="object")throw new TypeError("wrong sctpParameters");if(x&&typeof x!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new t.InvalidStateError("not loaded");const L=new v.Transport({direction:c,id:f,iceParameters:C,iceCandidates:T,dtlsParameters:I,sctpParameters:M,iceServers:p,iceTransportPolicy:P,additionalSettings:D,appData:x,handlerFactory:this._handlerFactory,getSendExtendedRtpCapabilities:this._getSendExtendedRtpCapabilities,recvRtpCapabilities:this._recvRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",L),L}};se.Device=R;function i(m,c){g.debug('detectDeviceImpl() [userAgent:"%s", userAgentData:%o]',m,c);const f=n(m,c);if(f){if(f>=111)return g.debug("detectDeviceImpl() | using Chrome111 handler"),"Chrome111";if(f>=74)return g.debug("detectDeviceImpl() | using Chrome74 handler"),"Chrome74";g.warn("detectDeviceImpl() | unsupported Chromium based browser/version");return}const C=o(m);if(C){if(C>=120)return g.debug("detectDeviceImpl() | using Firefox120 handler"),"Firefox120";g.warn("detectDeviceImpl() | unsupported Firefox browser/version");return}const T=l(m);if(T){if(T>=605)return g.debug("detectDeviceImpl() | using Safari12 handler"),"Safari12";g.warn("detectDeviceImpl() | unsupported desktop Safari browser/version");return}const I=b(m);if(I){if(I>=605)return g.debug("detectDeviceImpl() | using Safari12 handler"),"Safari12";g.warn("detectDeviceImpl() | unsupported iOS Safari based browser/version");return}if(w()){if(typeof RTCPeerConnection<"u"&&typeof RTCRtpTransceiver<"u")return g.debug("detectDeviceImpl() | using ReactNative106 handler"),"ReactNative106";g.warn("detectDeviceImpl() | unsupported react-native-webrtc version without RTCPeerConnection or RTCRtpTransceiver, forgot to call registerGlobals() on it?");return}g.warn('detectDeviceImpl() | device not supported [userAgent:"%s", userAgentData:%o]',m,c)}function n(m,c){if(g.debug("getChromiumMajorVersion()"),y(m,c)){g.debug("getChromiumMajorVersion() | this is iOS => undefined");return}if(w()){g.debug("getChromiumMajorVersion() | this is React-Native => undefined");return}if(c){const C=(c.brands??[]).find(T=>T.brand==="Chromium");if(C){const T=Number(C.version);return g.debug(`getChromiumMajorVersion() | Chromium major version based on NavigatorUAData => ${T}`),T}}const f=m?.match(/\b(?:Chrome|Chromium)\/(\w+)/i);if(f?.[1]){const C=Number(f[1]);return g.debug(`getChromiumMajorVersion() | Chromium major version based on User-Agent => ${C}`),C}g.debug("getChromiumMajorVersion() | this is not Chromium => undefined")}function o(m){if(g.debug("getFirefoxMajorVersion()"),y(m)){g.debug("getFirefoxMajorVersion() | this is iOS => undefined");return}if(w()){g.debug("getFirefoxMajorVersion() | this is React-Native => undefined");return}const c=m?.match(/\bFirefox\/(\w+)/i);if(c?.[1]){const f=Number(c[1]);return g.debug(`getFirefoxMajorVersion() | Firefox major version based on User-Agent => ${f}`),f}g.debug("getFirefoxMajorVersion() | this is not Firefox => undefined")}function l(m){if(g.debug("getMacOSWebKitMajorVersion()"),y(m)){g.debug("getMacOSWebKitMajorVersion() | this is iOS => undefined");return}if(w()){g.debug("getMacOSWebKitMajorVersion() | this is React-Native => undefined");return}if(!(m&&/\bSafari\b/i.test(m)&&!/\bChrome\b/i.test(m)&&!/\bChromium\b/i.test(m)&&!/\bFirefox\b/i.test(m))){g.debug("getMacOSWebKitMajorVersion() | this is not Safari => undefined");return}const f=m.match(/AppleWebKit\/(\w+)/i);if(f?.[1]){const C=Number(f[1]);return g.debug(`getMacOSWebKitMajorVersion() | WebKit major version based on User-Agent => ${C}`),C}g.debug("getMacOSWebKitMajorVersion() | this is not WebKit => undefined")}function b(m){if(g.debug("getIOSWebKitMajorVersion()"),!y(m)){g.debug("getIOSWebKitMajorVersion() | this is not iOS => undefined");return}if(w()){g.debug("getIOSWebKitMajorVersion() | this is React-Native => undefined");return}const c=m?.match(/AppleWebKit\/(\w+)/i);if(c?.[1]){const f=Number(c[1]);return g.debug(`getIOSWebKitMajorVersion() | WebKit major version based on User-Agent => ${f}`),f}g.debug("getIOSWebKitMajorVersion() | this is not WebKit => undefined")}function y(m,c){return g.debug("isIOS()"),c?.platform==="iOS"?(g.debug("isIOS() | this is iOS based on NavigatorUAData.platform => true"),!0):c?.platform?(g.debug("isIOS() | this is not iOS based on NavigatorUAData.platform => false"),!1):m&&/iPad|iPhone|iPod/.test(m)?(g.debug("isIOS() | this is iOS based on User-Agent => true"),!0):typeof navigator=="object"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1?(g.debug("isIOS() | this is iPadOS 13+ based on User-Agent => true"),!0):(g.debug("isIOS() | this is not iOS => false"),!1)}function w(){return g.debug("isReactNative()"),typeof navigator=="object"&&navigator.product==="ReactNative"?(g.debug("isReactNative() | this is React-Native based on navigator.product"),!0):(g.debug("isReactNative() | this is not React-Native => false"),!1)}return se}var Pe={},De={},yt={},br;function Es(){if(br)return yt;br=1;for(var s=256,e=[],t;s--;)e[s]=(s+256).toString(16).substring(1);function r(){var u=0,v,h="";if(!t||s+16>256){for(t=Array(u=256);u--;)t[u]=256*Math.random()|0;u=s=0}for(;u<16;u++)v=t[s+u],u==6?h+=e[v&15|64]:u==8?h+=e[v&63|128]:h+=e[v],u&1&&u>1&&u<11&&(h+="-");return s++,h}return yt.v4=r,yt}var Le={},Sr;function Ts(){if(Sr)return Le;Sr=1,Object.defineProperty(Le,"__esModule",{value:!0}),Le.FakeEventTarget=void 0;class s{listeners={};addEventListener(t,r,u){r&&(this.listeners[t]=this.listeners[t]??[],this.listeners[t].push({callback:typeof r=="function"?r:r.handleEvent,once:typeof u=="object"&&u.once===!0}))}removeEventListener(t,r,u){this.listeners[t]&&r&&(this.listeners[t]=this.listeners[t].filter(v=>v.callback!==(typeof r=="function"?r:r.handleEvent)))}dispatchEvent(t){if(!t||typeof t.type!="string")throw new Error("invalid event object");const r=this.listeners[t.type];if(!r)return!0;for(const u of[...r]){try{u.callback.call(this,t)}catch(v){setTimeout(()=>{throw v},0)}u.once&&this.removeEventListener(t.type,u.callback)}return!t.defaultPrevented}}return Le.FakeEventTarget=s,Le}var Ie={},Cr;function ks(){if(Cr)return Ie;Cr=1,Object.defineProperty(Ie,"__esModule",{value:!0}),Ie.FakeEvent=void 0;let s=class{NONE=0;CAPTURING_PHASE=1;AT_TARGET=2;BUBBLING_PHASE=3;type;bubbles;cancelable;defaultPrevented=!1;composed=!1;currentTarget=null;eventPhase=this.NONE;isTrusted=!0;target=null;timeStamp=0;cancelBubble=!1;returnValue=!0;srcElement=null;constructor(t,r={}){this.type=t,this.bubbles=r.bubbles??!1,this.cancelable=r.cancelable??!1}preventDefault(){this.cancelable&&(this.defaultPrevented=!0)}stopPropagation(){}stopImmediatePropagation(){}composedPath(){return[]}initEvent(t,r,u){}};return Ie.FakeEvent=s,Ie}var Ve={},Rr;function xs(){if(Rr)return Ve;Rr=1,Object.defineProperty(Ve,"__esModule",{value:!0}),Ve.clone=s;function s(e){if(e!==void 0)return Number.isNaN(e)?NaN:typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e))}return Ve}var Er;function Ps(){if(Er)return De;Er=1,Object.defineProperty(De,"__esModule",{value:!0}),De.FakeMediaStreamTrack=void 0;const s=Es(),e=Ts(),t=ks(),r=xs();class u extends e.FakeEventTarget{#m;#l;#u;#e;#r;#t;#s;#h;#i;#f;#n;#a=null;#o=null;#c=null;#d=null;#p=null;constructor({kind:h,id:d,label:S,contentHint:E,enabled:a,muted:g,readyState:_,capabilities:k,constraints:R,settings:i,data:n}){super(),this.#m=d??(0,s.v4)(),this.#l=h,this.#u=S??"",this.#s=E??"",this.#r=a??!0,this.#t=g??!1,this.#e=_??"live",this.#h=k??{},this.#i=R??{},this.#f=i??{},this.#n=n??{}}get id(){return this.#m}get kind(){return this.#l}get label(){return this.#u}get contentHint(){return this.#s}set contentHint(h){this.#s=h}get enabled(){return this.#r}set enabled(h){const d=this.#r!==h;this.#r=h,d&&this.dispatchEvent(new t.FakeEvent("enabledchange"))}get muted(){return this.#t}get readyState(){return this.#e}get data(){return this.#n}set data(h){this.#n=h}get onmute(){return this.#a}set onmute(h){this.#a&&this.removeEventListener("mute",this.#a),this.#a=h,h&&this.addEventListener("mute",h)}get onunmute(){return this.#o}set onunmute(h){this.#o&&this.removeEventListener("unmute",this.#o),this.#o=h,h&&this.addEventListener("unmute",h)}get onended(){return this.#c}set onended(h){this.#c&&this.removeEventListener("ended",this.#c),this.#c=h,h&&this.addEventListener("ended",h)}get onenabledchange(){return this.#d}set onenabledchange(h){this.#d&&this.removeEventListener("enabledchange",this.#d),this.#d=h,h&&this.addEventListener("enabledchange",h)}get onstopped(){return this.#p}set onstopped(h){this.#p&&this.removeEventListener("stopped",this.#p),this.#p=h,h&&this.addEventListener("stopped",h)}addEventListener(h,d,S){super.addEventListener(h,d,S)}removeEventListener(h,d,S){super.removeEventListener(h,d,S)}stop(){this.#e!=="ended"&&(this.#e="ended",this.dispatchEvent(new t.FakeEvent("stopped")))}clone({id:h,data:d}={}){return new u({id:h??(0,s.v4)(),kind:this.#l,label:this.#u,contentHint:this.#s,enabled:this.#r,muted:this.#t,readyState:this.#e,capabilities:(0,r.clone)(this.#h),constraints:(0,r.clone)(this.#i),settings:(0,r.clone)(this.#f),data:d??(0,r.clone)(this.#n)})}getCapabilities(){return this.#h}getConstraints(){return this.#i}async applyConstraints(h={}){return this.#i=h,Promise.resolve()}getSettings(){return this.#f}remoteStop(){this.#e!=="ended"&&(this.#e="ended",this.dispatchEvent(new t.FakeEvent("stopped")),this.dispatchEvent(new t.FakeEvent("ended")))}remoteMute(){this.#t||(this.#t=!0,this.dispatchEvent(new t.FakeEvent("mute")))}remoteUnmute(){this.#t&&(this.#t=!1,this.dispatchEvent(new t.FakeEvent("unmute")))}}return De.FakeMediaStreamTrack=u,De}var Me={},Tr;function Ds(){if(Tr)return Me;Tr=1,Object.defineProperty(Me,"__esModule",{value:!0}),Me.FakeEventTarget=void 0;let s=class{listeners={};addEventListener(t,r,u){r&&(this.listeners[t]=this.listeners[t]??[],this.listeners[t].push({callback:typeof r=="function"?r:r.handleEvent,once:typeof u=="object"&&u.once===!0}))}removeEventListener(t,r,u){this.listeners[t]&&r&&(this.listeners[t]=this.listeners[t].filter(v=>v.callback!==(typeof r=="function"?r:r.handleEvent)))}dispatchEvent(t){if(!t||typeof t.type!="string")throw new Error("invalid event object");const r=this.listeners[t.type];if(!r)return!0;for(const u of[...r]){try{u.callback.call(this,t)}catch(v){setTimeout(()=>{throw v},0)}u.once&&this.removeEventListener(t.type,u.callback)}return!t.defaultPrevented}};return Me.FakeEventTarget=s,Me}var kr;function Ls(){if(kr)return Pe;kr=1,Object.defineProperty(Pe,"__esModule",{value:!0}),Pe.FakeHandler=void 0;const s=Ps(),e=z(),t=q(),r=de(),u=X(),v=Q(),h=Ds(),d=new t.Logger("FakeHandler"),S="FakeHandler";let E=class Xe extends e.EnhancedEventEmitter{_closed=!1;_fakeParameters;_getSendExtendedRtpCapabilities;_cname=`CNAME-${r.generateRandomNumber()}`;_defaultSendStreamId=`${r.generateRandomNumber()}`;_transportReady=!1;_nextLocalId=1;_tracks=new Map;_nextSctpStreamId=0;static createFactory(_){return{name:S,factory:k=>new Xe(k,_),getNativeRtpCapabilities:async()=>(d.debug("getNativeRtpCapabilities()"),Xe.getLocalRtpCapabilities(_)),getNativeSctpCapabilities:async()=>(d.debug("getNativeSctpCapabilities()"),_.generateNativeSctpCapabilities())}}static getLocalRtpCapabilities(_){const k=_.generateNativeRtpCapabilities();return u.validateAndNormalizeRtpCapabilities(k),k}constructor({getSendExtendedRtpCapabilities:_},k){super(),d.debug("constructor()"),this._getSendExtendedRtpCapabilities=_,this._fakeParameters=k}get name(){return S}close(){d.debug("close()"),!this._closed&&(this._closed=!0,super.close())}setIceGatheringState(_){this.emit("@icegatheringstatechange",_)}setConnectionState(_){this.emit("@connectionstatechange",_)}async updateIceServers(_){this.assertNotClosed(),d.debug("updateIceServers()")}async restartIce(_){this.assertNotClosed(),d.debug("restartIce()")}async getTransportStats(){return this.assertNotClosed(),new Map}async send({track:_,streamId:k,encodings:R,codecOptions:i,codec:n}){this.assertNotClosed(),d.debug("send() [kind:%s, track.id:%s]",_.kind,_.id),this._transportReady||await this.setupTransport({localDtlsRole:"server"});const o=Xe.getLocalRtpCapabilities(this._fakeParameters),l=this._getSendExtendedRtpCapabilities(o),b=u.getSendingRtpParameters(_.kind,l);b.codecs=u.reduceCodecs(b.codecs,n);const y=b.codecs.some(m=>/.+\/rtx$/i.test(m.mimeType));b.mid=`mid-${r.generateRandomNumber()}`,b.msid=`${k??"-"} ${_.id}`,R||(R=[{}]);for(const m of R)m.ssrc=r.generateRandomNumber(),y&&(m.rtx={ssrc:r.generateRandomNumber()});b.encodings=R,b.rtcp={cname:this._cname,reducedSize:!0,mux:!0},b.msid=`${k??this._defaultSendStreamId} ${_.id}`;const w=this._nextLocalId++;return this._tracks.set(w,_),{localId:String(w),rtpParameters:b}}async stopSending(_){if(d.debug("stopSending() [localId:%s]",_),!this._closed){if(!this._tracks.has(Number(_)))throw new Error("local track not found");this._tracks.delete(Number(_))}}async pauseSending(_){this.assertNotClosed()}async resumeSending(_){this.assertNotClosed()}async replaceTrack(_,k){this.assertNotClosed(),k?d.debug("replaceTrack() [localId:%s, track.id:%s]",_,k.id):d.debug("replaceTrack() [localId:%s, no track]",_),this._tracks.delete(Number(_)),this._tracks.set(Number(_),k)}async setMaxSpatialLayer(_,k){this.assertNotClosed(),d.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",_,k)}async setRtpEncodingParameters(_,k){this.assertNotClosed(),d.debug("setRtpEncodingParameters() [localId:%s, params:%o]",_,k)}async getSenderStats(_){return this.assertNotClosed(),new Map}async sendDataChannel({ordered:_,maxPacketLifeTime:k,maxRetransmits:R,label:i,protocol:n}){this.assertNotClosed(),this._transportReady||await this.setupTransport({localDtlsRole:"server"}),d.debug("sendDataChannel()");const o=new a({id:this._nextSctpStreamId++,ordered:_,maxPacketLifeTime:k,maxRetransmits:R,label:i,protocol:n}),l={streamId:this._nextSctpStreamId,ordered:_,maxPacketLifeTime:k,maxRetransmits:R};return{dataChannel:o,sctpStreamParameters:l}}async receive(_){this.assertNotClosed();const k=[];for(const R of _){const{trackId:i,kind:n}=R;this._transportReady||await this.setupTransport({localDtlsRole:"client"}),d.debug("receive() [trackId:%s, kind:%s]",i,n);const o=this._nextLocalId++,l=new s.FakeMediaStreamTrack({kind:n});this._tracks.set(o,l),k.push({localId:String(o),track:l})}return k}async stopReceiving(_){if(!this._closed)for(const k of _)d.debug("stopReceiving() [localId:%s]",k),this._tracks.delete(Number(k))}async pauseReceiving(_){this.assertNotClosed()}async resumeReceiving(_){this.assertNotClosed()}async getReceiverStats(_){return this.assertNotClosed(),new Map}async receiveDataChannel({sctpStreamParameters:_,label:k,protocol:R}){return this.assertNotClosed(),this._transportReady||await this.setupTransport({localDtlsRole:"client"}),d.debug("receiveDataChannel()"),{dataChannel:new a({id:_.streamId,ordered:_.ordered,maxPacketLifeTime:_.maxPacketLifeTime,maxRetransmits:_.maxRetransmits,label:k,protocol:R})}}async setupTransport({localDtlsRole:_,localSdpObject:k}){const R=r.clone(this._fakeParameters.generateLocalDtlsParameters());_&&(R.role=_),this.emit("@connectionstatechange","connecting"),await new Promise((i,n)=>this.emit("@connect",{dtlsParameters:R},i,n)),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new v.InvalidStateError("method called in a closed handler")}};Pe.FakeHandler=E;class a extends h.FakeEventTarget{_id;_negotiated=!0;_ordered;_maxPacketLifeTime;_maxRetransmits;_label;_protocol;_readyState="connecting";_bufferedAmount=0;_bufferedAmountLowThreshold=0;_binaryType="arraybuffer";_onopen=null;_onclosing=null;_onclose=null;_onmessage=null;_onbufferedamountlow=null;_onerror=null;constructor({id:_,ordered:k=!0,maxPacketLifeTime:R=null,maxRetransmits:i=null,label:n="",protocol:o=""}){super(),d.debug(`constructor() [id:${_}, ordered:${k}, maxPacketLifeTime:${R}, maxRetransmits:${i}, label:${n}, protocol:${o}`),this._id=_,this._ordered=k,this._maxPacketLifeTime=R,this._maxRetransmits=i,this._label=n,this._protocol=o}get id(){return this._id}get negotiated(){return this._negotiated}get ordered(){return this._ordered}get maxPacketLifeTime(){return this._maxPacketLifeTime}get maxRetransmits(){return this._maxRetransmits}get label(){return this._label}get protocol(){return this._protocol}get readyState(){return this._readyState}get bufferedAmount(){return this._bufferedAmount}get bufferedAmountLowThreshold(){return this._bufferedAmountLowThreshold}set bufferedAmountLowThreshold(_){this._bufferedAmountLowThreshold=_}get binaryType(){return this._binaryType}set binaryType(_){this._binaryType=_}get onopen(){return this._onopen}set onopen(_){this._onopen&&this.removeEventListener("open",this._onopen),this._onopen=_,_&&this.addEventListener("open",_)}get onclosing(){return this._onclosing}set onclosing(_){this._onclosing&&this.removeEventListener("closing",this._onclosing),this._onclosing=_,_&&this.addEventListener("closing",_)}get onclose(){return this._onclose}set onclose(_){this._onclose&&this.removeEventListener("close",this._onclose),this._onclose=_,_&&this.addEventListener("close",_)}get onmessage(){return this._onmessage}set onmessage(_){this._onmessage&&this.removeEventListener("message",this._onmessage),this._onmessage=_,_&&this.addEventListener("message",_)}get onbufferedamountlow(){return this._onbufferedamountlow}set onbufferedamountlow(_){this._onbufferedamountlow&&this.removeEventListener("bufferedamountlow",this._onbufferedamountlow),this._onbufferedamountlow=_,_&&this.addEventListener("bufferedamountlow",_)}get onerror(){return this._onerror}set onerror(_){this._onerror&&this.removeEventListener("error",this._onerror),this._onerror=_,_&&this.addEventListener("error",_)}addEventListener(_,k,R){super.addEventListener(_,k,R)}removeEventListener(_,k,R){super.removeEventListener(_,k,R)}close(){["closing","closed"].includes(this._readyState)||(this._readyState="closed")}send(_){if(this._readyState!=="open")throw new v.InvalidStateError("not open")}}return Pe}var U={},xr;function Is(){if(xr)return U;xr=1,Object.defineProperty(U,"__esModule",{value:!0}),U.generateRouterRtpCapabilities=t,U.generateNativeRtpCapabilities=r,U.generateNativeSctpCapabilities=u,U.generateLocalDtlsParameters=v,U.generateTransportRemoteParameters=h,U.generateProducerRemoteParameters=d,U.generateConsumerRemoteParameters=S,U.generateDataProducerRemoteParameters=E,U.generateDataConsumerRemoteParameters=a;const s=de();function e(){return String(s.generateRandomNumber())}function t(){return s.deepFreeze({codecs:[{mimeType:"audio/opus",kind:"audio",preferredPayloadType:100,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{useinbandfec:1,foo:"bar"}},{mimeType:"video/VP8",kind:"video",preferredPayloadType:101,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"x-google-start-bitrate":1500}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:102,clockRate:9e4,rtcpFeedback:[],parameters:{apt:101}},{mimeType:"video/H264",kind:"video",preferredPayloadType:103,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"level-asymmetry-allowed":1,"packetization-mode":1,"profile-level-id":"42e01f"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:104,clockRate:9e4,rtcpFeedback:[],parameters:{apt:103}},{mimeType:"video/VP9",kind:"video",preferredPayloadType:105,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"profile-id":0,"x-google-start-bitrate":1500}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:106,clockRate:9e4,rtcpFeedback:[],parameters:{apt:105}}],headerExtensions:[{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id",preferredId:2,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id",preferredId:3,preferredEncrypt:!1,direction:"recvonly"},{kind:"audio",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",preferredId:10,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:3gpp:video-orientation",preferredId:11,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:toffset",preferredId:12,preferredEncrypt:!1,direction:"sendrecv"}]})}function r(){return{codecs:[{mimeType:"audio/opus",kind:"audio",preferredPayloadType:111,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{minptime:10,useinbandfec:1}},{mimeType:"audio/ISAC",kind:"audio",preferredPayloadType:103,clockRate:16e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}},{mimeType:"audio/CN",kind:"audio",preferredPayloadType:106,clockRate:32e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}},{mimeType:"audio/foo",kind:"audio",preferredPayloadType:107,clockRate:9e4,channels:4,rtcpFeedback:[{type:"foo-qwe-qwe"}],parameters:{foo:"lalala"}},{mimeType:"video/BAZCODEC",kind:"video",preferredPayloadType:100,clockRate:9e4,rtcpFeedback:[{type:"foo"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{baz:"1234abcd"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:101,clockRate:9e4,rtcpFeedback:[],parameters:{apt:100}},{mimeType:"video/VP8",kind:"video",preferredPayloadType:96,clockRate:9e4,rtcpFeedback:[{type:"goog-remb"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{baz:"1234abcd"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:97,clockRate:9e4,rtcpFeedback:[],parameters:{apt:96}},{mimeType:"video/VP9",kind:"video",preferredPayloadType:98,clockRate:9e4,rtcpFeedback:[{type:"goog-remb"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{"profile-id":0}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:99,clockRate:9e4,rtcpFeedback:[],parameters:{apt:98}}],headerExtensions:[{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:toffset",preferredId:2},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:3},{kind:"video",uri:"urn:3gpp:video-orientation",preferredId:4},{kind:"video",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay",preferredId:6},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type",preferredId:7},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing",preferredId:8},{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",preferredId:10}]}}function u(){return s.deepFreeze({numStreams:{OS:2048,MIS:2048}})}function v(){return s.deepFreeze({fingerprints:[{algorithm:"sha-256",value:"82:5A:68:3D:36:C3:0A:DE:AF:E7:32:43:D2:88:83:57:AC:2D:65:E5:80:C4:B6:FB:AF:1A:A0:21:9F:6D:0C:AD"}],role:"auto"})}function h(){return{id:e(),iceParameters:s.deepFreeze({iceLite:!0,password:"yku5ej8nvfaor28lvtrabcx0wkrpkztz",usernameFragment:"h3hk1iz6qqlnqlne"}),iceCandidates:s.deepFreeze([{foundation:"udpcandidate",address:"9.9.9.9",ip:"9.9.9.9",port:40533,priority:1078862079,protocol:"udp",type:"host",tcpType:"passive"},{foundation:"udpcandidate",address:"9.9.9.9",ip:"9:9:9:9:9:9",port:41333,priority:1078862089,protocol:"udp",type:"host",tcpType:"passive"}]),dtlsParameters:s.deepFreeze({fingerprints:[{algorithm:"sha-256",value:"A9:F4:E0:D2:74:D3:0F:D9:CA:A5:2F:9F:7F:47:FA:F0:C4:72:DD:73:49:D0:3B:14:90:20:51:30:1B:90:8E:71"},{algorithm:"sha-384",value:"03:D9:0B:87:13:98:F6:6D:BC:FC:92:2E:39:D4:E1:97:32:61:30:56:84:70:81:6E:D1:82:97:EA:D9:C1:21:0F:6B:C5:E7:7F:E1:97:0C:17:97:6E:CF:B3:EF:2E:74:B0"},{algorithm:"sha-512",value:"84:27:A4:28:A4:73:AF:43:02:2A:44:68:FF:2F:29:5C:3B:11:9A:60:F4:A8:F0:F5:AC:A0:E3:49:3E:B1:34:53:A9:85:CE:51:9B:ED:87:5E:B8:F4:8E:3D:FA:20:51:B8:96:EE:DA:56:DC:2F:5C:62:79:15:23:E0:21:82:2B:2C"}],role:"auto"}),sctpParameters:s.deepFreeze({port:5e3,OS:2048,MIS:2048,maxMessageSize:2e6})}}function d(){return s.deepFreeze({id:e()})}function S({id:g,codecMimeType:_}={}){switch(_){case"audio/opus":return{id:g??e(),producerId:e(),kind:"audio",rtpParameters:s.deepFreeze({codecs:[{mimeType:"audio/opus",payloadType:100,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{useinbandfec:1,foo:"bar"}}],encodings:[{ssrc:46687003}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",id:10}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"audio/ISAC":return{id:g??e(),producerId:e(),kind:"audio",rtpParameters:s.deepFreeze({codecs:[{mimeType:"audio/ISAC",payloadType:111,clockRate:16e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}}],encodings:[{ssrc:46687004}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"video/VP8":return{id:g??e(),producerId:e(),kind:"video",rtpParameters:s.deepFreeze({codecs:[{mimeType:"video/VP8",payloadType:101,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"x-google-start-bitrate":1500}},{mimeType:"video/rtx",payloadType:102,clockRate:9e4,rtcpFeedback:[],parameters:{apt:101}}],encodings:[{ssrc:99991111,rtx:{ssrc:99991112}}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",id:4},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:3gpp:video-orientation",id:11},{uri:"urn:ietf:params:rtp-hdrext:toffset",id:12}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"video/H264":return{id:g??e(),producerId:e(),kind:"video",rtpParameters:s.deepFreeze({codecs:[{mimeType:"video/H264",payloadType:103,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"level-asymmetry-allowed":1,"packetization-mode":1,"profile-level-id":"42e01f"}},{mimeType:"video/rtx",payloadType:104,clockRate:9e4,rtcpFeedback:[],parameters:{apt:103}}],encodings:[{ssrc:99991113,rtx:{ssrc:99991114}}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",id:4},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:3gpp:video-orientation",id:11},{uri:"urn:ietf:params:rtp-hdrext:toffset",id:12}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};default:throw new TypeError(`unknown codecMimeType '${_}'`)}}function E(){return s.deepFreeze({id:e()})}function a({id:g}={}){return{id:g??e(),dataProducerId:e(),sctpStreamParameters:s.deepFreeze({streamId:666,maxPacketLifeTime:5e3,maxRetransmits:void 0})}}return U}var Pr;function Ms(){return Pr||(Pr=1,(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.debug=s.testFakeParameters=s.FakeHandler=s.enhancedEvents=s.ortc=s.parseScalabilityMode=s.detectDeviceAsync=s.detectDevice=s.Device=s.version=s.types=void 0;const e=at();s.debug=e.default,s.types=is(),s.version="3.18.0";var t=Rs();Object.defineProperty(s,"Device",{enumerable:!0,get:function(){return t.Device}}),Object.defineProperty(s,"detectDevice",{enumerable:!0,get:function(){return t.detectDevice}}),Object.defineProperty(s,"detectDeviceAsync",{enumerable:!0,get:function(){return t.detectDeviceAsync}});var r=pe();Object.defineProperty(s,"parseScalabilityMode",{enumerable:!0,get:function(){return r.parse}}),s.ortc=X(),s.enhancedEvents=z();var u=Ls();Object.defineProperty(s,"FakeHandler",{enumerable:!0,get:function(){return u.FakeHandler}}),s.testFakeParameters=Is()})(lt)),lt}var ot=Ms();const Os=ts(ot),jr=es({__proto__:null,default:Os},[ot]),Y=Object.create(null);Y.open="0";Y.close="1";Y.ping="2";Y.pong="3";Y.message="4";Y.upgrade="5";Y.noop="6";const Ze=Object.create(null);Object.keys(Y).forEach(s=>{Ze[Y[s]]=s});const Ct={type:"error",data:"parser error"},Br=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",$r=typeof ArrayBuffer=="function",qr=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s&&s.buffer instanceof ArrayBuffer,Lt=({type:s,data:e},t,r)=>Br&&e instanceof Blob?t?r(e):Dr(e,r):$r&&(e instanceof ArrayBuffer||qr(e))?t?r(e):Dr(new Blob([e]),r):r(Y[s]+(e||"")),Dr=(s,e)=>{const t=new FileReader;return t.onload=function(){const r=t.result.split(",")[1];e("b"+(r||""))},t.readAsDataURL(s)};function Lr(s){return s instanceof Uint8Array?s:s instanceof ArrayBuffer?new Uint8Array(s):new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}let wt;function As(s,e){if(Br&&s.data instanceof Blob)return s.data.arrayBuffer().then(Lr).then(e);if($r&&(s.data instanceof ArrayBuffer||qr(s.data)))return e(Lr(s.data));Lt(s,!1,t=>{wt||(wt=new TextEncoder),e(wt.encode(t))})}const Ir="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ae=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let s=0;s<Ir.length;s++)Ae[Ir.charCodeAt(s)]=s;const Ns=s=>{let e=s.length*.75,t=s.length,r,u=0,v,h,d,S;s[s.length-1]==="="&&(e--,s[s.length-2]==="="&&e--);const E=new ArrayBuffer(e),a=new Uint8Array(E);for(r=0;r<t;r+=4)v=Ae[s.charCodeAt(r)],h=Ae[s.charCodeAt(r+1)],d=Ae[s.charCodeAt(r+2)],S=Ae[s.charCodeAt(r+3)],a[u++]=v<<2|h>>4,a[u++]=(h&15)<<4|d>>2,a[u++]=(d&3)<<6|S&63;return E},Fs=typeof ArrayBuffer=="function",It=(s,e)=>{if(typeof s!="string")return{type:"message",data:zr(s,e)};const t=s.charAt(0);return t==="b"?{type:"message",data:js(s.substring(1),e)}:Ze[t]?s.length>1?{type:Ze[t],data:s.substring(1)}:{type:Ze[t]}:Ct},js=(s,e)=>{if(Fs){const t=Ns(s);return zr(t,e)}else return{base64:!0,data:s}},zr=(s,e)=>{switch(e){case"blob":return s instanceof Blob?s:new Blob([s]);case"arraybuffer":default:return s instanceof ArrayBuffer?s:s.buffer}},Ur="",Bs=(s,e)=>{const t=s.length,r=new Array(t);let u=0;s.forEach((v,h)=>{Lt(v,!1,d=>{r[h]=d,++u===t&&e(r.join(Ur))})})},$s=(s,e)=>{const t=s.split(Ur),r=[];for(let u=0;u<t.length;u++){const v=It(t[u],e);if(r.push(v),v.type==="error")break}return r};function qs(){return new TransformStream({transform(s,e){As(s,t=>{const r=t.length;let u;if(r<126)u=new Uint8Array(1),new DataView(u.buffer).setUint8(0,r);else if(r<65536){u=new Uint8Array(3);const v=new DataView(u.buffer);v.setUint8(0,126),v.setUint16(1,r)}else{u=new Uint8Array(9);const v=new DataView(u.buffer);v.setUint8(0,127),v.setBigUint64(1,BigInt(r))}s.data&&typeof s.data!="string"&&(u[0]|=128),e.enqueue(u),e.enqueue(t)})}})}let bt;function He(s){return s.reduce((e,t)=>e+t.length,0)}function We(s,e){if(s[0].length===e)return s.shift();const t=new Uint8Array(e);let r=0;for(let u=0;u<e;u++)t[u]=s[0][r++],r===s[0].length&&(s.shift(),r=0);return s.length&&r<s[0].length&&(s[0]=s[0].slice(r)),t}function zs(s,e){bt||(bt=new TextDecoder);const t=[];let r=0,u=-1,v=!1;return new TransformStream({transform(h,d){for(t.push(h);;){if(r===0){if(He(t)<1)break;const S=We(t,1);v=(S[0]&128)===128,u=S[0]&127,u<126?r=3:u===126?r=1:r=2}else if(r===1){if(He(t)<2)break;const S=We(t,2);u=new DataView(S.buffer,S.byteOffset,S.length).getUint16(0),r=3}else if(r===2){if(He(t)<8)break;const S=We(t,8),E=new DataView(S.buffer,S.byteOffset,S.length),a=E.getUint32(0);if(a>Math.pow(2,21)-1){d.enqueue(Ct);break}u=a*Math.pow(2,32)+E.getUint32(4),r=3}else{if(He(t)<u)break;const S=We(t,u);d.enqueue(It(v?S:bt.decode(S),e)),r=0}if(u===0||u>s){d.enqueue(Ct);break}}}})}const Vr=4;function j(s){if(s)return Us(s)}function Us(s){for(var e in j.prototype)s[e]=j.prototype[e];return s}j.prototype.on=j.prototype.addEventListener=function(s,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+s]=this._callbacks["$"+s]||[]).push(e),this};j.prototype.once=function(s,e){function t(){this.off(s,t),e.apply(this,arguments)}return t.fn=e,this.on(s,t),this};j.prototype.off=j.prototype.removeListener=j.prototype.removeAllListeners=j.prototype.removeEventListener=function(s,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+s];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+s],this;for(var r,u=0;u<t.length;u++)if(r=t[u],r===e||r.fn===e){t.splice(u,1);break}return t.length===0&&delete this._callbacks["$"+s],this};j.prototype.emit=function(s){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+s],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(t){t=t.slice(0);for(var r=0,u=t.length;r<u;++r)t[r].apply(this,e)}return this};j.prototype.emitReserved=j.prototype.emit;j.prototype.listeners=function(s){return this._callbacks=this._callbacks||{},this._callbacks["$"+s]||[]};j.prototype.hasListeners=function(s){return!!this.listeners(s).length};const ct=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),V=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),Vs="arraybuffer";function Hr(s,...e){return e.reduce((t,r)=>(s.hasOwnProperty(r)&&(t[r]=s[r]),t),{})}const Hs=V.setTimeout,Ws=V.clearTimeout;function dt(s,e){e.useNativeTimers?(s.setTimeoutFn=Hs.bind(V),s.clearTimeoutFn=Ws.bind(V)):(s.setTimeoutFn=V.setTimeout.bind(V),s.clearTimeoutFn=V.clearTimeout.bind(V))}const Ks=1.33;function Qs(s){return typeof s=="string"?Gs(s):Math.ceil((s.byteLength||s.size)*Ks)}function Gs(s){let e=0,t=0;for(let r=0,u=s.length;r<u;r++)e=s.charCodeAt(r),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(r++,t+=4);return t}function Wr(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function Ys(s){let e="";for(let t in s)s.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(s[t]));return e}function Js(s){let e={},t=s.split("&");for(let r=0,u=t.length;r<u;r++){let v=t[r].split("=");e[decodeURIComponent(v[0])]=decodeURIComponent(v[1])}return e}class Xs extends Error{constructor(e,t,r){super(e),this.description=t,this.context=r,this.type="TransportError"}}class Mt extends j{constructor(e){super(),this.writable=!1,dt(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,r){return super.emitReserved("error",new Xs(e,t,r)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=It(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=Ys(e);return t.length?"?"+t:""}}class Zs extends Mt{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let r=0;this._polling&&(r++,this.once("pollComplete",function(){--r||t()})),this.writable||(r++,this.once("drain",function(){--r||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=r=>{if(this.readyState==="opening"&&r.type==="open"&&this.onOpen(),r.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(r)};$s(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,Bs(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=Wr()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let Kr=!1;try{Kr=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const ei=Kr;function ti(){}class ri extends Zs{constructor(e){if(super(e),typeof location<"u"){const t=location.protocol==="https:";let r=location.port;r||(r=t?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||r!==e.port}}doWrite(e,t){const r=this.request({method:"POST",data:e});r.on("success",t),r.on("error",(u,v)=>{this.onError("xhr post error",u,v)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,r)=>{this.onError("xhr poll error",t,r)}),this.pollXhr=e}}class G extends j{constructor(e,t,r){super(),this.createRequest=e,dt(this,r),this._opts=r,this._method=r.method||"GET",this._uri=t,this._data=r.data!==void 0?r.data:null,this._create()}_create(){var e;const t=Hr(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const r=this._xhr=this.createRequest(t);try{r.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){r.setDisableHeaderCheck&&r.setDisableHeaderCheck(!0);for(let u in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(u)&&r.setRequestHeader(u,this._opts.extraHeaders[u])}}catch{}if(this._method==="POST")try{r.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{r.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(r),"withCredentials"in r&&(r.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(r.timeout=this._opts.requestTimeout),r.onreadystatechange=()=>{var u;r.readyState===3&&((u=this._opts.cookieJar)===null||u===void 0||u.parseCookies(r.getResponseHeader("set-cookie"))),r.readyState===4&&(r.status===200||r.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof r.status=="number"?r.status:0)},0))},r.send(this._data)}catch(u){this.setTimeoutFn(()=>{this._onError(u)},0);return}typeof document<"u"&&(this._index=G.requestsCount++,G.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=ti,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete G.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}G.requestsCount=0;G.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Mr);else if(typeof addEventListener=="function"){const s="onpagehide"in V?"pagehide":"unload";addEventListener(s,Mr,!1)}}function Mr(){for(let s in G.requests)G.requests.hasOwnProperty(s)&&G.requests[s].abort()}const si=(function(){const s=Qr({xdomain:!1});return s&&s.responseType!==null})();class ii extends ri{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=si&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new G(Qr,this.uri(),e)}}function Qr(s){const e=s.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||ei))return new XMLHttpRequest}catch{}if(!e)try{return new V[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const Gr=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class ni extends Mt{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,r=Gr?{}:Hr(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(r.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,r)}catch(u){return this.emitReserved("error",u)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const r=e[t],u=t===e.length-1;Lt(r,this.supportsBinary,v=>{try{this.doWrite(r,v)}catch{}u&&ct(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=Wr()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const St=V.WebSocket||V.MozWebSocket;class ai extends ni{createSocket(e,t,r){return Gr?new St(e,t,r):t?new St(e,t):new St(e)}doWrite(e,t){this.ws.send(t)}}class oi extends Mt{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=zs(Number.MAX_SAFE_INTEGER,this.socket.binaryType),r=e.readable.pipeThrough(t).getReader(),u=qs();u.readable.pipeTo(e.writable),this._writer=u.writable.getWriter();const v=()=>{r.read().then(({done:d,value:S})=>{d||(this.onPacket(S),v())}).catch(d=>{})};v();const h={type:"open"};this.query.sid&&(h.data=`{"sid":"${this.query.sid}"}`),this._writer.write(h).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const r=e[t],u=t===e.length-1;this._writer.write(r).then(()=>{u&&ct(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const ci={websocket:ai,webtransport:oi,polling:ii},di=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,pi=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Rt(s){if(s.length>8e3)throw"URI too long";const e=s,t=s.indexOf("["),r=s.indexOf("]");t!=-1&&r!=-1&&(s=s.substring(0,t)+s.substring(t,r).replace(/:/g,";")+s.substring(r,s.length));let u=di.exec(s||""),v={},h=14;for(;h--;)v[pi[h]]=u[h]||"";return t!=-1&&r!=-1&&(v.source=e,v.host=v.host.substring(1,v.host.length-1).replace(/;/g,":"),v.authority=v.authority.replace("[","").replace("]","").replace(/;/g,":"),v.ipv6uri=!0),v.pathNames=li(v,v.path),v.queryKey=ui(v,v.query),v}function li(s,e){const t=/\/{2,9}/g,r=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&r.splice(0,1),e.slice(-1)=="/"&&r.splice(r.length-1,1),r}function ui(s,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(r,u,v){u&&(t[u]=v)}),t}const Et=typeof addEventListener=="function"&&typeof removeEventListener=="function",et=[];Et&&addEventListener("offline",()=>{et.forEach(s=>s())},!1);class te extends j{constructor(e,t){if(super(),this.binaryType=Vs,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const r=Rt(e);t.hostname=r.host,t.secure=r.protocol==="https"||r.protocol==="wss",t.port=r.port,r.query&&(t.query=r.query)}else t.host&&(t.hostname=Rt(t.host).host);dt(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(r=>{const u=r.prototype.name;this.transports.push(u),this._transportsByName[u]=r}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Js(this.opts.query)),Et&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},et.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=Vr,t.transport=e,this.id&&(t.sid=this.id);const r=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](r)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&te.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",te.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let r=0;r<this.writeBuffer.length;r++){const u=this.writeBuffer[r].data;if(u&&(t+=Qs(u)),r>0&&t>this._maxPayload)return this.writeBuffer.slice(0,r);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,ct(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,r){return this._sendPacket("message",e,t,r),this}send(e,t,r){return this._sendPacket("message",e,t,r),this}_sendPacket(e,t,r,u){if(typeof t=="function"&&(u=t,t=void 0),typeof r=="function"&&(u=r,r=null),this.readyState==="closing"||this.readyState==="closed")return;r=r||{},r.compress=r.compress!==!1;const v={type:e,data:t,options:r};this.emitReserved("packetCreate",v),this.writeBuffer.push(v),u&&this.once("flush",u),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},r=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?r():e()}):this.upgrading?r():e()),this}_onError(e){if(te.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),Et&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const r=et.indexOf(this._offlineEventListener);r!==-1&&et.splice(r,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}te.protocol=Vr;class hi extends te{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),r=!1;te.priorWebsocketSuccess=!1;const u=()=>{r||(t.send([{type:"ping",data:"probe"}]),t.once("packet",g=>{if(!r)if(g.type==="pong"&&g.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;te.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{r||this.readyState!=="closed"&&(a(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const _=new Error("probe error");_.transport=t.name,this.emitReserved("upgradeError",_)}}))};function v(){r||(r=!0,a(),t.close(),t=null)}const h=g=>{const _=new Error("probe error: "+g);_.transport=t.name,v(),this.emitReserved("upgradeError",_)};function d(){h("transport closed")}function S(){h("socket closed")}function E(g){t&&g.name!==t.name&&v()}const a=()=>{t.removeListener("open",u),t.removeListener("error",h),t.removeListener("close",d),this.off("close",S),this.off("upgrading",E)};t.once("open",u),t.once("error",h),t.once("close",d),this.once("close",S),this.once("upgrading",E),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{r||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let r=0;r<e.length;r++)~this.transports.indexOf(e[r])&&t.push(e[r]);return t}}let fi=class extends hi{constructor(e,t={}){const r=typeof e=="object"?e:t;(!r.transports||r.transports&&typeof r.transports[0]=="string")&&(r.transports=(r.transports||["polling","websocket","webtransport"]).map(u=>ci[u]).filter(u=>!!u)),super(e,r)}};function mi(s,e="",t){let r=s;t=t||typeof location<"u"&&location,s==null&&(s=t.protocol+"//"+t.host),typeof s=="string"&&(s.charAt(0)==="/"&&(s.charAt(1)==="/"?s=t.protocol+s:s=t.host+s),/^(https?|wss?):\/\//.test(s)||(typeof t<"u"?s=t.protocol+"//"+s:s="https://"+s),r=Rt(s)),r.port||(/^(http|ws)$/.test(r.protocol)?r.port="80":/^(http|ws)s$/.test(r.protocol)&&(r.port="443")),r.path=r.path||"/";const v=r.host.indexOf(":")!==-1?"["+r.host+"]":r.host;return r.id=r.protocol+"://"+v+":"+r.port+e,r.href=r.protocol+"://"+v+(t&&t.port===r.port?"":":"+r.port),r}const gi=typeof ArrayBuffer=="function",_i=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s.buffer instanceof ArrayBuffer,Yr=Object.prototype.toString,vi=typeof Blob=="function"||typeof Blob<"u"&&Yr.call(Blob)==="[object BlobConstructor]",yi=typeof File=="function"||typeof File<"u"&&Yr.call(File)==="[object FileConstructor]";function Ot(s){return gi&&(s instanceof ArrayBuffer||_i(s))||vi&&s instanceof Blob||yi&&s instanceof File}function tt(s,e){if(!s||typeof s!="object")return!1;if(Array.isArray(s)){for(let t=0,r=s.length;t<r;t++)if(tt(s[t]))return!0;return!1}if(Ot(s))return!0;if(s.toJSON&&typeof s.toJSON=="function"&&arguments.length===1)return tt(s.toJSON(),!0);for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t)&&tt(s[t]))return!0;return!1}function wi(s){const e=[],t=s.data,r=s;return r.data=Tt(t,e),r.attachments=e.length,{packet:r,buffers:e}}function Tt(s,e){if(!s)return s;if(Ot(s)){const t={_placeholder:!0,num:e.length};return e.push(s),t}else if(Array.isArray(s)){const t=new Array(s.length);for(let r=0;r<s.length;r++)t[r]=Tt(s[r],e);return t}else if(typeof s=="object"&&!(s instanceof Date)){const t={};for(const r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=Tt(s[r],e));return t}return s}function bi(s,e){return s.data=kt(s.data,e),delete s.attachments,s}function kt(s,e){if(!s)return s;if(s&&s._placeholder===!0){if(typeof s.num=="number"&&s.num>=0&&s.num<e.length)return e[s.num];throw new Error("illegal attachments")}else if(Array.isArray(s))for(let t=0;t<s.length;t++)s[t]=kt(s[t],e);else if(typeof s=="object")for(const t in s)Object.prototype.hasOwnProperty.call(s,t)&&(s[t]=kt(s[t],e));return s}const Si=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],Ci=5;var F;(function(s){s[s.CONNECT=0]="CONNECT",s[s.DISCONNECT=1]="DISCONNECT",s[s.EVENT=2]="EVENT",s[s.ACK=3]="ACK",s[s.CONNECT_ERROR=4]="CONNECT_ERROR",s[s.BINARY_EVENT=5]="BINARY_EVENT",s[s.BINARY_ACK=6]="BINARY_ACK"})(F||(F={}));class Ri{constructor(e){this.replacer=e}encode(e){return(e.type===F.EVENT||e.type===F.ACK)&&tt(e)?this.encodeAsBinary({type:e.type===F.EVENT?F.BINARY_EVENT:F.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===F.BINARY_EVENT||e.type===F.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=wi(e),r=this.encodeAsString(t.packet),u=t.buffers;return u.unshift(r),u}}function Or(s){return Object.prototype.toString.call(s)==="[object Object]"}class At extends j{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const r=t.type===F.BINARY_EVENT;r||t.type===F.BINARY_ACK?(t.type=r?F.EVENT:F.ACK,this.reconstructor=new Ei(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(Ot(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const r={type:Number(e.charAt(0))};if(F[r.type]===void 0)throw new Error("unknown packet type "+r.type);if(r.type===F.BINARY_EVENT||r.type===F.BINARY_ACK){const v=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const h=e.substring(v,t);if(h!=Number(h)||e.charAt(t)!=="-")throw new Error("Illegal attachments");r.attachments=Number(h)}if(e.charAt(t+1)==="/"){const v=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););r.nsp=e.substring(v,t)}else r.nsp="/";const u=e.charAt(t+1);if(u!==""&&Number(u)==u){const v=t+1;for(;++t;){const h=e.charAt(t);if(h==null||Number(h)!=h){--t;break}if(t===e.length)break}r.id=Number(e.substring(v,t+1))}if(e.charAt(++t)){const v=this.tryParse(e.substr(t));if(At.isPayloadValid(r.type,v))r.data=v;else throw new Error("invalid payload")}return r}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case F.CONNECT:return Or(t);case F.DISCONNECT:return t===void 0;case F.CONNECT_ERROR:return typeof t=="string"||Or(t);case F.EVENT:case F.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&Si.indexOf(t[0])===-1);case F.ACK:case F.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Ei{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=bi(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const Ti=Object.freeze(Object.defineProperty({__proto__:null,Decoder:At,Encoder:Ri,get PacketType(){return F},protocol:Ci},Symbol.toStringTag,{value:"Module"}));function W(s,e,t){return s.on(e,t),function(){s.off(e,t)}}const ki=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Jr extends j{constructor(e,t,r){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,r&&r.auth&&(this.auth=r.auth),this._opts=Object.assign({},r),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[W(e,"open",this.onopen.bind(this)),W(e,"packet",this.onpacket.bind(this)),W(e,"error",this.onerror.bind(this)),W(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var r,u,v;if(ki.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const h={type:F.EVENT,data:t};if(h.options={},h.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const a=this.ids++,g=t.pop();this._registerAckCallback(a,g),h.id=a}const d=(u=(r=this.io.engine)===null||r===void 0?void 0:r.transport)===null||u===void 0?void 0:u.writable,S=this.connected&&!(!((v=this.io.engine)===null||v===void 0)&&v._hasPingExpired());return this.flags.volatile&&!d||(S?(this.notifyOutgoingListeners(h),this.packet(h)):this.sendBuffer.push(h)),this.flags={},this}_registerAckCallback(e,t){var r;const u=(r=this.flags.timeout)!==null&&r!==void 0?r:this._opts.ackTimeout;if(u===void 0){this.acks[e]=t;return}const v=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let d=0;d<this.sendBuffer.length;d++)this.sendBuffer[d].id===e&&this.sendBuffer.splice(d,1);t.call(this,new Error("operation has timed out"))},u),h=(...d)=>{this.io.clearTimeoutFn(v),t.apply(this,d)};h.withError=!0,this.acks[e]=h}emitWithAck(e,...t){return new Promise((r,u)=>{const v=(h,d)=>h?u(h):r(d);v.withError=!0,t.push(v),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const r={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((u,...v)=>r!==this._queue[0]?void 0:(u!==null?r.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(u)):(this._queue.shift(),t&&t(null,...v)),r.pending=!1,this._drainQueue())),this._queue.push(r),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:F.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(r=>String(r.id)===e)){const r=this.acks[e];delete this.acks[e],r.withError&&r.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case F.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case F.EVENT:case F.BINARY_EVENT:this.onevent(e);break;case F.ACK:case F.BINARY_ACK:this.onack(e);break;case F.DISCONNECT:this.ondisconnect();break;case F.CONNECT_ERROR:this.destroy();const r=new Error(e.data.message);r.data=e.data.data,this.emitReserved("connect_error",r);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const r of t)r.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let r=!1;return function(...u){r||(r=!0,t.packet({type:F.ACK,id:e,data:u}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:F.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let r=0;r<t.length;r++)if(e===t[r])return t.splice(r,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let r=0;r<t.length;r++)if(e===t[r])return t.splice(r,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const r of t)r.apply(this,e.data)}}}function le(s){s=s||{},this.ms=s.min||100,this.max=s.max||1e4,this.factor=s.factor||2,this.jitter=s.jitter>0&&s.jitter<=1?s.jitter:0,this.attempts=0}le.prototype.duration=function(){var s=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*s);s=(Math.floor(e*10)&1)==0?s-t:s+t}return Math.min(s,this.max)|0};le.prototype.reset=function(){this.attempts=0};le.prototype.setMin=function(s){this.ms=s};le.prototype.setMax=function(s){this.max=s};le.prototype.setJitter=function(s){this.jitter=s};class xt extends j{constructor(e,t){var r;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,dt(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((r=t.randomizationFactor)!==null&&r!==void 0?r:.5),this.backoff=new le({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const u=t.parser||Ti;this.encoder=new u.Encoder,this.decoder=new u.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new fi(this.uri,this.opts);const t=this.engine,r=this;this._readyState="opening",this.skipReconnect=!1;const u=W(t,"open",function(){r.onopen(),e&&e()}),v=d=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",d),e?e(d):this.maybeReconnectOnOpen()},h=W(t,"error",v);if(this._timeout!==!1){const d=this._timeout,S=this.setTimeoutFn(()=>{u(),v(new Error("timeout")),t.close()},d);this.opts.autoUnref&&S.unref(),this.subs.push(()=>{this.clearTimeoutFn(S)})}return this.subs.push(u),this.subs.push(h),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(W(e,"ping",this.onping.bind(this)),W(e,"data",this.ondata.bind(this)),W(e,"error",this.onerror.bind(this)),W(e,"close",this.onclose.bind(this)),W(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){ct(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let r=this.nsps[e];return r?this._autoConnect&&!r.active&&r.connect():(r=new Jr(this,e,t),this.nsps[e]=r),r}_destroy(e){const t=Object.keys(this.nsps);for(const r of t)if(this.nsps[r].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let r=0;r<t.length;r++)this.engine.write(t[r],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var r;this.cleanup(),(r=this.engine)===null||r===void 0||r.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const r=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(u=>{u?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",u)):e.onreconnect()}))},t);this.opts.autoUnref&&r.unref(),this.subs.push(()=>{this.clearTimeoutFn(r)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const Oe={};function rt(s,e){typeof s=="object"&&(e=s,s=void 0),e=e||{};const t=mi(s,e.path||"/socket.io"),r=t.source,u=t.id,v=t.path,h=Oe[u]&&v in Oe[u].nsps,d=e.forceNew||e["force new connection"]||e.multiplex===!1||h;let S;return d?S=new xt(r,e):(Oe[u]||(Oe[u]=new xt(r,e)),S=Oe[u]),t.query&&!e.query&&(e.query=t.queryKey),S.socket(t.path,e)}Object.assign(rt,{Manager:xt,Socket:Jr,io:rt,connect:rt});console.log("mediasoup-client version:",ot.version);window.mediasoupClient=jr;const it=document.getElementById("connect"),Nt=document.getElementById("device"),Ft=document.getElementById("create-producer"),Pt=document.getElementById("publish"),pt=document.getElementById("create-consumer"),Xr=document.getElementById("subscribe"),Zr=document.getElementById("disconnect"),xi=document.getElementById("local-video"),Pi=document.getElementById("remote-video");let K=null,ee=null,st=null,Ne=null,nt=null,Ar=null;const Di=()=>{console.log("Init connect"),K=rt("https://172.17.176.1:3030"),it.innerHTML="Connecting...",it.disabled=!0,Fi()},Li=async()=>{console.log(jr),ee=new ot.Device;const s=await K.emitWithAck("getRtpCap");console.log(s),console.log("[C1] router caps mimeTypes:",(s.codecs||[]).map(e=>e.mimeType)),await ee.load({routerRtpCapabilities:s}),console.log(ee.loaded),console.log("[C2] device loaded?",!!ee.loaded),console.log("[C2] device caps mimeTypes:",(ee.rtpCapabilities.codecs||[]).map(e=>e.mimeType)),Nt.disabled=!0,Ft.disabled=!1,pt.disabled=!1,Zr.disabled=!1},Ii=async()=>{try{st=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),console.log(st),xi.srcObject=st}catch(h){console.log("GUM error",h)}const s=await K.emitWithAck("create-producer-transport"),{id:e,iceParameters:t,iceCandidates:r,dtlsParameters:u}=s;console.log(s),Ne=ee.createSendTransport({id:e,iceParameters:t,iceCandidates:r,dtlsParameters:u}),Ne.on("connect",async({dtlsParameters:h},d,S)=>{console.log(h);const E=await K.emitWithAck("connect-transport",{dtlsParameters:h});E==="success"?d():E==="error"&&S(),console.log(E)}),Ne.on("produce",async(h,d,S)=>{console.log("Transport produce event has fired!"),console.log(h);const{kind:E,rtpParameters:a}=h,g=await K.emitWithAck("start-producing",{kind:E,rtpParameters:a});g==="error"?S():d({id:g}),console.log(g),Pt.disabled=!0,pt.disabled=!1}),Ft.disabled=!0,Pt.disabled=!1},Mi=async()=>{const s=st.getVideoTracks()[0];await Ne.produce({track:s})},Oi=async()=>{console.log("hit create consumer");const s=await K.emitWithAck("create-consumer-transport"),{id:e,iceParameters:t,iceCandidates:r,dtlsParameters:u}=s;console.log(s),nt=ee.createRecvTransport({id:e,iceParameters:t,iceCandidates:r,dtlsParameters:u}),nt.on("connect",async({dtlsParameters:h},d,S)=>{const E=await K.emitWithAck("connect-consumer-transport",{dtlsParameters:h});E==="success"?d():E==="error"&&S(),console.log(E)}),pt.disabled=!0,Xr.disabled=!1},Ai=async()=>{const s=await K.emitWithAck("consume-media",{rtpCapabilities:ee.rtpCapabilities});if(s==="noProducer")console.log("There is no producer set up to consume");else if(s==="cannotConsume")console.log("rtpCapabilities failed. Cannot consume");else{Ar=await nt.consume(s);const{track:e}=Ar;console.log(e),e.addEventListener("ended",()=>{console.log("Track has ended")}),e.onmute=t=>{console.log("Track has muted")},e.onunmute=t=>{console.log("Track has unmuted")},Pi.srcObject=new MediaStream([e]),console.log("Track is ready... we need to unpause"),await K.emitWithAck("unpauseConsumer")}},Ni=async()=>{await K.emitWithAck("close-all")==="closeError"&&console.log("Something happened on the server..."),Ne?.close(),nt?.close()};function Fi(){K.on("connect",()=>{it.innerHTML="Connected",Nt.disabled=!1})}it.addEventListener("click",Di);Nt.addEventListener("click",Li);Ft.addEventListener("click",Ii);Pt.addEventListener("click",Mi);pt.addEventListener("click",Oi);Xr.addEventListener("click",Ai);Zr.addEventListener("click",Ni);
